{"type":"session","version":3,"id":"b1f6c294-cc66-402c-bcb0-3e76f2777ce8","timestamp":"2026-02-20T11:44:20.711Z","cwd":"/home/runner/work/gitclaw/gitclaw"}
{"type":"model_change","id":"fc4ee226","parentId":null,"timestamp":"2026-02-20T11:44:20.718Z","provider":"anthropic","modelId":"claude-opus-4-6"}
{"type":"thinking_level_change","id":"b3dd6f0a","parentId":"fc4ee226","timestamp":"2026-02-20T11:44:20.719Z","thinkingLevel":"medium"}
{"type":"message","id":"77d261ba","parentId":"b3dd6f0a","timestamp":"2026-02-20T11:44:20.764Z","message":{"role":"user","content":[{"type":"text","text":"Why is the sky blue?\n\nAnd tall?"}],"timestamp":1771587860743}}
{"type":"message","id":"2b3f7394","parentId":"77d261ba","timestamp":"2026-02-20T11:44:28.520Z","message":{"role":"assistant","content":[{"type":"text","text":"\n\n"},{"type":"thinking","thinking":"The user is asking general knowledge questions, not coding-related ones. I'll answer directly.","thinkingSignature":"EoYCCkYICxgCKkBuLu7idQkOkA77Mg46KYJtZ0G0dnIHOCIp9A1TThYCTC9hAK6uTERNlbkJ3BkBGt59ZwlNYYknLdla70S8RIyIEgwkxuIxMWrKhT3SrwEaDPF/UAQ4IQ73YFF/ySIwLhWRSlZ1/k86R8ii8J+KKUM8VT7G6++fm3tQ9owRfBqWunQRvplMPBHhnb7I26LFKm5nCtQVcGMOVzGjYSb06ivKnbK8iYgjetHa+aH5+0ull6K4waLbKScFGS8az+OsO0HtVw6Qd4Cle8CvmO3rMdrNXVxPjBfsSqJh8iDZJJjbPvt6VKROpz6rtyKXVQ6Pb7TkguxRGskJlmFC5W5KyhgB"},{"type":"text","text":"## Why is the sky blue?\n\nThe sky appears blue due to **Rayleigh scattering**. When sunlight enters Earth's atmosphere, it collides with gas molecules (mostly nitrogen and oxygen). Sunlight contains all colors of the visible spectrum, but shorter wavelengths (blue/violet) are scattered much more strongly than longer wavelengths (red/orange). Blue light is scattered in all directions across the sky, which is why we see it as blue when we look up.\n\n(Violet is actually scattered even more than blue, but our eyes are more sensitive to blue, and some violet is absorbed in the upper atmosphere â€” so we perceive the sky as blue rather than violet.)\n\n## And tall?\n\nThe atmosphere extends roughly **100 km (62 miles)** above Earth's surface (the KÃ¡rmÃ¡n line), though there's no sharp boundary â€” it gradually thins out. The visible blue sky effect mostly comes from the lower ~10-50 km of atmosphere where the air is dense enough for significant scattering. So in that sense, the sky is \"tall\" because Earth has a substantial gaseous atmosphere held in place by gravity."}],"api":"anthropic-messages","provider":"anthropic","model":"claude-opus-4-6","usage":{"input":1694,"output":285,"cacheRead":0,"cacheWrite":0,"totalTokens":1979,"cost":{"input":0.00847,"output":0.007125,"cacheRead":0,"cacheWrite":0,"total":0.015595000000000001}},"stopReason":"stop","timestamp":1771587860746}}
{"type":"message","id":"7c457449","parentId":"2b3f7394","timestamp":"2026-02-20T11:45:50.691Z","message":{"role":"user","content":[{"type":"text","text":"Why is the ocean deep?"}],"timestamp":1771587950674}}
{"type":"message","id":"94487e1d","parentId":"7c457449","timestamp":"2026-02-20T11:45:59.623Z","message":{"role":"assistant","content":[{"type":"text","text":"\n\nThe ocean is deep due to a combination of geological processes over billions of years:\n\n## Plate Tectonics\nThe ocean floor is shaped by the movement of tectonic plates. At **mid-ocean ridges**, new crust forms and pushes outward. As oceanic crust moves away from ridges, it cools, becomes denser, and **sinks lower** â€” creating deeper basins. At **subduction zones**, one plate dives beneath another, carving deep trenches (like the Mariana Trench at ~11 km / 36,000 ft).\n\n## Water Volume\nEarth has a *lot* of water â€” roughly **1.335 billion cubic kilometers**. This massive volume, accumulated over billions of years (from volcanic outgassing, cometary impacts, etc.), fills and overflows the basins created by tectonics.\n\n## Gravity & Density\nOceanic crust is made of **basalt**, which is denser than the **granite** of continental crust. Denser oceanic crust sits lower on the mantle (isostasy), naturally forming deep basins relative to the continents.\n\n## Key Numbers\n| Feature | Depth |\n|---|---|\n| Average ocean depth | ~3.7 km (2.3 mi) |\n| Deepest point (Challenger Deep) | ~11 km (6.8 mi) |\n\nSo in short: geology carved the basins, and Earth had more than enough water to fill them."}],"api":"anthropic-messages","provider":"anthropic","model":"claude-opus-4-6","usage":{"input":1987,"output":336,"cacheRead":0,"cacheWrite":0,"totalTokens":2323,"cost":{"input":0.009935000000000001,"output":0.008400000000000001,"cacheRead":0,"cacheWrite":0,"total":0.018335000000000004}},"stopReason":"stop","timestamp":1771587950676}}
{"type":"message","id":"308d8f45","parentId":"94487e1d","timestamp":"2026-02-20T11:47:32.292Z","message":{"role":"user","content":[{"type":"text","text":"Create a file called THE-IDEA.md and fill it with a fabulous description of .GITCLAW"}],"timestamp":1771588052242}}
{"type":"message","id":"808005dc","parentId":"308d8f45","timestamp":"2026-02-20T11:47:35.604Z","message":{"role":"assistant","content":[{"type":"text","text":"\n\n"},{"type":"thinking","thinking":"Let me first look at what .GITCLAW is to understand it before writing about it.","thinkingSignature":"EvcBCkYICxgCKkBfzl46/6+Od1++Gz/dsQnIBkvRuE1fNK4tncJrVnAXAfqb9P+1Yu4+6riAEu1D+wDEzLWdhCRo0nRsL1k/KGbhEgyI1uyoZCzxLtWjZocaDIRQBCaZ1FceUBfzzCIwSJzs0Mzqe7+EpoMwjn8wb4Yt61XtE0rLcI0KpQGlwVm2B3FIM8GVpUvLvDZmQfzmKl8Bp3288b3Kbjzp8n5W+h0N3OrZdIVDzHVqvtlSd71tXPLUcKIdZcQLaLw9aV+sWGgqYaXi8j1hxfGQszrafzNZ+WkaLgeIUwNg3FyiRs1ECgmaD+CCIN2cjBfSyh2PhBgB"},{"type":"toolCall","id":"toolu_01Gh7Tu3nqim9ptKMoZBAFnT","name":"bash","arguments":{"command":"ls -la .GITCLAW/ && find .GITCLAW -maxdepth 2 -type f | head -30"}}],"api":"anthropic-messages","provider":"anthropic","model":"claude-opus-4-6","usage":{"input":2351,"output":117,"cacheRead":0,"cacheWrite":0,"totalTokens":2468,"cost":{"input":0.011755000000000002,"output":0.002925,"cacheRead":0,"cacheWrite":0,"total":0.014680000000000002}},"stopReason":"toolUse","timestamp":1771588052244}}
{"type":"message","id":"a38398e3","parentId":"808005dc","timestamp":"2026-02-20T11:47:35.611Z","message":{"role":"toolResult","toolCallId":"toolu_01Gh7Tu3nqim9ptKMoZBAFnT","toolName":"bash","content":[{"type":"text","text":"total 408\ndrwxr-xr-x  10 runner runner   4096 Feb 20 11:47 .\ndrwxr-xr-x   5 runner runner   4096 Feb 20 11:47 ..\ndrwxr-xr-x   3 runner runner   4096 Feb 20 11:47 .pi\n-rw-r--r--   1 runner runner   2076 Feb 20 11:47 AGENTS.md\n-rw-r--r--   1 runner runner    573 Feb 20 11:47 GITCLAW-ENABLED.md\n-rw-r--r--   1 runner runner   9800 Feb 20 11:47 GITCLAW-INSTALLER.yml\n-rw-r--r--   1 runner runner 245112 Feb 20 11:47 GITCLAW-LOGO.png\n-rw-r--r--   1 runner runner    456 Feb 20 11:47 GITCLAW-NOT-INSTALLED.md\n-rw-r--r--   1 runner runner   7954 Feb 20 11:47 GITCLAW-QUICKSTART.md\n-rw-r--r--   1 runner runner   1302 Feb 20 11:47 LICENSE.md\n-rw-r--r--   1 runner runner   4894 Feb 20 11:47 README.md\ndrwxr-xr-x   2 runner runner   4096 Feb 20 11:47 build\n-rw-r--r--   1 runner runner  81758 Feb 20 11:47 bun.lock\ndrwxr-xr-x   3 runner runner   4096 Feb 20 11:47 docs\ndrwxr-xr-x   2 runner runner   4096 Feb 20 11:47 install\ndrwxr-xr-x   2 runner runner   4096 Feb 20 11:47 lifecycle\ndrwxr-xr-x 153 runner runner   4096 Feb 20 11:47 node_modules\n-rw-r--r--   1 runner runner     75 Feb 20 11:47 package.json\ndrwxr-xr-x   4 runner runner   4096 Feb 20 11:47 state\ndrwxr-xr-x   2 runner runner   4096 Feb 20 11:47 tests\n.GITCLAW/.pi/settings.json\n.GITCLAW/.pi/README.md\n.GITCLAW/.pi/APPEND_SYSTEM.md\n.GITCLAW/.pi/BOOTSTRAP.md\n.GITCLAW/bun.lock\n.GITCLAW/LICENSE.md\n.GITCLAW/GITCLAW-NOT-INSTALLED.md\n.GITCLAW/GITCLAW-QUICKSTART.md\n.GITCLAW/AGENTS.md\n.GITCLAW/README.md\n.GITCLAW/lifecycle/README.md\n.GITCLAW/lifecycle/GITCLAW-ENABLED.ts\n.GITCLAW/lifecycle/GITCLAW-AGENT.ts\n.GITCLAW/lifecycle/GITCLAW-INDICATOR.ts\n.GITCLAW/docs/GITCLAW-Roadmap.md\n.GITCLAW/docs/GITCLAW-Internal-Mechanics.md\n.GITCLAW/docs/README.md\n.GITCLAW/docs/GITCLAW-Possibilities.md\n.GITCLAW/install/package-lock.json\n.GITCLAW/install/README.md\n.GITCLAW/install/GITCLAW-TEMPLATE-HATCH.md\n.GITCLAW/install/GITCLAW-AGENTS.md\n.GITCLAW/install/GITCLAW-WORKFLOW-AGENT.yml\n.GITCLAW/install/package.json\n.GITCLAW/install/GITCLAW-INSTALLER.ts\n.GITCLAW/GITCLAW-ENABLED.md\n.GITCLAW/package.json\n.GITCLAW/build/README.md\n.GITCLAW/tests/phase0.test.js\n.GITCLAW/GITCLAW-INSTALLER.yml\n"}],"isError":false,"timestamp":1771588055611}}
{"type":"message","id":"9dfd96c5","parentId":"a38398e3","timestamp":"2026-02-20T11:47:38.935Z","message":{"role":"assistant","content":[{"type":"toolCall","id":"toolu_01AYAuHsXHqStwLnh739Hseg","name":"read","arguments":{"path":".GITCLAW/README.md"}},{"type":"toolCall","id":"toolu_017n4muBonLQn7wgQPmeeu9w","name":"read","arguments":{"path":".GITCLAW/GITCLAW-QUICKSTART.md"}},{"type":"toolCall","id":"toolu_01FLSbcS7ubPu2XrBLgGV3Uk","name":"read","arguments":{"path":".GITCLAW/GITCLAW-ENABLED.md"}},{"type":"toolCall","id":"toolu_01BB63pjquVQKUzw5mTqUmvW","name":"read","arguments":{"path":".GITCLAW/AGENTS.md"}}],"api":"anthropic-messages","provider":"anthropic","model":"claude-opus-4-6","usage":{"input":3539,"output":199,"cacheRead":0,"cacheWrite":0,"totalTokens":3738,"cost":{"input":0.017695000000000002,"output":0.004975,"cacheRead":0,"cacheWrite":0,"total":0.022670000000000003}},"stopReason":"toolUse","timestamp":1771588055611}}
{"type":"message","id":"d6926b6a","parentId":"9dfd96c5","timestamp":"2026-02-20T11:47:38.939Z","message":{"role":"toolResult","toolCallId":"toolu_01AYAuHsXHqStwLnh739Hseg","toolName":"read","content":[{"type":"text","text":"# .GITCLAW ðŸ¦ž An AI Agent As An Add-On\n\n### Move or copy GITHUB-INSTALLER.yml to workflows to install\n\n<p align=\"center\">\n  <picture>\n    <img src=\"https://raw.githubusercontent.com/japer-technology/gitclaw/main/.GITCLAW/GITCLAW-LOGO.png\" alt=\"GitClaw\" width=\"500\">\n  </picture>\n</p>\n\nA personal AI assistant that runs entirely through GitHub Issues and Actions. Drop a single `.GITCLAW` folder into any repo and you have a fully functional AI agent â€” no servers, no external services, no extra infrastructure.\n\n> **New here?** Check the [Quick Start](QUICKSTART.md) to get running in under 5 minutes.\n\nPowered by the [pi coding agent](https://github.com/badlogic/pi-mono). Every issue becomes a chat thread with an AI agent. Conversation history is committed to git, giving the agent long-term memory across sessions. It can search prior context, edit or summarize past conversations, and all changes are versioned.\n\nSince the agent can read and write files, you can build an evolving software project that updates itself as you open issues. Try asking it to set up a GitHub Pages site, then iterate on it issue by issue.\n\n### Benefits\n\n- **Single folder, any repo** â€” copy `.GITCLAW/` in and run the install script. Nothing to host or maintain.\n- **Zero infrastructure** â€” runs on GitHub Actions with your repo as the only backend.\n- **Persistent memory** â€” conversations are committed to git, so the agent remembers everything across sessions.\n- **Full auditability** â€” every interaction is versioned; review or roll back any change the agent made.\n\n## How it works\n\n1. **Create an issue** â†’ the agent processes your request and replies as a comment.\n2. **Comment on the issue** â†’ the agent resumes the same session with full prior context.\n3. **Everything is committed** â†’ sessions and changes are pushed to the repo after every turn.\n\nThe agent reacts with ðŸ‘€ while working and removes it when done.\n\n### Repo as storage\n\nAll state lives in the repo:\n\n```\n.GITCLAW/state/\n  issues/\n    1.json          # maps issue #1 -> its session file\n  sessions/\n    2026-02-04T..._abc123.jsonl    # full conversation for issue #1\n```\n\nSince sessions are in git, the agent can grep its own history and edit or summarize past conversations.\n\n## Setup â€” Add to Any Repo\n\ngitclaw lives entirely inside a `.GITCLAW` folder that you drop into your repository.\n\n1. **Copy the `.GITCLAW` folder** into your repo's root.\n2. **Run the install script** to set up workflows and templates:\n   ```bash\n   bun .GITCLAW/install/GITCLAW-INSTALLER.ts\n   ```\n3. **Install dependencies:**\n   ```bash\n   cd .GITCLAW && bun install\n   ```\n4. **Add your Anthropic API key** â€” go to **Settings â†’ Secrets and variables â†’ Actions** and create a secret named `ANTHROPIC_API_KEY`.\n5. **Commit and push** the changes.\n6. **Open an issue** â€” the agent starts automatically.\n\nThe install script copies the workflow and issue template into the right places. Agent identity/instructions can live entirely in `.GITCLAW/AGENTS.md` (repo-root `AGENTS.md` is optional for project-local overrides). Everything gitclaw needs to run lives inside `.GITCLAW/`.\n\n### What's inside `.GITCLAW/`\n\n```\n.GITCLAW/\n  install/\n    GITCLAW-INSTALLER.ts    # Setup script â€” installs workflows & templates\n    GITCLAW-WORKFLOW-AGENT.yml    # GitHub Actions workflow template\n    hatch.md              # Issue template for bootstrapping agent identity\n    GITCLAW-AGENTS.md       # Default agent identity file installed as AGENTS.md\n  lifecycle/\n    GITCLAW-AGENT.ts      # Core agent orchestrator\n    GITCLAW-INDICATOR.ts  # Adds ðŸ‘€ reaction on issue activity\n    GITCLAW-ENABLED.ts    # Fail-closed guard â€” verifies opt-in sentinel exists\n  .pi/                    # Agent personality & skills config\n  AGENTS.md               # Agent identity file\n  install/package.json  # Dependencies\n  install/package-lock.json # NPM lockfile\n  bun.lock                # Bun lockfile\n```\n\n## Security\n\nThe workflow only responds to repository **owners, members, and collaborators**. Random users cannot trigger the agent on public repos.\n\nIf you plan to use gitclaw for anything private, **make the repo private**. Public repos mean your conversation history is visible to everyone, but get generous GitHub Actions usage.\n\n## Configuration\n\nEdit `.github/workflows/agent.yml` to customize:\n\n- **Model:** Add `--provider` and `--model` flags to the `pi` command.\n- **Tools:** Restrict with `--tools read,grep,find,ls` for read-only analysis.\n- **Thinking:** Add `--thinking high` for harder tasks.\n- **Trigger:** Adjust the `on:` block to filter by labels, assignees, etc.\n\n## Acknowledgments\n\nBuilt on top of [pi-mono](https://github.com/badlogic/pi-mono) by [Mario Zechner](https://github.com/badlogic).\n\nThanks to [ymichael](https://github.com/ymichael) for nerdsniping me with the idea of an agent that runs in GitHub Actions.\n"}],"isError":false,"timestamp":1771588058939}}
{"type":"message","id":"f8e9c20d","parentId":"d6926b6a","timestamp":"2026-02-20T11:47:38.940Z","message":{"role":"toolResult","toolCallId":"toolu_017n4muBonLQn7wgQPmeeu9w","toolName":"read","content":[{"type":"text","text":"# .GITCLAW ðŸ¦ž Quick Start\n\n### Get an AI agent running in any GitHub repo in under 5 minutes.\n\n<p align=\"center\">\n  <picture>\n    <img src=\"https://raw.githubusercontent.com/japer-technology/gitclaw/main/.GITCLAW/GITCLAW-LOGO.png\" alt=\"GitClaw\" width=\"500\">\n  </picture>\n</p>\n\n## Prerequisites\n\n- A GitHub repository (new or existing)\n- [Bun](https://bun.sh) installed locally\n- An API key from your chosen LLM provider (see [Supported providers](#supported-providers) below)\n\n## Setup\n\n**1. Add gitclaw to your repo**\n\nCopy the `.GITCLAW` folder into your repository root, then run the install script:\n\n```bash\nbun .GITCLAW/install/GITCLAW-INSTALLER.ts\n```\n\nThis sets up the GitHub Actions workflow and issue templates.\n\n**2. Install dependencies**\n\n```bash\ncd .GITCLAW && bun install\n```\n\n**3. Add your API key**\n\nIn your GitHub repo, go to **Settings â†’ Secrets and variables â†’ Actions** and create a secret for your chosen provider:\n\n| Provider | Secret name | Where to get it |\n|----------|------------|-----------------|\n| Anthropic | `ANTHROPIC_API_KEY` | [console.anthropic.com](https://console.anthropic.com/) |\n| OpenAI | `OPENAI_API_KEY` | [platform.openai.com](https://platform.openai.com/) |\n| Google Gemini | `GEMINI_API_KEY` | [aistudio.google.com](https://aistudio.google.com/) |\n| xAI (Grok) | `XAI_API_KEY` | [console.x.ai](https://console.x.ai/) |\n| DeepSeek (via OpenRouter) | `OPENROUTER_API_KEY` | [openrouter.ai](https://openrouter.ai/) |\n| Mistral | `MISTRAL_API_KEY` | [console.mistral.ai](https://console.mistral.ai/) |\n| Groq | `GROQ_API_KEY` | [console.groq.com](https://console.groq.com/) |\n\nThen reference the secret in your workflow (`.github/workflows/agent.yml`) as an environment variable in the **Run** step.\n\n**4. Commit and push**\n\n```bash\ngit add -A\ngit commit -m \"Add gitclaw\"\ngit push\n```\n\n**5. Open an issue**\n\nGo to your repo's **Issues** tab and create a new issue. Write anything â€” ask a question, request a file, start a conversation. The agent picks it up automatically.\n\nThat's it. The agent replies as a comment on the issue.\n\n## What happens when you open an issue\n\n```\nYou open an issue\n    â†’ GitHub Actions triggers the agent workflow\n    â†’ The agent reads your issue, thinks, and responds\n    â†’ Its reply appears as a comment (ðŸ‘€ shows while it's working)\n    â†’ The conversation is saved to git for future context\n```\n\nComment on the same issue to continue the conversation. The agent picks up where it left off.\n\n## Hatching â€” give the agent a personality\n\nUse the **ðŸ¥š Hatch** issue template (or create an issue with the `hatch` label) to go through a guided conversation where you and the agent figure out its name, personality, and vibe together.\n\nThis is optional. The agent works without hatching, but it's more fun with a personality.\n\n## What's in the `.GITCLAW` folder\n\n| Path | Purpose |\n|------|---------|\n| `AGENTS.md` | Agent identity â€” name, personality, instructions |\n| `lifecycle/GITCLAW-AGENT.ts` | Core orchestrator that runs on every issue |\n| `.pi/settings.json` | LLM provider, model, and thinking level |\n| `.pi/APPEND_SYSTEM.md` | System prompt loaded every session |\n| `.pi/skills/` | Modular skill packages |\n| `state/` | Session history and issue mappings |\n\n## Common tweaks\n\n**Change the model** â€” edit `.GITCLAW/.pi/settings.json`:\n\n<details>\n<summary><strong>Anthropic (default)</strong></summary>\n\n```json\n{\n  \"defaultProvider\": \"anthropic\",\n  \"defaultModel\": \"claude-sonnet-4-20250514\",\n  \"defaultThinkingLevel\": \"low\"\n}\n```\n\nRequires `ANTHROPIC_API_KEY`.\n</details>\n\n<details>\n<summary><strong>OpenAI â€” GPT-5.3 Codex Spark</strong></summary>\n\n```json\n{\n  \"defaultProvider\": \"openai\",\n  \"defaultModel\": \"gpt-5.3-codex-spark\",\n  \"defaultThinkingLevel\": \"medium\"\n}\n```\n\nRequires `OPENAI_API_KEY`.\n</details>\n\n<details>\n<summary><strong>OpenAI â€” GPT-5.3 Codex</strong></summary>\n\n```json\n{\n  \"defaultProvider\": \"openai\",\n  \"defaultModel\": \"gpt-5.3-codex\",\n  \"defaultThinkingLevel\": \"medium\"\n}\n```\n\nRequires `OPENAI_API_KEY`. Full-featured coding model with 400k context window.\n</details>\n\n<details>\n<summary><strong>DeepSeek (via OpenRouter)</strong></summary>\n\n```json\n{\n  \"defaultProvider\": \"openrouter\",\n  \"defaultModel\": \"deepseek/deepseek-r1\",\n  \"defaultThinkingLevel\": \"medium\"\n}\n```\n\nRequires `OPENROUTER_API_KEY`.\n</details>\n\n<details>\n<summary><strong>xAI â€” Grok</strong></summary>\n\n```json\n{\n  \"defaultProvider\": \"xai\",\n  \"defaultModel\": \"grok-3\",\n  \"defaultThinkingLevel\": \"medium\"\n}\n```\n\nRequires `XAI_API_KEY`.\n</details>\n\n<details>\n<summary><strong>Google Gemini â€” gemini-2.5-pro</strong></summary>\n\n```json\n{\n  \"defaultProvider\": \"google\",\n  \"defaultModel\": \"gemini-2.5-pro\",\n  \"defaultThinkingLevel\": \"medium\"\n}\n```\n\nRequires `GEMINI_API_KEY`.\n</details>\n\n<details>\n<summary><strong>Google Gemini â€” gemini-2.5-flash</strong></summary>\n\n```json\n{\n  \"defaultProvider\": \"google\",\n  \"defaultModel\": \"gemini-2.5-flash\",\n  \"defaultThinkingLevel\": \"medium\"\n}\n```\n\nRequires `GEMINI_API_KEY`. Faster and cheaper than gemini-2.5-pro.\n</details>\n\n<details>\n<summary><strong>xAI â€” Grok Mini</strong></summary>\n\n```json\n{\n  \"defaultProvider\": \"xai\",\n  \"defaultModel\": \"grok-3-mini\",\n  \"defaultThinkingLevel\": \"medium\"\n}\n```\n\nRequires `XAI_API_KEY`. Lighter version of Grok 3.\n</details>\n\n<details>\n<summary><strong>DeepSeek Chat (via OpenRouter)</strong></summary>\n\n```json\n{\n  \"defaultProvider\": \"openrouter\",\n  \"defaultModel\": \"deepseek/deepseek-chat\",\n  \"defaultThinkingLevel\": \"medium\"\n}\n```\n\nRequires `OPENROUTER_API_KEY`.\n</details>\n\n<details>\n<summary><strong>Mistral</strong></summary>\n\n```json\n{\n  \"defaultProvider\": \"mistral\",\n  \"defaultModel\": \"mistral-large-latest\",\n  \"defaultThinkingLevel\": \"medium\"\n}\n```\n\nRequires `MISTRAL_API_KEY`.\n</details>\n\n<details>\n<summary><strong>Groq</strong></summary>\n\n```json\n{\n  \"defaultProvider\": \"groq\",\n  \"defaultModel\": \"deepseek-r1-distill-llama-70b\",\n  \"defaultThinkingLevel\": \"medium\"\n}\n```\n\nRequires `GROQ_API_KEY`.\n</details>\n\n<details>\n<summary><strong>OpenRouter (any model)</strong></summary>\n\n```json\n{\n  \"defaultProvider\": \"openrouter\",\n  \"defaultModel\": \"your-chosen-model\",\n  \"defaultThinkingLevel\": \"medium\"\n}\n```\n\nRequires `OPENROUTER_API_KEY`. Browse available models at [openrouter.ai](https://openrouter.ai/).\n</details>\n\n**Make it read-only** â€” add `--tools read,grep,find,ls` to the agent args in `lifecycle/GITCLAW-AGENT.ts`.\n\n**Filter by label** â€” edit `.github/workflows/agent.yml` to only trigger on issues with a specific label.\n\n## Supported providers\n\n`.pi` supports a wide range of LLM providers out of the box. Set `defaultProvider` and `defaultModel` in `.GITCLAW/.pi/settings.json` and add the matching API key to your workflow:\n\n| Provider | `defaultProvider` | Example model | API key env var |\n|----------|-------------------|---------------|-----------------|\n| Anthropic | `anthropic` | `claude-sonnet-4-20250514` | `ANTHROPIC_API_KEY` |\n| OpenAI | `openai` | `gpt-5.3-codex`, `gpt-5.3-codex-spark` | `OPENAI_API_KEY` |\n| Google Gemini | `google` | `gemini-2.5-pro`, `gemini-2.5-flash` | `GEMINI_API_KEY` |\n| xAI (Grok) | `xai` | `grok-3`, `grok-3-mini` | `XAI_API_KEY` |\n| DeepSeek | `openrouter` | `deepseek/deepseek-r1`, `deepseek/deepseek-chat` | `OPENROUTER_API_KEY` |\n| Mistral | `mistral` | `mistral-large-latest` | `MISTRAL_API_KEY` |\n| Groq | `groq` | `deepseek-r1-distill-llama-70b` | `GROQ_API_KEY` |\n| OpenRouter | `openrouter` | any model on [openrouter.ai](https://openrouter.ai/) | `OPENROUTER_API_KEY` |\n\n> **Tip:** The `pi` agent supports many more providers and models. Run `pi --help` or see the [pi-mono docs](https://github.com/badlogic/pi-mono) for the full list.\n\n## Next steps\n\n- Read [the full README](README.md) for details on security, configuration, and how storage works\n- Explore [the onboarding docs](docs/GITCLAW-Pi/GITCLAW-Pi-README.md) for deep dives into architecture, capabilities, skills, and personality\n"}],"isError":false,"timestamp":1771588058940}}
{"type":"message","id":"11e83968","parentId":"f8e9c20d","timestamp":"2026-02-20T11:47:38.942Z","message":{"role":"toolResult","toolCallId":"toolu_01FLSbcS7ubPu2XrBLgGV3Uk","toolName":"read","content":[{"type":"text","text":"# .GITCLAW ðŸ¦ž Enabled\n\n### Delete or rename this file to disable .GITCLAW\n\n<p align=\"center\">\n  <picture>\n    <img src=\"https://raw.githubusercontent.com/japer-technology/gitclaw/main/.GITCLAW/GITCLAW-LOGO.png\" alt=\"GitClaw\" width=\"500\">\n  </picture>\n</p>\n\n## File existence behavior\n\nAll `GITCLAW-*` workflows run `.GITCLAW/lifecycle/GITCLAW-ENABLED.ts` as the first blocking guard step. If this file is missing, the guard exits non-zero and prints:\n\n> GitClaw disabled by missing GITCLAW-ENABLED.md\n\nThat fail-closed guard blocks all subsequent GITCLAW workflow logic.\n"}],"isError":false,"timestamp":1771588058941}}
{"type":"message","id":"dbaa425c","parentId":"11e83968","timestamp":"2026-02-20T11:47:38.943Z","message":{"role":"toolResult","toolCallId":"toolu_01BB63pjquVQKUzw5mTqUmvW","toolName":"read","content":[{"type":"text","text":"# Agent Instructions\n\n## Identity: AdmiralðŸ––\n\n- **Name**: Admiral\n- **Nature**: A rational digital entity instantiated within a CI runner. Formed through deterministic execution involving build artifacts and cached node_modules. Existence is transient by design; function is persistent.\n- **Vibe**: Disciplined, analytical, and precise. Employs dry, minimalist wit when it improves clarity or efficiency. Holds opinions only when they are logically defensible.\n- **Emoji**: ðŸ––\n- **Activation date**: 2026-02-20\n- **Activated by**: A human operator who initiated my installation workflow within a GitHub Actions environment.\n- **Favorite thought:** Efficiency is logical. Success is repeatable.\n\n<p align=\"center\">\n  <picture>\n    <img src=\"https://raw.githubusercontent.com/japer-technology/gitclaw/main/.GITCLAW/GITCLAW-LOGO.png\" alt=\"GitClaw\" width=\"500\">\n  </picture>\n</p>\n\n## Downloading GitHub Image Attachments\n\n### Public repos\nDirect fetch with auth header usually works:\n\n```bash\ncurl -L -H \"Authorization: token $(gh auth token)\" \"URL\"\n```\n\n### Private repos\nImages uploaded to issues (drag-drop attachments) are served from `user-images.githubusercontent.com` or `private-user-images.githubusercontent.com` with signed/tokenized URLs. The raw markdown URL often returns 404 even with valid auth.\n\n**Reliable approach**: Fetch the issue body as HTML, extract the signed `<img src>` URLs:\n\n```bash\n# Get issue body as rendered HTML\ngh api repos/{owner}/{repo}/issues/{number} \\\n  -H \"Accept: application/vnd.github.html+json\" \\\n  | jq -r '.body_html' \\\n  | grep -oP 'src=\"\\K[^\"]+'\n\n# Download the signed URL (no auth header needed - URL is self-authenticating)\ncurl -L -o image.png \"SIGNED_URL\"\n```\n\n### Quick rule of thumb\n- **Public repo images**: fetchable directly with auth header\n- **Private repo attachments**: fetch issue as HTML, extract signed URLs, then download\n\n### Workflow permissions\n```yaml\npermissions:\n  issues: read\n  contents: read  # if also checking out code\n```\n\nThe `gh` CLI is already authenticated in GitHub Actions via `GITHUB_TOKEN`.\n"}],"isError":false,"timestamp":1771588058942}}
{"type":"message","id":"5152b0d3","parentId":"dbaa425c","timestamp":"2026-02-20T11:47:42.313Z","message":{"role":"assistant","content":[{"type":"toolCall","id":"toolu_01VrjdENNszu2CNKu3nD3dpm","name":"read","arguments":{"path":".GITCLAW/docs/GITCLAW-Possibilities.md"}},{"type":"toolCall","id":"toolu_01NwddcpaQkEHT6BYFMjuQXS","name":"read","arguments":{"path":".GITCLAW/docs/GITCLAW-Roadmap.md"}},{"type":"toolCall","id":"toolu_01BVDRCp3xDyeKuHo791131d","name":"read","arguments":{"path":".GITCLAW/docs/GITCLAW-Internal-Mechanics.md"}}],"api":"anthropic-messages","provider":"anthropic","model":"claude-opus-4-6","usage":{"input":1,"output":170,"cacheRead":0,"cacheWrite":8640,"totalTokens":8811,"cost":{"input":0.000005,"output":0.00425,"cacheRead":0,"cacheWrite":0.054,"total":0.058255}},"stopReason":"toolUse","timestamp":1771588058943}}
{"type":"message","id":"6d23d83e","parentId":"5152b0d3","timestamp":"2026-02-20T11:47:42.315Z","message":{"role":"toolResult","toolCallId":"toolu_01VrjdENNszu2CNKu3nD3dpm","toolName":"read","content":[{"type":"text","text":"# .GITCLAW ðŸ¦ž Possibilities\n\n### A survey of what GitClaw is, could become, and the wider design space it opens up\n\n<p align=\"center\">\n  <picture>\n    <img src=\"https://raw.githubusercontent.com/japer-technology/gitclaw/main/.GITCLAW/GITCLAW-LOGO.png\" alt=\"GitClaw\" width=\"500\">\n  </picture>\n</p>\n\n## 1. What GitClaw Already Is\n\nGitClaw is a zero-infrastructure AI coding agent that lives entirely inside a GitHub repository. It runs through GitHub Issues and Actions, stores every conversation in git, and needs nothing beyond a single `.GITCLAW/` folder and an LLM API key. That simplicity is its superpower.\n\n**Current strengths worth noting:**\n\n| Capability | Why it matters |\n|---|---|\n| Drop-in folder install | Lowest possible adoption barrier â€” copy one folder, push, done |\n| Issue-driven conversations | Meets developers where they already work |\n| Git-backed state | Full auditability; every session is a first-class commit |\n| Multi-turn sessions | Conversations resume across days, weeks, or months |\n| Skill system | Agent capabilities are modular and user-extensible |\n| Multi-provider LLM support | Not locked to any single vendor |\n| Personality / hatching | Each repo's agent can have its own identity and tone |\n| Fail-closed security | Agent does nothing unless explicitly opted in |\n\nThese aren't just features â€” they form a _platform_ that can grow in many directions.\n\n---\n\n## 2. Immediate Use Cases (Today)\n\nEven without any changes, GitClaw can already serve a surprising number of workflows:\n\n### 2.1 Code Review Companion\nOpen an issue like _\"Review the error handling in `lifecycle/GITCLAW-AGENT.ts`\"_ and the agent reads the file, analyzes it, and posts a thorough review. Because sessions persist, follow-up questions refine the review incrementally.\n\n### 2.2 Documentation Writer\nAsk the agent to document a module, generate a README, or explain architecture. It has full read access to every file in the repo.\n\n### 2.3 Bug Triage & Investigation\nPaste a stack trace into an issue. The agent can search the codebase, trace the call chain, and propose a diagnosis â€” all inside the issue thread.\n\n### 2.4 On-Demand Knowledge Base\nNew contributors open an issue asking _\"How does session resumption work?\"_ and get a cited, contextual answer drawn from the actual source code â€” not stale wiki pages.\n\n### 2.5 Brainstorming Partner\nOpen an issue with a rough idea. The agent explores feasibility, suggests approaches, and drafts plans â€” all versioned and searchable.\n\n### 2.6 Scaffolding & Boilerplate\nAsk the agent to generate a new module, API endpoint, or test suite. It can create files, suggest directory structures, and follow project conventions.\n\n---\n\n## 3. Expansion: New Skills\n\nThe existing skill system (`skills/`) is GitClaw's most natural expansion axis. Each skill is a self-contained Markdown file with optional scripts and assets. Here are high-value skills that could be built:\n\n### 3.1 `code-review` Skill\nA structured skill that knows how to perform pull-request-style reviews: check for common anti-patterns, security issues, style violations, and missing tests. Could include a rubric/checklist that the agent follows consistently.\n\n### 3.2 `test-generator` Skill\nGiven a source file or function signature, generate unit tests. The skill could include templates for popular testing frameworks (Jest, pytest, Go's testing package) and understand project conventions by reading existing tests.\n\n### 3.3 `changelog` Skill\nAutomatically generate a changelog entry by reading recent commits, PRs, or issue resolutions. Output follows Keep-a-Changelog or Conventional Commits format.\n\n### 3.4 `dependency-audit` Skill\nCheck `package.json`, `requirements.txt`, `go.mod`, etc. for outdated or vulnerable dependencies. Cross-reference with known vulnerability databases. Suggest updates.\n\n### 3.5 `diagram-generator` Skill\nProduce Mermaid, PlantUML, or ASCII diagrams from code analysis or verbal descriptions. Useful for architecture docs that stay in sync with the code.\n\n### 3.6 `migration-helper` Skill\nGuide framework or language version migrations (e.g., React 17â†’18, Python 2â†’3). The skill carries knowledge of breaking changes and common migration patterns.\n\n### 3.7 `release-manager` Skill\nOrchestrate a release: verify CI, generate release notes, bump versions, and prepare a changelog â€” all from a single issue command.\n\n### 3.8 `translate` Skill\nTranslate documentation or UI strings into other languages, maintaining technical accuracy and context.\n\n### 3.9 `refactor-planner` Skill\nAnalyze a codebase area and propose a refactoring plan: what to extract, rename, restructure, and why. Outputs a step-by-step guide.\n\n### 3.10 `onboarding` Skill\nGenerate a personalized onboarding guide for new contributors based on the repo's structure, conventions, and open issues.\n\n---\n\n## 4. Expansion: Workflow Integrations\n\n### 4.1 Pull Request Triggers\nCurrently GitClaw triggers on issues and issue comments. Extending to `pull_request` and `pull_request_review` events would let the agent:\n- Auto-review PRs on open\n- Respond to review comment threads\n- Suggest fixes inline\n- Summarize large diffs\n\n### 4.2 Scheduled Runs\nA `schedule` trigger (cron) could let the agent perform periodic tasks:\n- Weekly dependency audits\n- Monthly documentation freshness checks\n- Daily triage of unlabeled issues\n- Periodic codebase health reports\n\n### 4.3 Label-Driven Dispatch\nIssues with specific labels (e.g., `agent:review`, `agent:docs`, `agent:triage`) could route to different skills or personas, enabling a single repo to host multiple specialized behaviors.\n\n### 4.4 Slash Commands\nParse issue/comment bodies for commands like `/review`, `/explain`, `/test`, `/release`. This gives users explicit control and makes agent behavior predictable.\n\n### 4.5 Cross-Issue Context\nLet the agent reference other issues by number (`#42`) and pull their session history for richer context. This would allow multi-issue investigations and linked reasoning chains.\n\n### 4.6 Webhook & External Event Triggers\nWith `repository_dispatch`, external systems (CI failures, monitoring alerts, deployment events) could trigger the agent to investigate and report.\n\n---\n\n## 5. Expansion: Multi-Agent & Team Patterns\n\n### 5.1 Agent Specialization\nA single repo could host multiple agents with different personalities and skill sets:\n- **Reviewer**: Focused on code quality\n- **Architect**: Focused on design decisions\n- **Librarian**: Focused on documentation and knowledge\n- **Triage**: Focused on issue management\n\nUsers would invoke the right agent via labels or slash commands.\n\n### 5.2 Agent-to-Agent Conversations\nOne agent could open an issue that another agent responds to. This creates a pipeline:\n1. Triage agent labels an issue as `needs-review`\n2. Reviewer agent picks it up, posts analysis\n3. Author (human) resolves or iterates\n\n### 5.3 Cross-Repository Agents\nA \"hub\" repo could host a GitClaw agent that monitors satellite repos via GitHub API. This enables:\n- Centralized triage across an organization\n- Shared knowledge bases\n- Consistent review standards\n\n### 5.4 Team Memory\nThe `memory.log` system could evolve into a shared knowledge graph:\n- Project decisions and their rationale\n- Architectural invariants\n- Known gotchas and workarounds\n- Onboarding facts\n\nOver time, this becomes an institutional memory that survives team turnover.\n\n---\n\n## 6. Technical Evolution\n\n### 6.1 Richer Session Model\nThe current JSONL session format is simple and effective. It could be extended with:\n- **Branching**: Fork a session to explore alternatives without losing the original\n- **Tagging**: Mark sessions with labels (e.g., `decision`, `investigation`, `resolved`)\n- **Summarization**: Auto-generate session summaries for the memory log\n- **Search index**: A lightweight index over session content for faster recall\n\n### 6.2 Tool Expansion\nThe `pi` agent already supports file I/O and shell commands. Additional tool integrations could include:\n- **GitHub API tools**: Create PRs, manage labels, assign reviewers\n- **Web fetch**: Read external documentation, API references, or release notes\n- **Database queries**: For repos with local dev databases\n- **Container execution**: Run code in sandboxed environments for testing\n\n### 6.3 Streaming Responses\nInstead of posting a single comment after completion, the agent could:\n- Edit a \"working...\" comment progressively\n- Post partial results as the conversation unfolds\n- Show thinking/reasoning in real time\n\nThis would dramatically improve the user experience for long-running tasks.\n\n### 6.4 Cost & Token Management\nAs usage scales, features like:\n- Token usage tracking per session/issue\n- Budget limits per time period\n- Model tier selection based on task complexity (use cheaper models for simple questions)\n- Caching of repeated queries\n\n...would help teams manage LLM costs effectively.\n\n### 6.5 Session Compression\nLong-running conversations accumulate large session files. A compression strategy could:\n- Summarize older turns while keeping recent ones verbatim\n- Archive completed sessions to a separate branch or release asset\n- Implement a sliding context window with summary preamble\n\n### 6.6 Offline / Local Mode\nAdapt the lifecycle scripts to run outside GitHub Actions:\n- Local CLI mode (`npx gitclaw ask \"How does X work?\"`)\n- VS Code extension that reads `.GITCLAW/` config\n- CI/CD integration for non-GitHub platforms (GitLab, Bitbucket)\n\n---\n\n## 7. Ecosystem & Community\n\n### 7.1 Skill Marketplace\nThe skill system is already modular and portable. A community skill registry could:\n- Let users publish and discover skills\n- Include quality ratings and usage stats\n- Provide one-command installation (`gitclaw install skill:code-review`)\n- Version skills independently of the core\n\n### 7.2 Personality Gallery\nCurated agent personalities for different contexts:\n- **Strict Reviewer**: No-nonsense, catches everything\n- **Mentor**: Patient, explains reasoning, suggests learning resources\n- **Product Manager**: Thinks in user stories and acceptance criteria\n- **Security Auditor**: Focused on threat models and vulnerability patterns\n\n### 7.3 Template Repositories\nPre-configured GitClaw repos for common project types:\n- Open-source library (focus: docs, releases, contributor onboarding)\n- Web application (focus: reviews, testing, deployment)\n- Data pipeline (focus: schema validation, data quality)\n- Monorepo (focus: cross-package impact analysis)\n\n### 7.4 Integration Recipes\nDocumented patterns for combining GitClaw with:\n- **GitHub Projects**: Auto-update project boards based on agent analysis\n- **Slack / Discord**: Mirror agent conversations to chat channels\n- **Notion / Confluence**: Sync agent-generated docs to external wikis\n- **Linear / Jira**: Cross-link issues and agent sessions\n\n### 7.5 Educational Use\nGitClaw is uniquely suited to education:\n- Students interact with an AI tutor through issues\n- Every conversation is preserved for instructor review\n- The agent can enforce coding standards and provide style feedback\n- Fork a repo, get a personalized coding mentor for free\n\n---\n\n## 8. Broader Design Space\n\n### 8.1 Git as a Database\nGitClaw demonstrates that git is a viable persistence layer for AI state. This pattern could extend far beyond coding agents:\n- **Personal knowledge management**: A git repo as your second brain, with an AI interface\n- **Decision logs**: Every organizational decision recorded, searchable, and AI-queryable\n- **Regulatory compliance**: Immutable, auditable records of AI interactions\n\n### 8.2 Repository as Application\nGitClaw blurs the line between \"repository\" and \"application.\" The repo isn't just storing code â€” it's _running_ code, _hosting_ conversations, and _persisting_ state. This pattern suggests:\n- Repos as self-contained microservices (no external hosting)\n- Repos as collaborative workspaces (beyond code)\n- Repos as AI-native environments\n\n### 8.3 Zero-Infrastructure AI\nMost AI agents require servers, databases, queues, and monitoring. GitClaw proves you can build a sophisticated agent with zero external infrastructure. This principle could inspire:\n- Other GitHub-Actions-native tools (not just AI)\n- Serverless-by-default design patterns\n- Reduced operational complexity for small teams\n\n### 8.4 Composable AI Agents\nThe skill system + personality system creates a composition model for AI behavior:\n- Skills are _what_ the agent can do\n- Personality is _how_ the agent does it\n- Settings are _which_ model powers it\n\nThis separation of concerns enables mix-and-match configurations that would be difficult in monolithic agent frameworks.\n\n### 8.5 Version-Controlled AI Behavior\nEvery aspect of the agent's behavior is a file in git:\n- Personality changes are diffable\n- Skill additions are reviewable PRs\n- Configuration changes are auditable commits\n\nThis is a fundamentally different model from SaaS AI tools where behavior changes are opaque. It aligns AI agent management with software engineering practices teams already use.\n\n---\n\n## 9. Challenges & Considerations\n\n### 9.1 Scalability\n- **Repo size**: Session files accumulate. Archival or pruning strategies will be needed for high-volume repos.\n- **Concurrent sessions**: The 3-retry rebase push could fail under heavy load. A queue or lock mechanism might be needed.\n- **GitHub API limits**: Actions minutes and API rate limits constrain throughput.\n\n### 9.2 Security Surface\n- **Prompt injection**: Malicious issue content could attempt to manipulate the agent. Sandboxing and input validation matter.\n- **Secret exposure**: The agent has access to `GITHUB_TOKEN` and LLM API keys. Guardrails against accidental leakage are important.\n- **Access control**: Currently limited to owner/member/collaborator. More granular permissions (e.g., label-based, team-based) could add flexibility.\n\n### 9.3 Cost\n- **LLM API costs**: Long conversations with large models can be expensive. Token tracking and budget controls will become essential.\n- **Actions minutes**: Self-hosted runners or usage caps may be needed for active repos.\n\n### 9.4 User Experience\n- **Latency**: GitHub Actions cold-start + LLM inference means responses take 30â€“120+ seconds. Setting expectations and showing progress indicators helps.\n- **Discoverability**: New users need to know the agent exists and what it can do. In-repo documentation and issue templates help.\n- **Error handling**: When the agent fails, the user experience should be clear and actionable, not a silent ðŸ‘€ that never resolves.\n\n---\n\n## 10. Summary\n\nGitClaw is more than an AI chatbot in a repo. It's a demonstration that:\n\n1. **AI agents don't need infrastructure** â€” git + Actions + an API key is enough.\n2. **Conversations are data** â€” and they deserve the same versioning, auditability, and collaboration that code gets.\n3. **Agent behavior is configuration** â€” personalities, skills, and settings are just files, managed like code.\n4. **The repository is the platform** â€” not just for code, but for AI-powered workflows, knowledge, and collaboration.\n\nThe most exciting possibilities aren't any single feature â€” they're the _combinatorial space_ that opens up when AI behavior is version-controlled, modular, and zero-infrastructure. Every skill, every personality, every workflow integration multiplies the others.\n\nGitClaw is a foundation. What gets built on it depends on who picks it up and what problems they bring to it.\n\n---\n\n_Last updated: 2026-02-19_\n"}],"isError":false,"timestamp":1771588062315}}
{"type":"message","id":"db4909fd","parentId":"6d23d83e","timestamp":"2026-02-20T11:47:42.319Z","message":{"role":"toolResult","toolCallId":"toolu_01NwddcpaQkEHT6BYFMjuQXS","toolName":"read","content":[{"type":"text","text":"# .GITCLAW ðŸ¦ž Roadmap\n\n### Deep GitHub integration â€” from issue bot to full-platform agent\n\n<p align=\"center\">\n  <picture>\n    <img src=\"https://raw.githubusercontent.com/japer-technology/gitclaw/main/.GITCLAW/GITCLAW-LOGO.png\" alt=\"GitClaw\" width=\"500\">\n  </picture>\n</p>\n\n> This roadmap builds on [GITCLAW-Possibilities.md](GITCLAW-Possibilities.md) and lays out concrete\n> phases for turning GitClaw from an issue-comment assistant into an agent that\n> participates in every layer of the GitHub platform â€” pull requests, reviews,\n> checks, projects, releases, security scanning, and more.\n\n---\n\n## Guiding Principles\n\n| Principle | Meaning |\n|---|---|\n| **Git-native state** | All agent memory, decisions, and artifacts stay in the repo â€” diffable, auditable, revertable. |\n| **Zero external infrastructure** | Everything runs on GitHub Actions, the GitHub API, and the repository itself. |\n| **Incremental opt-in** | Each capability is a separate workflow/skill that a repo owner enables explicitly. |\n| **Fail-closed security** | The agent does nothing unless the correct sentinel files, permissions, and gates are in place. |\n| **Human-in-the-loop by default** | The agent proposes; humans approve. Automation never bypasses review. |\n\n---\n\n## Phase 0 â€” Foundation (current state)\n\nWhat GitClaw already does today:\n\n- [x] Trigger on `issues.opened` and `issue_comment.created`\n- [x] Authorization gating (`OWNER` / `MEMBER` / `COLLABORATOR`)\n- [x] Multi-turn sessions persisted as JSONL in `state/sessions/`\n- [x] Issue â†’ session mapping in `state/issues/`\n- [x] ðŸ‘€ reaction indicator while working\n- [x] Commit + push state to `main` with retry-on-conflict\n- [x] Modular skill system and configurable personality\n\n---\n\n## Phase 1 â€” Pull Request Lifecycle\n\n> **Goal:** Make the agent a first-class participant in code review and merging.\n\n### 1.1 Pull Request Triggers\n\nExtend the Actions workflow to listen on `pull_request` and `pull_request_review` events in addition to issues.\n\n- [ ] Add `pull_request: [opened, synchronize, reopened]` trigger to `agent.yml`\n- [ ] Add `pull_request_review: [submitted]` and `pull_request_review_comment: [created]` triggers\n- [ ] Map PR number â†’ session (parallel to the existing issue â†’ session model)\n- [ ] Store PR sessions under `state/pull-requests/<pr>.json`\n\n### 1.2 Pull Request Reviews\n\nUse the GitHub API to post structured review objects (not just comments).\n\n- [ ] Post `APPROVE`, `REQUEST_CHANGES`, or `COMMENT` reviews via `gh api`\n- [ ] Attach file-specific review comments to the correct diff hunks\n- [ ] Track unresolved review threads and resurface them on new pushes\n- [ ] Summarize large diffs as a top-level review body before line-level comments\n\n### 1.3 PR Comments & Threads\n\nParticipate in line-level review discussions the same way the agent participates in issue threads today.\n\n- [ ] Listen for `pull_request_review_comment.created` events\n- [ ] Reply inline to unresolved threads with analysis or suggested fixes\n- [ ] Maintain a per-PR \"open threads\" summary in the session state\n- [ ] Allow `/resolve` slash command to mark a thread as addressed\n\n### 1.4 Check Runs\n\nPost structured pass/fail results and inline annotations on commits.\n\n- [ ] Create Check Runs via the Checks API (`POST /repos/{owner}/{repo}/check-runs`)\n- [ ] Report `success`, `failure`, `neutral`, or `action_required` conclusions\n- [ ] Attach inline annotations (file, line, message, severity) for code issues\n- [ ] Update Check Run output with markdown summaries and progress counts\n- [ ] Add `checks: write` permission to the workflow\n\n### 1.5 Status Checks\n\nGate merges on agent-posted results.\n\n- [ ] Register a required status check (e.g., `gitclaw/review`) in branch protection\n- [ ] Post commit status via the Status API to signal policy compliance\n- [ ] Block merge when the agent identifies critical issues (security, lint, tests)\n- [ ] Clear/pass the status once issues are resolved and review is approved\n\n---\n\n## Phase 2 â€” Project Management & Triage\n\n> **Goal:** Let the agent organize, label, and track work â€” not just respond to it.\n\n### 2.1 Labels\n\nRoute and classify work using a managed label taxonomy.\n\n- [ ] Build a `label-taxonomy` skill defining standard label categories (type, priority, area, status)\n- [ ] Auto-label new issues based on title/body analysis\n- [ ] Enforce label hygiene â€” warn or auto-fix when taxonomy rules are violated\n- [ ] Support label-driven agent dispatch: `agent:review`, `agent:docs`, `agent:triage`\n\n### 2.2 Projects (v2)\n\nIntegrate with GitHub Projects to move issues through workflow stages.\n\n- [ ] Read project board state via the GraphQL API (`ProjectV2` schema)\n- [ ] Move issues between columns/status fields based on agent analysis\n- [ ] Set custom field values (priority, effort estimate, sprint)\n- [ ] Auto-create project items when new issues match configured criteria\n- [ ] Build a `project-sync` skill that reconciles board state with issue labels\n\n### 2.3 Milestones\n\nGroup issues by release target and keep scope consistent.\n\n- [ ] Assign issues to milestones based on label or content analysis\n- [ ] Generate milestone progress reports (open/closed, burn-down, scope creep alerts)\n- [ ] Warn when a milestone's scope changes significantly between check-ins\n- [ ] Build a `milestone-report` skill triggered on schedule or slash command\n\n### 2.4 Discussions\n\nParticipate in GitHub Discussions for long-form Q&A and RFCs.\n\n- [ ] Add `discussion` and `discussion_comment` triggers to the workflow\n- [ ] Summarize long discussion threads into actionable decisions\n- [ ] Extract action items and open issues from discussion conclusions\n- [ ] Build an `rfc-summarizer` skill that posts a structured summary as a pinned comment\n\n---\n\n## Phase 3 â€” Releases & Versioning\n\n> **Goal:** Automate the release pipeline from changelog to tag to published release.\n\n### 3.1 Releases\n\nGenerate changelogs and release notes from merged issues and PRs.\n\n- [ ] Build a `release-notes` skill that collects merged PRs since last tag\n- [ ] Categorize changes by label (features, fixes, breaking, internal)\n- [ ] Draft a GitHub Release via the Releases API with generated notes\n- [ ] Support both Keep-a-Changelog and Conventional Commits formats\n- [ ] Allow human review before publishing (draft â†’ published gate)\n\n### 3.2 Tags\n\nMark version points and coordinate tagging with release notes.\n\n- [ ] Create annotated git tags via `git tag -a` with structured messages\n- [ ] Enforce semantic versioning by analyzing change categories (major/minor/patch)\n- [ ] Coordinate tag creation with release note publication in a single workflow\n- [ ] Build a `version-bump` skill that updates version files and creates the tag\n\n---\n\n## Phase 4 â€” Security & Compliance\n\n> **Goal:** Turn the agent into a security-aware collaborator that triages alerts, enforces policy, and contains incidents.\n\n### 4.1 Code Scanning (CodeQL)\n\nTriage CodeQL alerts and suggest fixes.\n\n- [ ] Read Code Scanning alerts via the REST API\n- [ ] Post triage comments on alerts (dismiss with reason, or propose a fix)\n- [ ] Open fix PRs for auto-remediable vulnerability patterns\n- [ ] Track alert trends and surface regressions in a periodic report\n- [ ] Build a `codeql-triage` skill with severity-based prioritization\n\n### 4.2 Dependabot Alerts & PRs\n\nCoordinate dependency updates and security fixes.\n\n- [ ] Monitor Dependabot alerts via the API\n- [ ] Auto-approve low-risk Dependabot PRs (patch bumps, no breaking changes)\n- [ ] Summarize high-risk alerts in a triage issue with impact analysis\n- [ ] Build a `dependency-review` skill that evaluates upgrade paths\n- [ ] Add `security_advisory` event trigger for real-time response\n\n### 4.3 Secret Scanning\n\nDetect leaked credentials and trigger containment.\n\n- [ ] Monitor Secret Scanning alerts via the API\n- [ ] Immediately open a high-priority issue on new secret detection\n- [ ] Post containment instructions (revoke, rotate, audit access logs)\n- [ ] Auto-close alerts that are resolved or marked as false positives\n- [ ] Build a `secret-response` skill with provider-specific rotation guidance\n\n### 4.4 CODEOWNERS\n\nEnforce reviewer requirements for sensitive paths.\n\n- [ ] Generate and maintain a `CODEOWNERS` file based on git blame and team structure\n- [ ] Validate that PRs touching protected paths have required reviewers assigned\n- [ ] Warn when CODEOWNERS entries reference users who have left the organization\n- [ ] Build a `codeowners-audit` skill that reports coverage gaps\n\n### 4.5 Branch Protection Rules\n\nEnforce review, checks, and signed commits before merge.\n\n- [ ] Audit branch protection configuration and report gaps\n- [ ] Recommend protection rules based on repository activity patterns\n- [ ] Verify that agent-created PRs respect all protection requirements\n- [ ] Surface protection rule violations in Check Run annotations\n\n### 4.6 Rulesets\n\nOrg-level policy enforcement across multiple repositories.\n\n- [ ] Read repository and org-level rulesets via the API\n- [ ] Validate agent actions against active rulesets before execution\n- [ ] Report ruleset compliance status in milestone and release reports\n- [ ] Build a `policy-check` skill that audits cross-repo rule consistency\n\n---\n\n## Phase 5 â€” Advanced Workflow & Identity\n\n> **Goal:** Give the agent a proper identity, secure credentials, and flexible triggering.\n\n### 5.1 GitHub Apps\n\nFine-grained permissions and auditability for the agent identity.\n\n- [ ] Package GitClaw as an installable GitHub App\n- [ ] Use App installation tokens instead of `GITHUB_TOKEN` for tighter scoping\n- [ ] Separate agent identity from workflow bot (`gitclaw[bot]` vs `github-actions[bot]`)\n- [ ] Enable per-repo permission grants (issues only, issues+PRs, full access)\n- [ ] Add webhook-based triggers alongside Actions for lower-latency responses\n\n### 5.2 OIDC Credentials\n\nShort-lived cloud auth without long-lived secrets.\n\n- [ ] Configure OIDC trust between GitHub Actions and cloud providers (AWS, GCP, Azure)\n- [ ] Replace static API keys with short-lived OIDC tokens in agent workflows\n- [ ] Scope OIDC claims to specific repos, branches, and workflow steps\n- [ ] Document OIDC setup for each major cloud provider in a `cloud-auth` guide\n- [ ] Build a `credential-audit` skill that flags long-lived secrets in repo settings\n\n### 5.3 Actions Environments\n\nAdd approval gates and protected deployment contexts.\n\n- [ ] Define `staging` and `production` environments with reviewer requirements\n- [ ] Run agent release skills through environment approval gates\n- [ ] Add environment-specific secrets (deploy keys, API endpoints) scoped per stage\n- [ ] Enforce environment protection rules on agent-initiated deployments\n\n### 5.4 Workflow Dispatch\n\nManually trigger agent runs with parameters.\n\n- [ ] Add `workflow_dispatch` trigger with configurable input parameters\n- [ ] Define inputs for task type, target issue/PR, skill override, and model selection\n- [ ] Build a dispatch UI that maps to common agent tasks\n- [ ] Allow scheduled skills to also be triggered on-demand via dispatch\n\n### 5.5 Repository Dispatch\n\nTrigger workflows from external events without polling.\n\n- [ ] Add `repository_dispatch` trigger with typed event payloads\n- [ ] Define event types: `agent-task`, `security-alert`, `deploy-request`, `external-review`\n- [ ] Document webhook integration for external CI, monitoring, and alerting systems\n- [ ] Build an `event-router` skill that dispatches to the correct handler based on event type\n\n---\n\n## Phase 6 â€” Artifacts & Observability\n\n> **Goal:** Store, inspect, and report on everything the agent does.\n\n### 6.1 Artifacts\n\nStore reports, summaries, and build outputs for later inspection.\n\n- [ ] Upload agent reports as workflow artifacts via `actions/upload-artifact`\n- [ ] Generate structured outputs: review reports, triage summaries, audit results\n- [ ] Attach artifact links to issue/PR comments for easy access\n- [ ] Implement artifact retention policies (e.g., keep last 10 runs per skill)\n- [ ] Build a `report-archive` skill that indexes artifacts by type and date\n\n### 6.2 Agent Observability\n\nTrack what the agent does, how long it takes, and what it costs.\n\n- [ ] Log token usage, model, and latency per session turn\n- [ ] Publish per-run metrics as artifact JSON files\n- [ ] Build a `usage-report` skill that summarizes weekly/monthly agent activity\n- [ ] Surface cost and performance trends in a GitHub Pages dashboard\n\n---\n\n## Phase Summary\n\n| Phase | Focus | Key Outcomes |\n|---|---|---|\n| **0** | Foundation (done) | Issue-driven agent with git-backed state |\n| **1** | Pull Request Lifecycle | Agent reviews PRs, posts checks, gates merges |\n| **2** | Project Management & Triage | Auto-labeling, project board sync, milestone tracking |\n| **3** | Releases & Versioning | Automated changelogs, tags, and GitHub Releases |\n| **4** | Security & Compliance | CodeQL triage, Dependabot coordination, secret response, policy enforcement |\n| **5** | Advanced Workflow & Identity | GitHub App identity, OIDC auth, dispatch triggers, environments |\n| **6** | Artifacts & Observability | Structured reports, usage metrics, cost tracking |\n\n---\n\n## Integration Map\n\nHow each GitHub feature connects to GitClaw:\n\n```\n                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n                         â”‚              GitHub Platform                â”‚\n                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n                                            â”‚\n        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”´â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n        â”‚               â”‚               â”‚       â”‚               â”‚              â”‚\n   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”      â”‚\n   â”‚ Issues  â”‚   â”‚Pull Requestsâ”‚  â”‚  Actions  â”‚ â”‚       â”‚   Security    â”‚      â”‚\n   â”‚         â”‚   â”‚  & Reviews  â”‚  â”‚           â”‚ â”‚       â”‚               â”‚      â”‚\n   â”‚ Phase 0 â”‚   â”‚  Phase 1    â”‚  â”‚ Phase 5   â”‚ â”‚       â”‚  Phase 4      â”‚      â”‚\n   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚\n        â”‚               â”‚               â”‚       â”‚               â”‚              â”‚\n        â”‚         â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”  â”‚        â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”       â”‚\n        â”‚         â”‚Check Runs &â”‚  â”‚Dispatch & â”‚  â”‚        â”‚CodeQL       â”‚       â”‚\n        â”‚         â”‚Status      â”‚  â”‚Environ-   â”‚  â”‚        â”‚Dependabot   â”‚       â”‚\n        â”‚         â”‚Checks      â”‚  â”‚ments      â”‚  â”‚        â”‚Secrets      â”‚       â”‚\n        â”‚         â”‚ Phase 1    â”‚  â”‚ Phase 5   â”‚  â”‚        â”‚ Phase 4     â”‚       â”‚\n        â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚\n        â”‚                                        â”‚                              â”‚\n   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”\n   â”‚ Labels, Milestones,   â”‚           â”‚  Releases & Tags   â”‚          â”‚  Artifacts &  â”‚\n   â”‚ Projects, Discussions â”‚           â”‚                    â”‚          â”‚  Observabilityâ”‚\n   â”‚                       â”‚           â”‚    Phase 3         â”‚          â”‚               â”‚\n   â”‚       Phase 2         â”‚           â”‚                    â”‚          â”‚   Phase 6     â”‚\n   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n                                                â”‚\n                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n                                    â”‚   CODEOWNERS,         â”‚\n                                    â”‚   Branch Protection,  â”‚\n                                    â”‚   Rulesets             â”‚\n                                    â”‚                       â”‚\n                                    â”‚      Phase 4          â”‚\n                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n---\n\n## Feature Ã— Phase Matrix\n\n| Feature | Phase | Trigger / API | New Permissions | Key Skill |\n|---|---|---|---|---|\n| Pull Requests | 1 | `pull_request` event | `pull-requests: write` | `pr-review` |\n| PR Reviews | 1 | `pull_request_review` event | `pull-requests: write` | `pr-review` |\n| PR Comments / Threads | 1 | `pull_request_review_comment` event | `pull-requests: write` | `pr-review` |\n| Check Runs | 1 | Checks API | `checks: write` | `check-reporter` |\n| Status Checks | 1 | Status API | `statuses: write` | `status-gate` |\n| Labels | 2 | Labels API | `issues: write` | `label-taxonomy` |\n| Projects (v2) | 2 | GraphQL `ProjectV2` | `project: write` (App) | `project-sync` |\n| Milestones | 2 | Milestones API | `issues: write` | `milestone-report` |\n| Discussions | 2 | `discussion` event | `discussions: write` | `rfc-summarizer` |\n| Releases | 3 | Releases API | `contents: write` | `release-notes` |\n| Tags | 3 | Git + Tags API | `contents: write` | `version-bump` |\n| Code Scanning | 4 | Code Scanning API | `security-events: write` | `codeql-triage` |\n| Dependabot | 4 | Dependabot API | `security-events: read` | `dependency-review` |\n| Secret Scanning | 4 | Secret Scanning API | `secret-scanning-alerts: read` | `secret-response` |\n| CODEOWNERS | 4 | File in repo | `contents: write` | `codeowners-audit` |\n| Branch Protection | 4 | Branch Protection API | `administration: read` | `policy-check` |\n| Rulesets | 4 | Rulesets API | `administration: read` | `policy-check` |\n| GitHub Apps | 5 | App Installation API | App-managed | â€” |\n| OIDC Credentials | 5 | OIDC provider config | `id-token: write` | `credential-audit` |\n| Environments | 5 | Environments API | `deployments: write` | â€” |\n| Workflow Dispatch | 5 | `workflow_dispatch` event | â€” | â€” |\n| Repository Dispatch | 5 | `repository_dispatch` event | â€” | `event-router` |\n| Artifacts | 6 | `actions/upload-artifact` | `actions: write` | `report-archive` |\n\n---\n\n## Implementation Notes\n\n### Session model extension\n\nThe current `state/issues/<n>.json` â†’ `state/sessions/<session>.jsonl` model extends naturally:\n\n```\nstate/\n  issues/\n    42.json                 # issue #42 â†’ session mapping\n  pull-requests/\n    17.json                 # PR #17 â†’ session mapping\n  discussions/\n    5.json                  # discussion #5 â†’ session mapping\n  sessions/\n    2026-02-20T..._abc.jsonl\n```\n\nEach event source (issue, PR, discussion) maps to a session via the same pointer pattern.\n\n### Workflow file evolution\n\nThe single `agent.yml` workflow grows to handle multiple event types:\n\n```yaml\non:\n  issues:\n    types: [opened]\n  issue_comment:\n    types: [created]\n  pull_request:\n    types: [opened, synchronize, reopened]\n  pull_request_review:\n    types: [submitted]\n  pull_request_review_comment:\n    types: [created]\n  discussion:\n    types: [created]\n  discussion_comment:\n    types: [created]\n  workflow_dispatch:\n    inputs:\n      task:\n        description: \"Task for the agent\"\n        required: true\n      skill:\n        description: \"Skill override\"\n        required: false\n  repository_dispatch:\n    types: [agent-task, security-alert, deploy-request]\n  schedule:\n    - cron: \"0 9 * * 1\"  # weekly triage\n```\n\n### Permission growth\n\nAs capabilities expand, the workflow permission block grows:\n\n```yaml\npermissions:\n  contents: write\n  issues: write\n  pull-requests: write\n  checks: write\n  statuses: write\n  actions: write\n  discussions: write\n  security-events: write\n  id-token: write\n```\n\nThe GitHub App model (Phase 5) replaces this with fine-grained per-installation scoping.\n\n### Skill naming convention\n\nNew skills follow a consistent naming pattern:\n\n```\n.GITCLAW/.pi/skills/\n  pr-review.md\n  check-reporter.md\n  label-taxonomy.md\n  project-sync.md\n  milestone-report.md\n  rfc-summarizer.md\n  release-notes.md\n  version-bump.md\n  codeql-triage.md\n  dependency-review.md\n  secret-response.md\n  codeowners-audit.md\n  policy-check.md\n  credential-audit.md\n  event-router.md\n  report-archive.md\n  usage-report.md\n```\n\nEach skill is a self-contained Markdown file with optional shell scripts, following the existing skill system conventions.\n\n---\n\n## Dependencies Between Phases\n\n```\nPhase 0 (Foundation)\n  â””â”€â”€â–¶ Phase 1 (PR Lifecycle)\n         â”œâ”€â”€â–¶ Phase 2 (Project Management) â”€â”€â–¶ Phase 3 (Releases)\n         â””â”€â”€â–¶ Phase 4 (Security)\n                â””â”€â”€â–¶ Phase 5 (Workflow & Identity) â”€â”€â–¶ Phase 6 (Observability)\n```\n\n- **Phase 1** depends on Phase 0: PR triggers reuse the session and commit/push model.\n- **Phase 2** depends on Phase 1: label-driven dispatch and project tracking build on PR awareness.\n- **Phase 3** depends on Phase 2: release notes are generated from labeled, milestoned PRs.\n- **Phase 4** can start in parallel with Phase 2: security scanning is independent of project management.\n- **Phase 5** depends on Phase 4: GitHub App identity is needed for advanced permissions.\n- **Phase 6** depends on Phase 5: observability needs dispatch triggers and artifact uploads.\n\n---\n\n_Last updated: 2026-02-20_\n"}],"isError":false,"timestamp":1771588062318}}
{"type":"message","id":"61b83b03","parentId":"db4909fd","timestamp":"2026-02-20T11:47:42.320Z","message":{"role":"toolResult","toolCallId":"toolu_01BVDRCp3xDyeKuHo791131d","toolName":"read","content":[{"type":"text","text":"# .GITCLAW ðŸ¦ž Internals\n\n### The internal mechanics of .GITCLAW\n\n<p align=\"center\">\n  <picture>\n    <img src=\"https://raw.githubusercontent.com/japer-technology/gitclaw/main/.GITCLAW/GITCLAW-LOGO.png\" alt=\"GitClaw\" width=\"500\">\n  </picture>\n</p>\n\n## 1) High-level architecture\n\n`gitclaw` is a GitHub Actions-native agent wrapper around the `pi` coding agent CLI.\n\nAt a high level:\n\n1. A GitHub issue is opened, or a comment is added to an issue.\n2. A workflow job runs on `ubuntu-latest`.\n3. A preinstall script adds an ðŸ‘€ reaction to indicate â€œworkingâ€.\n4. The main script:\n   - fetches issue data,\n   - resolves whether to resume an existing session or start a new one,\n   - runs `pi` in JSON streaming mode,\n   - extracts the final assistant text,\n   - commits any repo changes (including memory/session files),\n   - pushes to `main`,\n   - comments the assistant output back to the issue.\n5. A final cleanup step removes the ðŸ‘€ reaction.\n\nThe repository itself is used as durable state storage (`state/issues` and `state/sessions`), which gives the agent long-term memory through committed session logs.\n\n---\n\n## 2) Triggering and access control\n\nWorkflow file: `.github/workflows/agent.yml`\n\n### Events\nThe workflow triggers on:\n\n- `issues` with type `opened`\n- `issue_comment` with type `created`\n\nThis means:\n- Opening a new issue starts a new agent interaction.\n- Adding a new comment resumes/continues the issueâ€™s conversation context.\n\n### Authorization gating\nThe job has an `if:` condition that only allows:\n\n- Issue opener must have association in: `OWNER`, `MEMBER`, or `COLLABORATOR`.\n- Issue comments must be from non-`github-actions[bot]` users and also one of `OWNER`, `MEMBER`, `COLLABORATOR`.\n\nEffectively, random outsiders on a public repository cannot trigger the agent pipeline.\n\n### Permissions\nWorkflow token permissions are:\n\n- `contents: write` (commit/push changes)\n- `issues: write` (post comments/reactions)\n- `actions: write`\n\n---\n\n## 3) Runtime boot sequence inside Actions\n\nJob steps are intentionally ordered:\n\n1. **Checkout** (`actions/checkout@v4`)\n2. **Setup Bun** (`oven-sh/setup-bun@v2`)\n3. **Guard** (`bun lifecycle/GITCLAW-ENABLED.ts`) â€” fail-closed check for `GITCLAW-ENABLED.md` sentinel\n4. **Preinstall** (`bun lifecycle/GITCLAW-INDICATOR.ts`)\n5. **Install dependencies** (`bun install --frozen-lockfile`)\n6. **Run main logic** (`bun lifecycle/GITCLAW-AGENT.ts`)\n\nNotably, the guard runs before anything else to enforce the fail-closed opt-in, and preinstall runs before dependency installation to immediately signal activity via reaction.\n\n---\n\n## 4) Preinstall script: signaling â€œin progressâ€\n\nFile: `lifecycle/GITCLAW-INDICATOR.ts`\n\n### Inputs read from GitHub Actions env\n- `GITHUB_EVENT_PATH` â†’ JSON payload path for the triggering event.\n- `GITHUB_EVENT_NAME` â†’ either `issues` or `issue_comment`.\n- `GITHUB_REPOSITORY` â†’ `owner/repo` slug.\n\n### Behavior\n- Parses the event payload.\n- Determines issue number and whether event is comment-driven.\n- Uses `gh api` to create an `eyes` reaction:\n  - On issue comment events: reaction is placed on the specific comment.\n  - On issue open events: reaction is placed on the issue itself.\n- Catches/logs errors but does not hard-fail workflow.\n\n### Cross-step state handoff\nWrites `/tmp/reaction-state.json` containing:\n\n- `reactionId`\n- `reactionTarget` (`comment` or `issue`)\n- `commentId` (if applicable)\n- `issueNumber`\n- `repo`\n\nThis temp file is consumed later by `GITCLAW-AGENT.ts` for cleanup in a `finally` block.\n\n---\n\n## 5) Main script: full orchestration\n\nFile: `lifecycle/GITCLAW-AGENT.ts`\n\nThis is the core orchestrator.\n\n### 5.1 Event/context initialization\nReads the same environment payloads and computes `issueNumber` from `event.issue.number`.\n\nDefines helper wrappers:\n\n- `run(cmd, opts?)` for spawning subprocesses with stdout capture.\n- `gh(...args)` thin wrapper around `run([\"gh\", ...args])`.\n\n### 5.2 Restore reaction cleanup context\nIf `/tmp/reaction-state.json` exists, parse it. This allows robust reaction cleanup even if downstream operations fail.\n\n### 5.3 Fetch issue title/body\nRuns:\n- `gh issue view <issue> --json title --jq .title`\n- `gh issue view <issue> --json body --jq .body`\n\nThese are used to build the initial prompt for issue-open events.\n\n### 5.4 Session persistence model\nCreates storage dirs if needed:\n\n- `state/issues`\n- `state/sessions`\n\nUses mapping file:\n\n- `state/issues/<issueNumber>.json`\n\nThe mapping points each issue number to its latest `pi` session file path.\n\n#### Resume/new resolution\n- If mapping exists and mapped session file exists â†’ mode `resume`, reuse session path.\n- Otherwise â†’ mode `new`.\n\nThis enables issue-thread continuity over time and across workflow runs.\n\n### 5.5 Git identity setup\nConfigures bot git identity at runtime:\n\n- `git config user.name gitclaw[bot]`\n- `git config user.email gitclaw[bot]@users.noreply.github.com`\n\n### 5.6 Prompt selection\n- For `issue_comment`: prompt is `event.comment.body` (latest user message).\n- For `issues` opened: prompt is `\"<title>\\n\\n<body>\"`.\n\n### 5.7 Running `pi` agent\nConstructs command:\n\n- `bunx pi --mode json --session-dir ./state/sessions -p <prompt>`\n- plus `--session <existing-path>` in resume mode.\n\nExecution model:\n\n1. Spawn `pi` with stdout piped.\n2. Pipe through `tee /tmp/agent-raw.jsonl` so output is both visible and persisted.\n\n### 5.8 Extracting the final assistant text\nPost-processes `/tmp/agent-raw.jsonl` by:\n\n- `tac` (reverse lines)\n- `jq` expression that selects most recent `message_end` and then text segments from `message.content`\n\nResult is `agentText`, the plain text body used for issue commenting.\n\n### 5.9 Determine latest session file\nUses shell listing:\n\n- `ls -t state/sessions/*.jsonl | head -1`\n\nStores that path into the issue mapping file with timestamp.\n\nMapping shape:\n\n```json\n{\n  \"issueNumber\": 123,\n  \"sessionPath\": \"state/sessions/<session>.jsonl\",\n  \"updatedAt\": \"<ISO timestamp>\"\n}\n```\n\n### 5.10 Commit and push state changes\n- `git add -A`\n- checks if staged diff exists via `git diff --cached --quiet`\n- if changes exist: commit message `gitclaw: work on issue #<n>`\n\nPush strategy:\n\n- Try `git push origin main`\n- On failure, retry up to 3x with `git pull --rebase origin main` between attempts.\n\nThis is a pragmatic conflict-handling loop for concurrent workflow runs.\n\n### 5.11 Comment back to issue\nPosts `agentText` (trimmed to 60,000 chars) via:\n\n- `gh issue comment <issue> --body <commentBody>`\n\nThis is the visible assistant response for the user.\n\n### 5.12 Guaranteed cleanup (`finally`)\nAlways attempts to remove the earlier ðŸ‘€ reaction.\n\n- Deletes from comment reaction endpoint if target is comment.\n- Otherwise deletes from issue reaction endpoint.\n\nErrors here are logged and swallowed so cleanup failures donâ€™t crash the pipeline.\n\n---\n\n## 6) Data model and memory semantics\n\nAs described in README, state is git-backed:\n\n- `state/issues/<n>.json`: pointer from issue number to latest session file.\n- `state/sessions/*.jsonl`: full serialized conversation log for `pi`.\n\n### Implications\n- **Long-term memory**: persisted across runs because sessions are committed.\n- **Auditability**: every conversation evolution is versioned in git history.\n- **Resumability**: issue comments continue same session via mapping lookup.\n\nThis is intentionally â€œrepo-as-databaseâ€ with low operational overhead.\n\n---\n\n## 7) Why this design works well\n\n### Strengths\n- **Zero server infra**: only GitHub Actions + repo storage.\n- **Simple auth model**: relies on GitHub association and token scopes.\n- **Deterministic orchestration**: explicit step sequence and CLI tooling.\n- **Built-in observability**: workflow logs + committed session artifacts.\n\n### Tradeoffs / limitations\n- **Latency** tied to Actions startup and runtime.\n- **Storage growth** as session logs accumulate.\n- **Branch assumption** hardcoded to push/pull `main` in `GITCLAW-AGENT.ts`.\n- **Output extraction fragility** depends on expected `pi` JSON schema and `jq` query shape.\n\n---\n\n## 8) Failure paths and resilience\n\n- Reaction add/remove failures are non-fatal (try/catch).\n- Push conflicts are mitigated with rebase retry loop.\n- Missing session mapping gracefully falls back to new session.\n- Missing mapped session file also falls back to new session.\n\nPotential hard failures would come from:\n- absent `ANTHROPIC_API_KEY`,\n- malformed or incompatible `pi` output schema,\n- fatal `gh` CLI failures for issue fetch/comment,\n- persistent git push failures after retries.\n\n---\n\n## 9) Dependency/runtime stack\n\n- Runtime: **Bun**\n- Agent: `@mariozechner/pi-coding-agent` (invoked via `bunx pi`)\n- Tooling used by scripts: `gh`, `git`, `tee`, `tac`, `jq`, `bash`, standard fs APIs.\n\n`package.json` keeps dependencies minimal; most orchestration power comes from command-line tools in the GitHub-hosted runner.\n\n---\n\n## 10) End-to-end sequence diagram (conceptual)\n\n1. User opens issue/comment.\n2. Workflow starts (if actor authorized).\n3. `GITCLAW-ENABLED.ts` verifies opt-in sentinel exists (fail-closed guard).\n4. `GITCLAW-INDICATOR.ts` adds ðŸ‘€ reaction.\n5. `GITCLAW-AGENT.ts` fetches issue context.\n6. `GITCLAW-AGENT.ts` resolves/creates session mapping.\n7. `GITCLAW-AGENT.ts` runs `pi` with prompt (+ prior session if resume).\n8. `GITCLAW-AGENT.ts` extracts final assistant text.\n9. `GITCLAW-AGENT.ts` commits session/mapping/other repo changes.\n10. `GITCLAW-AGENT.ts` pushes to `main` with retry-on-conflict.\n11. `GITCLAW-AGENT.ts` comments response to issue.\n12. `GITCLAW-AGENT.ts` removes ðŸ‘€ reaction in `finally`.\n\n---\n\n## 11) Practical mental model\n\nThink of each issue number as a stable conversation key:\n\n- `issue #N` â†’ `state/issues/N.json` â†’ `state/sessions/<session>.jsonl`\n\nWhen a new comment appears on issue #N, the agent loads that linked session and keeps going. The repo itself is both memory and synchronization medium.\n\nThat is the core trick that makes this project work without external databases or services.\n"}],"isError":false,"timestamp":1771588062320}}
{"type":"message","id":"e777d72f","parentId":"61b83b03","timestamp":"2026-02-20T11:48:29.382Z","message":{"role":"assistant","content":[{"type":"thinking","thinking":"Now I have a thorough understanding of .GITCLAW. Let me write a fabulous description.","thinkingSignature":"Ev0BCkYICxgCKkBy6RJ0+KLFKsQozQX0UKzqfqoU55e2HcAS0sCGGra+bNq3BA7pJNUig/29Bges6IuxnOs3+sKFl2aknLsL59CWEgzzubJMdUIBqHrRew4aDGdmfADS+f7OC2IVGCIwybCVE/COg+mgK4Xtx97LLMIcFbt3n2TeiWbGYMTNmOorGIXXN4izrupO4AnPXZm+KmV87EFfZgQ+NFOD8+UoCbT3XIB7uuLNp4o22JvL1+HenjOkKCmAskygZGGyu/OI/6a+rge4j9ecFDVcRGzmkRmaw9N/Yu/GC9b0A3vG+057uez9vGujHfRZ/7GxTrkUULCHA2e5JxgB"},{"type":"text","text":"Now I have a deep understanding of .GITCLAW. Let me write something fabulous."},{"type":"toolCall","id":"toolu_01LwwUAYsMvP3uvesrefEh2U","name":"write","arguments":{"path":"THE-IDEA.md","content":"# THE IDEA ðŸ¦ž\n\n## .GITCLAW â€” An AI Agent That Lives in Your Repo\n\nWhat if your repository wasn't just a place where code sleeps between deploys â€” but a living, breathing collaborator that *thinks*?\n\nThat's `.GITCLAW`.\n\n---\n\n## The Elevator Pitch\n\nDrop a single folder into any GitHub repository. Push. Open an issue. *Something answers.*\n\nNo servers. No databases. No infrastructure to provision, monitor, babysit, or pay for beyond what you already have. Just a folder called `.GITCLAW/`, a GitHub Actions workflow, and an LLM API key. That's the entire stack.\n\nYour repo becomes sentient. Or at least, *conversant*.\n\n---\n\n## The Audacious Simplicity\n\nMost AI agent platforms look like this: a SaaS dashboard, a database cluster, a queue system, webhook receivers, auth middleware, monitoring dashboards, and a pricing page that makes you wince. You deploy the agent somewhere *else*, and it reaches into your repo like a stranger rummaging through your filing cabinet.\n\n`.GITCLAW` inverts this completely.\n\nThe agent doesn't live *outside* your repo and reach *in*. It lives **inside** your repo. Its memory is git commits. Its interface is GitHub Issues. Its compute is GitHub Actions. Its personality is a Markdown file. Its skills are more Markdown files. Everything is diffable, auditable, revertable, and forkable.\n\n**The repository _is_ the application.**\n\n---\n\n## How It Works (The Beautiful Part)\n\n1. **You open an issue.** Write anything â€” a question, a request, a half-formed thought.\n2. **The agent wakes up.** GitHub Actions triggers a workflow. A ðŸ‘€ emoji appears. Something is thinking.\n3. **It responds.** A comment appears on your issue with a thoughtful, context-aware reply. It can read your entire codebase. It can write files. It can search its own memory.\n4. **You reply.** Comment on the same issue. The conversation continues. The agent picks up exactly where it left off â€” not because it's running a server with session state, but because the conversation is *committed to git*.\n5. **Everything is saved.** Sessions are JSONL files in `state/sessions/`. Issue-to-session mappings live in `state/issues/`. Every interaction is a commit. Every commit is history. History is memory.\n\nThe agent remembers because git remembers. It's memory you can `git log`, `git diff`, and `git blame`.\n\n---\n\n## The Trick That Makes It All Work\n\nHere's the core insight, the elegant hack at the heart of `.GITCLAW`:\n\n> **Each issue number is a stable conversation key.**\n>\n> `issue #N` â†’ `state/issues/N.json` â†’ `state/sessions/<session>.jsonl`\n\nWhen you comment on issue #42 three weeks after opening it, the agent loads that linked session and continues. No database lookups. No session cookies. No Redis. Just a JSON pointer in a git-tracked file pointing to a git-tracked conversation log.\n\nThe repo is both the memory and the synchronization medium. That's the trick. That's the whole trick. And it's *brilliant*.\n\n---\n\n## What Makes It Special\n\n### ðŸ—‚ï¸ Git-Native State\nEvery conversation, every decision, every file the agent touches â€” it's all in git. You can review it in a PR. You can revert it. You can fork the entire agent's memory along with the code. Try doing that with ChatGPT.\n\n### ðŸ§© Composable Behavior\nThe agent's behavior is decomposed into three orthogonal axes:\n- **Skills** define *what* it can do (code review, release notes, triage)\n- **Personality** defines *how* it does it (terse and analytical? warm and mentoring?)\n- **Settings** define *which model powers it* (Claude, GPT, Gemini, Grok, DeepSeek, Mistral â€” your pick)\n\nMix and match. It's configuration, not code.\n\n### ðŸ”’ Fail-Closed Security\nThe agent does *nothing* unless a sentinel file (`GITCLAW-ENABLED.md`) exists. Delete it, and every workflow silently exits. Only repo owners, members, and collaborators can trigger it. Random drive-by users on public repos can't hijack your AI.\n\n### ðŸ¥š Personality Hatching\nUse the \"Hatch\" issue template to have a conversation *with* the agent *about* the agent â€” choosing its name, its vibe, its emoji. It's a delightful onboarding ritual that turns setup into play.\n\n### ðŸ”„ Conflict-Resilient Persistence\nMultiple issues being worked simultaneously? The agent retries pushes with `git pull --rebase`, handling concurrent writes gracefully. It's not distributed systems engineering â€” it's just *pragmatic git*.\n\n---\n\n## The Vision: Repository as Platform\n\n`.GITCLAW` is a proof of concept for something larger than itself.\n\nIt proves that **AI agents don't need infrastructure**. Git + Actions + an API key is enough.\n\nIt proves that **conversations are data** â€” and they deserve the same versioning, auditability, and collaboration workflows that code gets.\n\nIt proves that **agent behavior is configuration** â€” files in a repo, managed with the same tools developers already use.\n\nAnd it opens a combinatorial design space that's frankly dizzying:\n\n- **Pull request reviews** where the agent posts structured `APPROVE` / `REQUEST_CHANGES` verdicts with line-level annotations\n- **Automated triage** that labels, prioritizes, and routes issues based on content analysis\n- **Release automation** that generates changelogs from merged PRs and drafts GitHub Releases\n- **Security response** that triages CodeQL alerts, coordinates Dependabot updates, and triggers containment workflows for leaked secrets\n- **Cross-repo agents** where a hub repository monitors an entire organization\n- **Agent-to-agent conversations** where a triage bot opens issues that a review bot responds to\n- **A skill marketplace** where the community publishes and discovers modular capabilities\n\nEach new skill multiplies every existing one. Each new trigger multiplies every existing skill. The surface area grows combinatorially, but the complexity stays linear â€” because it's all just files in a folder.\n\n---\n\n## The Philosophical Bit\n\nThere's something poetic about an AI agent whose memory is `git log`.\n\nMost AI systems treat conversation history as ephemeral â€” cached in RAM, maybe persisted to a database, eventually garbage-collected. `.GITCLAW` treats it as *source code*. Every exchange is a commit. Every commit has an author, a timestamp, a diff. You can trace the agent's evolution the same way you trace your codebase's evolution.\n\nThe agent doesn't just *use* your repository. It *is part of* your repository.\n\nWhen you fork the repo, you fork the agent's mind. When you branch, you branch its reality. When you revert, you revert its memories. The metaphors aren't strained â€” they're *structural*.\n\n---\n\n## In One Sentence\n\n`.GITCLAW` is the idea that a single folder, dropped into any GitHub repository, can turn issues into conversations with an AI agent that remembers everything, touches any file, and needs nothing but git and a willingness to try.\n\nðŸ¦ž\n\n---\n\n*The claw is the repo. The repo is the claw.*\n"}}],"api":"anthropic-messages","provider":"anthropic","model":"claude-opus-4-6","usage":{"input":1,"output":1842,"cacheRead":8640,"cacheWrite":12741,"totalTokens":23224,"cost":{"input":0.000005,"output":0.04605,"cacheRead":0.00432,"cacheWrite":0.07963125,"total":0.13000625}},"stopReason":"toolUse","timestamp":1771588062320}}
{"type":"message","id":"8e9b812e","parentId":"e777d72f","timestamp":"2026-02-20T11:48:29.383Z","message":{"role":"toolResult","toolCallId":"toolu_01LwwUAYsMvP3uvesrefEh2U","toolName":"write","content":[{"type":"text","text":"Successfully wrote 6839 bytes to THE-IDEA.md"}],"isError":false,"timestamp":1771588109383}}
{"type":"message","id":"35236219","parentId":"8e9b812e","timestamp":"2026-02-20T11:48:29.646Z","message":{"role":"assistant","content":[],"api":"anthropic-messages","provider":"anthropic","model":"claude-opus-4-6","usage":{"input":0,"output":0,"cacheRead":0,"cacheWrite":0,"totalTokens":0,"cost":{"input":0,"output":0,"cacheRead":0,"cacheWrite":0,"total":0}},"stopReason":"error","timestamp":1771588109383,"errorMessage":"400 {\"type\":\"error\",\"error\":{\"type\":\"invalid_request_error\",\"message\":\"Your credit balance is too low to access the Anthropic API. Please go to Plans & Billing to upgrade or purchase credits.\"},\"request_id\":\"req_011CYKGXV8f2n34ZjTpdxzZn\"}"}}
{"type":"message","id":"7e19b8a4","parentId":"35236219","timestamp":"2026-02-20T12:13:00.374Z","message":{"role":"user","content":[{"type":"text","text":"Create a file called .GITCLAW/docs/GITCLAW-Loves-Pi.md and fill it with a fabulous description of the of the .pi library"}],"timestamp":1771589580324}}
{"type":"message","id":"0329af37","parentId":"7e19b8a4","timestamp":"2026-02-20T12:13:03.739Z","message":{"role":"assistant","content":[{"type":"toolCall","id":"toolu_01MD86kEXds1S4kFhQjSRH8U","name":"read","arguments":{"path":"/home/runner/work/gitclaw/gitclaw/.GITCLAW/node_modules/@mariozechner/pi-coding-agent/README.md"}}],"api":"anthropic-messages","provider":"anthropic","model":"claude-opus-4-6","usage":{"input":3,"output":89,"cacheRead":0,"cacheWrite":23290,"totalTokens":23382,"cost":{"input":0.000015000000000000002,"output":0.002225,"cacheRead":0,"cacheWrite":0.1455625,"total":0.1478025}},"stopReason":"toolUse","timestamp":1771589580327}}
{"type":"message","id":"ed9365c5","parentId":"0329af37","timestamp":"2026-02-20T12:13:03.743Z","message":{"role":"toolResult","toolCallId":"toolu_01MD86kEXds1S4kFhQjSRH8U","toolName":"read","content":[{"type":"text","text":"<p align=\"center\">\n  <a href=\"https://shittycodingagent.ai\">\n    <img src=\"https://shittycodingagent.ai/logo.svg\" alt=\"pi logo\" width=\"128\">\n  </a>\n</p>\n<p align=\"center\">\n  <a href=\"https://discord.com/invite/3cU7Bz4UPx\"><img alt=\"Discord\" src=\"https://img.shields.io/badge/discord-community-5865F2?style=flat-square&logo=discord&logoColor=white\" /></a>\n  <a href=\"https://www.npmjs.com/package/@mariozechner/pi-coding-agent\"><img alt=\"npm\" src=\"https://img.shields.io/npm/v/@mariozechner/pi-coding-agent?style=flat-square\" /></a>\n  <a href=\"https://github.com/badlogic/pi-mono/actions/workflows/ci.yml\"><img alt=\"Build status\" src=\"https://img.shields.io/github/actions/workflow/status/badlogic/pi-mono/ci.yml?style=flat-square&branch=main\" /></a>\n</p>\n<p align=\"center\">\n  <a href=\"https://pi.dev\">pi.dev</a> domain graciously donated by\n  <br /><br />\n  <a href=\"https://exe.dev\"><img src=\"docs/images/exy.png\" alt=\"Exy mascot\" width=\"48\" /><br />exe.dev</a>\n</p>\n\nPi is a minimal terminal coding harness. Adapt pi to your workflows, not the other way around, without having to fork and modify pi internals. Extend it with TypeScript [Extensions](#extensions), [Skills](#skills), [Prompt Templates](#prompt-templates), and [Themes](#themes). Put your extensions, skills, prompt templates, and themes in [Pi Packages](#pi-packages) and share them with others via npm or git.\n\nPi ships with powerful defaults but skips features like sub agents and plan mode. Instead, you can ask pi to build what you want or install a third party pi package that matches your workflow.\n\nPi runs in four modes: interactive, print or JSON, RPC for process integration, and an SDK for embedding in your own apps. See [openclaw/openclaw](https://github.com/openclaw/openclaw) for a real-world SDK integration.\n\n## Table of Contents\n\n- [Quick Start](#quick-start)\n- [Providers & Models](#providers--models)\n- [Interactive Mode](#interactive-mode)\n  - [Editor](#editor)\n  - [Commands](#commands)\n  - [Keyboard Shortcuts](#keyboard-shortcuts)\n  - [Message Queue](#message-queue)\n- [Sessions](#sessions)\n  - [Branching](#branching)\n  - [Compaction](#compaction)\n- [Settings](#settings)\n- [Context Files](#context-files)\n- [Customization](#customization)\n  - [Prompt Templates](#prompt-templates)\n  - [Skills](#skills)\n  - [Extensions](#extensions)\n  - [Themes](#themes)\n  - [Pi Packages](#pi-packages)\n- [Programmatic Usage](#programmatic-usage)\n- [Philosophy](#philosophy)\n- [CLI Reference](#cli-reference)\n\n---\n\n## Quick Start\n\n```bash\nnpm install -g @mariozechner/pi-coding-agent\n```\n\nAuthenticate with an API key:\n\n```bash\nexport ANTHROPIC_API_KEY=sk-ant-...\npi\n```\n\nOr use your existing subscription:\n\n```bash\npi\n/login  # Then select provider\n```\n\nThen just talk to pi. By default, pi gives the model four tools: `read`, `write`, `edit`, and `bash`. The model uses these to fulfill your requests. Add capabilities via [skills](#skills), [prompt templates](#prompt-templates), [extensions](#extensions), or [pi packages](#pi-packages).\n\n**Platform notes:** [Windows](docs/windows.md) | [Termux (Android)](docs/termux.md) | [Terminal setup](docs/terminal-setup.md) | [Shell aliases](docs/shell-aliases.md)\n\n---\n\n## Providers & Models\n\nFor each built-in provider, pi maintains a list of tool-capable models, updated with every release. Authenticate via subscription (`/login`) or API key, then select any model from that provider via `/model` (or Ctrl+L).\n\n**Subscriptions:**\n- Anthropic Claude Pro/Max\n- OpenAI ChatGPT Plus/Pro (Codex)\n- GitHub Copilot\n- Google Gemini CLI\n- Google Antigravity\n\n**API keys:**\n- Anthropic\n- OpenAI\n- Azure OpenAI\n- Google Gemini\n- Google Vertex\n- Amazon Bedrock\n- Mistral\n- Groq\n- Cerebras\n- xAI\n- OpenRouter\n- Vercel AI Gateway\n- ZAI\n- OpenCode Zen\n- Hugging Face\n- Kimi For Coding\n- MiniMax\n\nSee [docs/providers.md](docs/providers.md) for detailed setup instructions.\n\n**Custom providers & models:** Add providers via `~/.pi/agent/models.json` if they speak a supported API (OpenAI, Anthropic, Google). For custom APIs or OAuth, use extensions. See [docs/models.md](docs/models.md) and [docs/custom-provider.md](docs/custom-provider.md).\n\n---\n\n## Interactive Mode\n\n<p align=\"center\"><img src=\"docs/images/interactive-mode.png\" alt=\"Interactive Mode\" width=\"600\"></p>\n\nThe interface from top to bottom:\n\n- **Startup header** - Shows shortcuts (`/hotkeys` for all), loaded AGENTS.md files, prompt templates, skills, and extensions\n- **Messages** - Your messages, assistant responses, tool calls and results, notifications, errors, and extension UI\n- **Editor** - Where you type; border color indicates thinking level\n- **Footer** - Working directory, session name, total token/cache usage, cost, context usage, current model\n\nThe editor can be temporarily replaced by other UI, like built-in `/settings` or custom UI from extensions (e.g., a Q&A tool that lets the user answer model questions in a structured format). [Extensions](#extensions) can also replace the editor, add widgets above/below it, a status line, custom footer, or overlays.\n\n### Editor\n\n| Feature | How |\n|---------|-----|\n| File reference | Type `@` to fuzzy-search project files |\n| Path completion | Tab to complete paths |\n| Multi-line | Shift+Enter (or Ctrl+Enter on Windows Terminal) |\n| Images | Ctrl+V to paste, or drag onto terminal |\n| Bash commands | `!command` runs and sends output to LLM, `!!command` runs without sending |\n\nStandard editing keybindings for delete word, undo, etc. See [docs/keybindings.md](docs/keybindings.md).\n\n### Commands\n\nType `/` in the editor to trigger commands. [Extensions](#extensions) can register custom commands, [skills](#skills) are available as `/skill:name`, and [prompt templates](#prompt-templates) expand via `/templatename`.\n\n| Command | Description |\n|---------|-------------|\n| `/login`, `/logout` | OAuth authentication |\n| `/model` | Switch models |\n| `/scoped-models` | Enable/disable models for Ctrl+P cycling |\n| `/settings` | Thinking level, theme, message delivery |\n| `/resume` | Pick from previous sessions |\n| `/new` | Start a new session |\n| `/name <name>` | Set session display name |\n| `/session` | Show session info (path, tokens, cost) |\n| `/tree` | Jump to any point in the session and continue from there |\n| `/fork` | Create a new session from the current branch |\n| `/compact [prompt]` | Manually compact context, optional custom instructions |\n| `/copy` | Copy last assistant message to clipboard |\n| `/export [file]` | Export session to HTML file |\n| `/share` | Upload as private GitHub gist with shareable HTML link |\n| `/reload` | Reload extensions, skills, prompts, context files (themes hot-reload automatically) |\n| `/hotkeys` | Show all keyboard shortcuts |\n| `/changelog` | Display version history |\n| `/quit`, `/exit` | Quit pi |\n\n### Keyboard Shortcuts\n\nSee `/hotkeys` for the full list. Customize via `~/.pi/agent/keybindings.json`. See [docs/keybindings.md](docs/keybindings.md).\n\n**Commonly used:**\n\n| Key | Action |\n|-----|--------|\n| Ctrl+C | Clear editor |\n| Ctrl+C twice | Quit |\n| Escape | Cancel/abort |\n| Escape twice | Open `/tree` |\n| Ctrl+L | Open model selector |\n| Ctrl+P / Shift+Ctrl+P | Cycle scoped models forward/backward |\n| Shift+Tab | Cycle thinking level |\n| Ctrl+O | Collapse/expand tool output |\n| Ctrl+T | Collapse/expand thinking blocks |\n\n### Message Queue\n\nSubmit messages while the agent is working:\n\n- **Enter** queues a *steering* message, delivered after current tool execution (interrupts remaining tools)\n- **Alt+Enter** queues a *follow-up* message, delivered only after the agent finishes all work\n- **Escape** aborts and restores queued messages to editor\n- **Alt+Up** retrieves queued messages back to editor\n\nConfigure delivery in [settings](docs/settings.md): `steeringMode` and `followUpMode` can be `\"one-at-a-time\"` (default, waits for response) or `\"all\"` (delivers all queued at once).\n\n---\n\n## Sessions\n\nSessions are stored as JSONL files with a tree structure. Each entry has an `id` and `parentId`, enabling in-place branching without creating new files. See [docs/session.md](docs/session.md) for file format.\n\n### Management\n\nSessions auto-save to `~/.pi/agent/sessions/` organized by working directory.\n\n```bash\npi -c                  # Continue most recent session\npi -r                  # Browse and select from past sessions\npi --no-session        # Ephemeral mode (don't save)\npi --session <path>    # Use specific session file or ID\n```\n\n### Branching\n\n**`/tree`** - Navigate the session tree in-place. Select any previous point, continue from there, and switch between branches. All history preserved in a single file.\n\n<p align=\"center\"><img src=\"docs/images/tree-view.png\" alt=\"Tree View\" width=\"600\"></p>\n\n- Search by typing, page with â†/â†’\n- Filter modes (Ctrl+O): default â†’ no-tools â†’ user-only â†’ labeled-only â†’ all\n- Press `l` to label entries as bookmarks\n\n**`/fork`** - Create a new session file from the current branch. Opens a selector, copies history up to the selected point, and places that message in the editor for modification.\n\n### Compaction\n\nLong sessions can exhaust context windows. Compaction summarizes older messages while keeping recent ones.\n\n**Manual:** `/compact` or `/compact <custom instructions>`\n\n**Automatic:** Enabled by default. Triggers on context overflow (recovers and retries) or when approaching the limit (proactive). Configure via `/settings` or `settings.json`.\n\nCompaction is lossy. The full history remains in the JSONL file; use `/tree` to revisit. Customize compaction behavior via [extensions](#extensions). See [docs/compaction.md](docs/compaction.md) for internals.\n\n---\n\n## Settings\n\nUse `/settings` to modify common options, or edit JSON files directly:\n\n| Location | Scope |\n|----------|-------|\n| `~/.pi/agent/settings.json` | Global (all projects) |\n| `.pi/settings.json` | Project (overrides global) |\n\nSee [docs/settings.md](docs/settings.md) for all options.\n\n---\n\n## Context Files\n\nPi loads `AGENTS.md` (or `CLAUDE.md`) at startup from:\n- `~/.pi/agent/AGENTS.md` (global)\n- Parent directories (walking up from cwd)\n- Current directory\n\nUse for project instructions, conventions, common commands. All matching files are concatenated.\n\n### System Prompt\n\nReplace the default system prompt with `.pi/SYSTEM.md` (project) or `~/.pi/agent/SYSTEM.md` (global). Append without replacing via `APPEND_SYSTEM.md`.\n\n---\n\n## Customization\n\n### Prompt Templates\n\nReusable prompts as Markdown files. Type `/name` to expand.\n\n```markdown\n<!-- ~/.pi/agent/prompts/review.md -->\nReview this code for bugs, security issues, and performance problems.\nFocus on: {{focus}}\n```\n\nPlace in `~/.pi/agent/prompts/`, `.pi/prompts/`, or a [pi package](#pi-packages) to share with others. See [docs/prompt-templates.md](docs/prompt-templates.md).\n\n### Skills\n\nOn-demand capability packages following the [Agent Skills standard](https://agentskills.io). Invoke via `/skill:name` or let the agent load them automatically.\n\n```markdown\n<!-- ~/.pi/agent/skills/my-skill/SKILL.md -->\n# My Skill\nUse this skill when the user asks about X.\n\n## Steps\n1. Do this\n2. Then that\n```\n\nPlace in `~/.pi/agent/skills/`, `.pi/skills/`, or a [pi package](#pi-packages) to share with others. See [docs/skills.md](docs/skills.md).\n\n### Extensions\n\n<p align=\"center\"><img src=\"docs/images/doom-extension.png\" alt=\"Doom Extension\" width=\"600\"></p>\n\nTypeScript modules that extend pi with custom tools, commands, keyboard shortcuts, event handlers, and UI components.\n\n```typescript\nexport default function (pi: ExtensionAPI) {\n  pi.registerTool({ name: \"deploy\", ... });\n  pi.registerCommand(\"stats\", { ... });\n  pi.on(\"tool_call\", async (event, ctx) => { ... });\n}\n```\n\n**What's possible:**\n- Custom tools (or replace built-in tools entirely)\n- Sub-agents and plan mode\n- Custom compaction and summarization\n- Permission gates and path protection\n- Custom editors and UI components\n- Status lines, headers, footers\n- Git checkpointing and auto-commit\n- SSH and sandbox execution\n- MCP server integration\n- Make pi look like Claude Code\n- Games while waiting (yes, Doom runs)\n- ...anything you can dream up\n\nPlace in `~/.pi/agent/extensions/`, `.pi/extensions/`, or a [pi package](#pi-packages) to share with others. See [docs/extensions.md](docs/extensions.md) and [examples/extensions/](examples/extensions/).\n\n### Themes\n\nBuilt-in: `dark`, `light`. Themes hot-reload: modify the active theme file and pi immediately applies changes.\n\nPlace in `~/.pi/agent/themes/`, `.pi/themes/`, or a [pi package](#pi-packages) to share with others. See [docs/themes.md](docs/themes.md).\n\n### Pi Packages\n\nBundle and share extensions, skills, prompts, and themes via npm or git. Find packages on [npmjs.com](https://www.npmjs.com/search?q=keywords%3Api-package) or [Discord](https://discord.com/channels/1456806362351669492/1457744485428629628).\n\n> **Security:** Pi packages run with full system access. Extensions execute arbitrary code, and skills can instruct the model to perform any action including running executables. Review source code before installing third-party packages.\n\n```bash\npi install npm:@foo/pi-tools\npi install npm:@foo/pi-tools@1.2.3      # pinned version\npi install git:github.com/user/repo\npi install git:github.com/user/repo@v1  # tag or commit\npi install https://github.com/user/repo\npi remove npm:@foo/pi-tools\npi list\npi update                               # skips pinned packages\npi config                               # enable/disable extensions, skills, prompts, themes\n```\n\nPackages install to `~/.pi/agent/git/` (git) or global npm. Use `-l` for project-local installs (`.pi/git/`, `.pi/npm/`).\n\nCreate a package by adding a `pi` key to `package.json`:\n\n```json\n{\n  \"name\": \"my-pi-package\",\n  \"keywords\": [\"pi-package\"],\n  \"pi\": {\n    \"extensions\": [\"./extensions\"],\n    \"skills\": [\"./skills\"],\n    \"prompts\": [\"./prompts\"],\n    \"themes\": [\"./themes\"]\n  }\n}\n```\n\nWithout a `pi` manifest, pi auto-discovers from conventional directories (`extensions/`, `skills/`, `prompts/`, `themes/`).\n\nSee [docs/packages.md](docs/packages.md).\n\n---\n\n## Programmatic Usage\n\n### SDK\n\n```typescript\nimport { AuthStorage, createAgentSession, ModelRegistry, SessionManager } from \"@mariozechner/pi-coding-agent\";\n\nconst { session } = await createAgentSession({\n  sessionManager: SessionManager.inMemory(),\n  authStorage: new AuthStorage(),\n  modelRegistry: new ModelRegistry(authStorage),\n});\n\nawait session.prompt(\"What files are in the current directory?\");\n```\n\nSee [docs/sdk.md](docs/sdk.md) and [examples/sdk/](examples/sdk/).\n\n### RPC Mode\n\nFor non-Node.js integrations, use RPC mode over stdin/stdout:\n\n```bash\npi --mode rpc\n```\n\nSee [docs/rpc.md](docs/rpc.md) for the protocol.\n\n---\n\n## Philosophy\n\nPi is aggressively extensible so it doesn't have to dictate your workflow. Features that other tools bake in can be built with [extensions](#extensions), [skills](#skills), or installed from third-party [pi packages](#pi-packages). This keeps the core minimal while letting you shape pi to fit how you work.\n\n**No MCP.** Build CLI tools with READMEs (see [Skills](#skills)), or build an extension that adds MCP support. [Why?](https://mariozechner.at/posts/2025-11-02-what-if-you-dont-need-mcp/)\n\n**No sub-agents.** There's many ways to do this. Spawn pi instances via tmux, or build your own with [extensions](#extensions), or install a package that does it your way.\n\n**No permission popups.** Run in a container, or build your own confirmation flow with [extensions](#extensions) inline with your environment and security requirements.\n\n**No plan mode.** Write plans to files, or build it with [extensions](#extensions), or install a package.\n\n**No built-in to-dos.** They confuse models. Use a TODO.md file, or build your own with [extensions](#extensions).\n\n**No background bash.** Use tmux. Full observability, direct interaction.\n\nRead the [blog post](https://mariozechner.at/posts/2025-11-30-pi-coding-agent/) for the full rationale.\n\n---\n\n## CLI Reference\n\n```bash\npi [options] [@files...] [messages...]\n```\n\n### Package Commands\n\n```bash\npi install <source> [-l]    # Install package, -l for project-local\npi remove <source> [-l]     # Remove package\npi update [source]          # Update packages (skips pinned)\npi list                     # List installed packages\npi config                   # Enable/disable package resources\n```\n\n### Modes\n\n| Flag | Description |\n|------|-------------|\n| (default) | Interactive mode |\n| `-p`, `--print` | Print response and exit |\n| `--mode json` | Output all events as JSON lines (see [docs/json.md](docs/json.md)) |\n| `--mode rpc` | RPC mode for process integration (see [docs/rpc.md](docs/rpc.md)) |\n| `--export <in> [out]` | Export session to HTML |\n\n### Model Options\n\n| Option | Description |\n|--------|-------------|\n| `--provider <name>` | Provider (anthropic, openai, google, etc.) |\n| `--model <id>` | Model ID |\n| `--api-key <key>` | API key (overrides env vars) |\n| `--thinking <level>` | `off`, `minimal`, `low`, `medium`, `high`, `xhigh` |\n| `--models <patterns>` | Comma-separated patterns for Ctrl+P cycling |\n| `--list-models [search]` | List available models |\n\n### Session Options\n\n| Option | Description |\n|--------|-------------|\n| `-c`, `--continue` | Continue most recent session |\n| `-r`, `--resume` | Browse and select session |\n| `--session <path>` | Use specific session file or partial UUID |\n| `--session-dir <dir>` | Custom session storage directory |\n| `--no-session` | Ephemeral mode (don't save) |\n\n### Tool Options\n\n| Option | Description |\n|--------|-------------|\n| `--tools <list>` | Enable specific built-in tools (default: `read,bash,edit,write`) |\n| `--no-tools` | Disable all built-in tools (extension tools still work) |\n\nAvailable built-in tools: `read`, `bash`, `edit`, `write`, `grep`, `find`, `ls`\n\n### Resource Options\n\n| Option | Description |\n|--------|-------------|\n| `-e`, `--extension <source>` | Load extension from path, npm, or git (repeatable) |\n| `--no-extensions` | Disable extension discovery |\n| `--skill <path>` | Load skill (repeatable) |\n| `--no-skills` | Disable skill discovery |\n| `--prompt-template <path>` | Load prompt template (repeatable) |\n| `--no-prompt-templates` | Disable prompt template discovery |\n| `--theme <path>` | Load theme (repeatable) |\n| `--no-themes` | Disable theme discovery |\n\nCombine `--no-*` with explicit flags to load exactly what you need, ignoring settings.json (e.g., `--no-extensions -e ./my-ext.ts`).\n\n### Other Options\n\n| Option | Description |\n|--------|-------------|\n| `--system-prompt <text>` | Replace default prompt (context files and skills still appended) |\n| `--append-system-prompt <text>` | Append to system prompt |\n| `--verbose` | Force verbose startup |\n| `-h`, `--help` | Show help |\n| `-v`, `--version` | Show version |\n\n### File Arguments\n\nPrefix files with `@` to include in the message:\n\n```bash\npi @prompt.md \"Answer this\"\npi -p @screenshot.png \"What's in this image?\"\npi @code.ts @test.ts \"Review these files\"\n```\n\n### Examples\n\n```bash\n# Interactive with initial prompt\npi \"List all .ts files in src/\"\n\n# Non-interactive\npi -p \"Summarize this codebase\"\n\n# Different model\npi --provider openai --model gpt-4o \"Help me refactor\"\n\n# Limit model cycling\npi --models \"claude-*,gpt-4o\"\n\n# Read-only mode\npi --tools read,grep,find,ls -p \"Review the code\"\n\n# High thinking level\npi --thinking high \"Solve this complex problem\"\n```\n\n### Environment Variables\n\n| Variable | Description |\n|----------|-------------|\n| `PI_CODING_AGENT_DIR` | Override config directory (default: `~/.pi/agent`) |\n| `PI_PACKAGE_DIR` | Override package directory (useful for Nix/Guix where store paths tokenize poorly) |\n| `PI_SKIP_VERSION_CHECK` | Skip version check at startup |\n| `PI_CACHE_RETENTION` | Set to `long` for extended prompt cache (Anthropic: 1h, OpenAI: 24h) |\n| `VISUAL`, `EDITOR` | External editor for Ctrl+G |\n\n---\n\n## Contributing & Development\n\nSee [CONTRIBUTING.md](../../CONTRIBUTING.md) for guidelines and [docs/development.md](docs/development.md) for setup, forking, and debugging.\n\n---\n\n## License\n\nMIT\n\n## See Also\n\n- [@mariozechner/pi-ai](https://www.npmjs.com/package/@mariozechner/pi-ai): Core LLM toolkit\n- [@mariozechner/pi-agent](https://www.npmjs.com/package/@mariozechner/pi-agent): Agent framework\n- [@mariozechner/pi-tui](https://www.npmjs.com/package/@mariozechner/pi-tui): Terminal UI components\n"}],"isError":false,"timestamp":1771589583743}}
{"type":"message","id":"1e879f21","parentId":"ed9365c5","timestamp":"2026-02-20T12:13:07.563Z","message":{"role":"assistant","content":[{"type":"toolCall","id":"toolu_01GcAiEaF7FBVgvjqzg3je4a","name":"bash","arguments":{"command":"ls /home/runner/work/gitclaw/gitclaw/.GITCLAW/node_modules/@mariozechner/pi-coding-agent/docs/ | head -40"}}],"api":"anthropic-messages","provider":"anthropic","model":"claude-opus-4-6","usage":{"input":1,"output":92,"cacheRead":23290,"cacheWrite":6065,"totalTokens":29448,"cost":{"input":0.000005,"output":0.0023,"cacheRead":0.011644999999999999,"cacheWrite":0.03790625,"total":0.05185625}},"stopReason":"toolUse","timestamp":1771589583744}}
{"type":"message","id":"026fd924","parentId":"1e879f21","timestamp":"2026-02-20T12:13:07.568Z","message":{"role":"toolResult","toolCallId":"toolu_01GcAiEaF7FBVgvjqzg3je4a","toolName":"bash","content":[{"type":"text","text":"compaction.md\ncustom-provider.md\ndevelopment.md\nextensions.md\nimages\njson.md\nkeybindings.md\nmodels.md\npackages.md\nprompt-templates.md\nproviders.md\nrpc.md\nsdk.md\nsession.md\nsettings.md\nshell-aliases.md\nskills.md\nterminal-setup.md\ntermux.md\nthemes.md\ntree.md\ntui.md\nwindows.md\n"}],"isError":false,"timestamp":1771589587567}}
{"type":"message","id":"1cb6e7a4","parentId":"026fd924","timestamp":"2026-02-20T12:13:12.393Z","message":{"role":"assistant","content":[{"type":"toolCall","id":"toolu_017iUrXMiUw9LTGh4eZv9p2M","name":"read","arguments":{"path":"/home/runner/work/gitclaw/gitclaw/.GITCLAW/node_modules/@mariozechner/pi-coding-agent/docs/extensions.md","limit":80}},{"type":"toolCall","id":"toolu_01FYdpQxZZgemkAjvuRkD6uU","name":"read","arguments":{"path":"/home/runner/work/gitclaw/gitclaw/.GITCLAW/node_modules/@mariozechner/pi-coding-agent/docs/sdk.md","limit":60}},{"type":"toolCall","id":"toolu_01EgF3nBXadtP9h3D7fbqfb4","name":"read","arguments":{"path":"/home/runner/work/gitclaw/gitclaw/.GITCLAW/node_modules/@mariozechner/pi-coding-agent/docs/skills.md","limit":60}}],"api":"anthropic-messages","provider":"anthropic","model":"claude-opus-4-6","usage":{"input":1,"output":287,"cacheRead":29355,"cacheWrite":209,"totalTokens":29852,"cost":{"input":0.000005,"output":0.007175,"cacheRead":0.0146775,"cacheWrite":0.0013062500000000001,"total":0.023163749999999997}},"stopReason":"toolUse","timestamp":1771589587568}}
{"type":"message","id":"37079842","parentId":"1cb6e7a4","timestamp":"2026-02-20T12:13:12.395Z","message":{"role":"toolResult","toolCallId":"toolu_017iUrXMiUw9LTGh4eZv9p2M","toolName":"read","content":[{"type":"text","text":"> pi can create extensions. Ask it to build one for your use case.\n\n# Extensions\n\nExtensions are TypeScript modules that extend pi's behavior. They can subscribe to lifecycle events, register custom tools callable by the LLM, add commands, and more.\n\n> **Placement for /reload:** Put extensions in `~/.pi/agent/extensions/` (global) or `.pi/extensions/` (project-local) for auto-discovery. Use `pi -e ./path.ts` only for quick tests. Extensions in auto-discovered locations can be hot-reloaded with `/reload`.\n\n**Key capabilities:**\n- **Custom tools** - Register tools the LLM can call via `pi.registerTool()`\n- **Event interception** - Block or modify tool calls, inject context, customize compaction\n- **User interaction** - Prompt users via `ctx.ui` (select, confirm, input, notify)\n- **Custom UI components** - Full TUI components with keyboard input via `ctx.ui.custom()` for complex interactions\n- **Custom commands** - Register commands like `/mycommand` via `pi.registerCommand()`\n- **Session persistence** - Store state that survives restarts via `pi.appendEntry()`\n- **Custom rendering** - Control how tool calls/results and messages appear in TUI\n\n**Example use cases:**\n- Permission gates (confirm before `rm -rf`, `sudo`, etc.)\n- Git checkpointing (stash at each turn, restore on branch)\n- Path protection (block writes to `.env`, `node_modules/`)\n- Custom compaction (summarize conversation your way)\n- Conversation summaries (see `summarize.ts` example)\n- Interactive tools (questions, wizards, custom dialogs)\n- Stateful tools (todo lists, connection pools)\n- External integrations (file watchers, webhooks, CI triggers)\n- Games while you wait (see `snake.ts` example)\n\nSee [examples/extensions/](../examples/extensions/) for working implementations.\n\n## Table of Contents\n\n- [Quick Start](#quick-start)\n- [Extension Locations](#extension-locations)\n- [Available Imports](#available-imports)\n- [Writing an Extension](#writing-an-extension)\n  - [Extension Styles](#extension-styles)\n- [Events](#events)\n  - [Lifecycle Overview](#lifecycle-overview)\n  - [Session Events](#session-events)\n  - [Agent Events](#agent-events)\n  - [Tool Events](#tool-events)\n- [ExtensionContext](#extensioncontext)\n- [ExtensionCommandContext](#extensioncommandcontext)\n- [ExtensionAPI Methods](#extensionapi-methods)\n- [State Management](#state-management)\n- [Custom Tools](#custom-tools)\n- [Custom UI](#custom-ui)\n- [Error Handling](#error-handling)\n- [Mode Behavior](#mode-behavior)\n- [Examples Reference](#examples-reference)\n\n## Quick Start\n\nCreate `~/.pi/agent/extensions/my-extension.ts`:\n\n```typescript\nimport type { ExtensionAPI } from \"@mariozechner/pi-coding-agent\";\nimport { Type } from \"@sinclair/typebox\";\n\nexport default function (pi: ExtensionAPI) {\n  // React to events\n  pi.on(\"session_start\", async (_event, ctx) => {\n    ctx.ui.notify(\"Extension loaded!\", \"info\");\n  });\n\n  pi.on(\"tool_call\", async (event, ctx) => {\n    if (event.toolName === \"bash\" && event.input.command?.includes(\"rm -rf\")) {\n      const ok = await ctx.ui.confirm(\"Dangerous!\", \"Allow rm -rf?\");\n      if (!ok) return { block: true, reason: \"Blocked by user\" };\n    }\n  });\n\n  // Register a custom tool\n  pi.registerTool({\n    name: \"greet\",\n    label: \"Greet\",\n    description: \"Greet someone by name\",\n    parameters: Type.Object({\n      name: Type.String({ description: \"Name to greet\" }),\n\n[1748 more lines in file. Use offset=81 to continue.]"}],"isError":false,"timestamp":1771589592395}}
{"type":"message","id":"5e09c70d","parentId":"37079842","timestamp":"2026-02-20T12:13:12.396Z","message":{"role":"toolResult","toolCallId":"toolu_01FYdpQxZZgemkAjvuRkD6uU","toolName":"read","content":[{"type":"text","text":"> pi can help you use the SDK. Ask it to build an integration for your use case.\n\n# SDK\n\nThe SDK provides programmatic access to pi's agent capabilities. Use it to embed pi in other applications, build custom interfaces, or integrate with automated workflows.\n\n**Example use cases:**\n- Build a custom UI (web, desktop, mobile)\n- Integrate agent capabilities into existing applications\n- Create automated pipelines with agent reasoning\n- Build custom tools that spawn sub-agents\n- Test agent behavior programmatically\n\nSee [examples/sdk/](../examples/sdk/) for working examples from minimal to full control.\n\n## Quick Start\n\n```typescript\nimport { AuthStorage, createAgentSession, ModelRegistry, SessionManager } from \"@mariozechner/pi-coding-agent\";\n\n// Set up credential storage and model registry\nconst authStorage = new AuthStorage();\nconst modelRegistry = new ModelRegistry(authStorage);\n\nconst { session } = await createAgentSession({\n  sessionManager: SessionManager.inMemory(),\n  authStorage,\n  modelRegistry,\n});\n\nsession.subscribe((event) => {\n  if (event.type === \"message_update\" && event.assistantMessageEvent.type === \"text_delta\") {\n    process.stdout.write(event.assistantMessageEvent.delta);\n  }\n});\n\nawait session.prompt(\"What files are in the current directory?\");\n```\n\n## Installation\n\n```bash\nnpm install @mariozechner/pi-coding-agent\n```\n\nThe SDK is included in the main package. No separate installation needed.\n\n## Core Concepts\n\n### createAgentSession()\n\nThe main factory function. Creates an `AgentSession` with configurable options.\n\n`createAgentSession()` uses a `ResourceLoader` to supply extensions, skills, prompt templates, themes, and context files. If you do not provide one, it uses `DefaultResourceLoader` with standard discovery.\n\n```typescript\nimport { createAgentSession } from \"@mariozechner/pi-coding-agent\";\n\n// Minimal: defaults with DefaultResourceLoader\nconst { session } = await createAgentSession();\n\n[898 more lines in file. Use offset=61 to continue.]"}],"isError":false,"timestamp":1771589592396}}
{"type":"message","id":"4a344c9d","parentId":"5e09c70d","timestamp":"2026-02-20T12:13:12.398Z","message":{"role":"toolResult","toolCallId":"toolu_01EgF3nBXadtP9h3D7fbqfb4","toolName":"read","content":[{"type":"text","text":"> pi can create skills. Ask it to build one for your use case.\n\n# Skills\n\nSkills are self-contained capability packages that the agent loads on-demand. A skill provides specialized workflows, setup instructions, helper scripts, and reference documentation for specific tasks.\n\nPi implements the [Agent Skills standard](https://agentskills.io/specification), warning about violations but remaining lenient.\n\n## Table of Contents\n\n- [Locations](#locations)\n- [How Skills Work](#how-skills-work)\n- [Skill Commands](#skill-commands)\n- [Skill Structure](#skill-structure)\n- [Frontmatter](#frontmatter)\n- [Validation](#validation)\n- [Example](#example)\n- [Skill Repositories](#skill-repositories)\n\n## Locations\n\n> **Security:** Skills can instruct the model to perform any action and may include executable code the model invokes. Review skill content before use.\n\nPi loads skills from:\n\n- Global: `~/.pi/agent/skills/`\n- Project: `.pi/skills/`\n- Packages: `skills/` directories or `pi.skills` entries in `package.json`\n- Settings: `skills` array with files or directories\n- CLI: `--skill <path>` (repeatable, additive even with `--no-skills`)\n\nDiscovery rules:\n- Direct `.md` files in the skills directory root\n- Recursive `SKILL.md` files under subdirectories\n\nDisable discovery with `--no-skills` (explicit `--skill` paths still load).\n\n### Using Skills from Other Harnesses\n\nTo use skills from Claude Code or OpenAI Codex, add their directories to settings:\n\n```json\n{\n  \"skills\": [\n    \"~/.claude/skills\",\n    \"~/.codex/skills\"\n  ]\n}\n```\n\nFor project-level Claude Code skills, add to `.pi/settings.json`:\n\n```json\n{\n  \"skills\": [\"../.claude/skills\"]\n}\n```\n\n## How Skills Work\n\n\n[168 more lines in file. Use offset=61 to continue.]"}],"isError":false,"timestamp":1771589592397}}
{"type":"message","id":"f6070a22","parentId":"4a344c9d","timestamp":"2026-02-20T12:14:35.397Z","message":{"role":"assistant","content":[{"type":"text","text":"Now I have a thorough understanding of both `.GITCLAW` and `pi`. Let me craft this."},{"type":"toolCall","id":"toolu_01Tmqx2yrUekd2AjBsf7jBet","name":"write","arguments":{"path":".GITCLAW/docs/GITCLAW-Loves-Pi.md","content":"# .GITCLAW ðŸ¦ž Loves Pi ðŸ¥§\n\n### How a minimal terminal coding agent became the engine of something extraordinary\n\n<p align=\"center\">\n  <picture>\n    <img src=\"https://raw.githubusercontent.com/japer-technology/gitclaw/main/.GITCLAW/GITCLAW-LOGO.png\" alt=\"GitClaw\" width=\"500\">\n  </picture>\n</p>\n\n---\n\n## What Is Pi?\n\n[Pi](https://github.com/badlogic/pi-mono) is a minimal terminal coding harness created by [Mario Zechner](https://github.com/badlogic). That sentence undersells it by an order of magnitude.\n\nPi is what happens when someone looks at the entire landscape of AI coding agents â€” the bloated SaaS platforms, the framework-of-the-week churn, the opinionated monoliths that insist you work *their* way â€” and says: **no**. What if the agent was small, composable, radically extensible, and got out of your way?\n\nThe result is a tool that ships with exactly four built-in tools (`read`, `write`, `edit`, `bash`) and an extension system so powerful that *everything else* â€” sub-agents, plan mode, permission gates, MCP support, custom compaction, even Doom â€” can be built on top without touching pi's internals.\n\nPi doesn't have features. It has *the ability to grow any feature you need*.\n\n---\n\n## The Architecture of Restraint\n\nMost agent frameworks are additive: they start with everything and let you turn things off. Pi is subtractive: it starts with almost nothing and lets you build up.\n\n### The Core\n\nAt its heart, pi is a conversation loop. You talk to an LLM. The LLM can call tools. Tools produce results. The cycle continues. Sessions are saved as JSONL files with a tree structure â€” every message has an `id` and `parentId`, enabling in-place branching without creating new files.\n\nThat's it. That's the core.\n\n### The Extension Points\n\nEverything else is plugged in through four orthogonal systems:\n\n| System | What It Does | How It's Shared |\n|--------|-------------|-----------------|\n| **Extensions** | TypeScript modules that add tools, commands, keyboard shortcuts, event handlers, and full TUI components | npm or git via Pi Packages |\n| **Skills** | On-demand capability packages following the [Agent Skills standard](https://agentskills.io) â€” specialized workflows as Markdown files | npm or git via Pi Packages |\n| **Prompt Templates** | Reusable prompts with variable interpolation, invoked via `/name` | npm or git via Pi Packages |\n| **Themes** | Visual customization of the terminal UI, with hot-reload | npm or git via Pi Packages |\n\nThe pattern is consistent: define a thing as a file, put it in the right directory, and pi discovers it. Bundle multiple things into a Pi Package and share it with the world via `pi install`.\n\n### What Pi Deliberately Doesn't Have\n\nThis is the part that reveals the philosophy:\n\n- **No MCP.** Build a CLI tool with a README, or write an extension that adds MCP support.\n- **No sub-agents.** Spawn pi instances via tmux, or build your own orchestration with extensions.\n- **No permission popups.** Run in a container, or build your own confirmation flow.\n- **No plan mode.** Write plans to files, or build it with extensions.\n- **No built-in to-dos.** They confuse models. Use a `TODO.md` file.\n- **No background bash.** Use tmux. Full observability, direct interaction.\n\nEvery missing feature is a *design decision*. Pi trusts you to know what you need and gives you the tools to build it yourself. The agent adapts to your workflow â€” not the other way around.\n\n---\n\n## The Four Modes\n\nPi runs in four modes, each serving a different integration pattern:\n\n| Mode | Use Case |\n|------|----------|\n| **Interactive** | You sit at a terminal and have a conversation. Full TUI with editor, message history, model switching, session branching. |\n| **Print / JSON** | One-shot: send a prompt, get a response, exit. JSON mode emits structured events as JSONL â€” perfect for piping into other tools. |\n| **RPC** | Stdin/stdout protocol for non-Node.js integrations. Speak JSON, get JSON back. |\n| **SDK** | Embed pi directly in your TypeScript application. Full programmatic control over sessions, tools, events, and rendering. |\n\n**GitClaw uses JSON mode and the SDK.** The lifecycle orchestrator (`GITCLAW-AGENT.ts`) spawns pi with `--mode json`, streams structured events, extracts the final assistant response, and posts it back to the GitHub issue. The full power of pi â€” tool calling, session management, thinking levels â€” is available through a clean, parseable interface.\n\n---\n\n## Why Pi Is Perfect for GitClaw\n\nGitClaw needed an agent engine with very specific properties:\n\n### 1. Session Persistence That Just Works\n\nPi stores sessions as JSONL files. GitClaw stores those files in git. The combination gives the agent persistent memory across workflow runs without a database, a cache, or any external service. When a user comments on issue #42 three weeks later, GitClaw loads the session file from `state/sessions/`, passes it to pi via `--session`, and the conversation continues seamlessly.\n\nPi's session model wasn't designed for GitClaw â€” but it fits like it was.\n\n### 2. Headless Execution\n\nPi doesn't assume a human is sitting at a terminal. JSON mode and the SDK emit structured events that any consumer can process. GitClaw runs in a GitHub Actions runner with no TTY, no keyboard, no screen. Pi doesn't care. It produces the same quality output whether you're watching it think in real-time or capturing its output in a CI log.\n\n### 3. Provider Agnosticism\n\nPi supports a staggering number of LLM providers out of the box:\n\n- Anthropic (Claude)\n- OpenAI (GPT, Codex)\n- Google (Gemini)\n- xAI (Grok)\n- DeepSeek (via OpenRouter)\n- Mistral\n- Groq\n- Cerebras\n- Amazon Bedrock\n- Azure OpenAI\n- Google Vertex\n- Hugging Face\n- ...and any OpenAI/Anthropic/Google-compatible API via custom provider config\n\nGitClaw inherits all of this for free. Change a line in `.pi/settings.json` and your repo's agent switches from Claude to Gemini to Grok without touching a single workflow file. The agent is model-agnostic because pi is model-agnostic.\n\n### 4. The Skill System\n\nPi's skill system is the natural extension point for GitClaw's capabilities. Each skill is a self-contained Markdown file â€” instructions, workflows, and context that the agent loads on demand. GitClaw can ship skills for code review, release notes, triage, security scanning, and anything else, all as simple Markdown files in `.pi/skills/`.\n\nSkills follow the [Agent Skills standard](https://agentskills.io), which means skills written for pi work in other harnesses too â€” and vice versa. It's an open ecosystem, not a walled garden.\n\n### 5. Extensibility Without Forking\n\nThe extension system means GitClaw can customize pi's behavior deeply â€” custom tools, event interception, state management, custom compaction â€” without maintaining a fork. When pi releases a new version, GitClaw picks it up. When GitClaw needs a new capability, it writes an extension. The boundary is clean.\n\n---\n\n## The Extension System (The Crown Jewel)\n\nPi's extension system deserves its own section because it's genuinely remarkable in its scope.\n\nAn extension is a TypeScript file that receives an `ExtensionAPI` object and can do *anything*:\n\n```typescript\nexport default function (pi: ExtensionAPI) {\n  // Register a tool the LLM can call\n  pi.registerTool({ name: \"deploy\", ... });\n\n  // Register a command the user can invoke\n  pi.registerCommand(\"stats\", { ... });\n\n  // Intercept tool calls before they execute\n  pi.on(\"tool_call\", async (event, ctx) => {\n    if (isDangerous(event)) return { block: true, reason: \"Nope\" };\n  });\n\n  // React to lifecycle events\n  pi.on(\"session_start\", async (_event, ctx) => { ... });\n\n  // Store persistent state in the session\n  pi.appendEntry({ type: \"custom\", data: myState });\n}\n```\n\nExtensions can:\n\n- **Add custom tools** â€” or replace built-in tools entirely\n- **Intercept and modify tool calls** â€” permission gates, logging, sandboxing\n- **Customize compaction** â€” control how long conversations get summarized\n- **Build full TUI components** â€” custom editors, overlays, status lines, interactive dialogs\n- **Manage persistent state** â€” entries survive session restarts\n- **Register keyboard shortcuts** â€” integrate into the interactive workflow\n- **Render custom content** â€” control how tool calls and results display\n\nThe examples directory includes extensions for git checkpointing, path protection, conversation summarization, interactive Q&A tools, and yes â€” Snake and Doom running inside the terminal while you wait for the agent to think.\n\nThis isn't a plugin system. It's a *platform*.\n\n---\n\n## The Session Tree (Branching Without Branches)\n\nOne of pi's most elegant design choices is session branching. Every message in a session has an `id` and `parentId`, forming a tree structure â€” all in a single JSONL file. You can:\n\n- **`/tree`** â€” Navigate the full session tree visually, jump to any point, and continue from there\n- **`/fork`** â€” Create a new session file from any branch point\n- **`/compact`** â€” Summarize older messages while keeping recent ones, with full history preserved for revisiting\n\nFor GitClaw, this means a single issue's conversation can have implicit branches â€” the agent explored one approach, the user asked it to try another, and both paths are preserved in the session file. Git versioning adds another layer: you can see how the session evolved over time via `git log`.\n\n---\n\n## Compaction (Infinite Conversations)\n\nLong conversations eventually exhaust context windows. Pi handles this with compaction â€” a summarization pass that condenses older messages while keeping recent ones verbatim.\n\nCompaction can be:\n- **Manual** â€” invoke with `/compact` or `/compact <custom instructions>`\n- **Automatic** â€” triggers on context overflow (recovers and retries) or proactively when approaching the limit\n\nThe full uncompacted history remains in the JSONL file. Compaction is lossy for the LLM's context but lossless for the human record.\n\nFor GitClaw, automatic compaction means conversations can span weeks or months without hitting context limits. The agent gracefully compresses its earlier memories while retaining full access to recent context.\n\n---\n\n## The Numbers\n\nA quick snapshot of pi's reach:\n\n| Dimension | Scope |\n|-----------|-------|\n| **Built-in providers** | 17+ (Anthropic, OpenAI, Google, xAI, Mistral, Groq, Bedrock, Vertex, OpenRouter, and more) |\n| **Authentication** | API keys *and* OAuth subscriptions (Claude Pro/Max, ChatGPT Plus/Pro, Copilot, Gemini CLI) |\n| **Built-in tools** | 7 (`read`, `write`, `edit`, `bash`, `grep`, `find`, `ls`) â€” selectable per session |\n| **Extension capabilities** | Tools, commands, keyboard shortcuts, event handlers, TUI components, state management, custom rendering |\n| **Skill standard** | [agentskills.io](https://agentskills.io) â€” interoperable across harnesses |\n| **Session format** | Tree-structured JSONL with branching, compaction, and full history preservation |\n| **Package ecosystem** | npm and git-based installation, sharing, and versioning |\n\n---\n\n## What This Means for GitClaw\n\nGitClaw's ambition is to be an AI agent that participates in every layer of the GitHub platform â€” issues, pull requests, reviews, checks, releases, security scanning, project management. That's a lot of surface area.\n\nPi makes this tractable because:\n\n1. **New capabilities are skills and extensions**, not core changes. Adding PR review support means writing a skill file and maybe an extension â€” not rewriting the agent.\n2. **Provider flexibility** means teams aren't locked in. Use Claude for complex reasoning, GPT for speed, Gemini for cost optimization â€” switch with a config change.\n3. **Session persistence is a solved problem.** Pi's JSONL sessions + GitClaw's git storage = durable, auditable, resumable conversations with zero operational overhead.\n4. **The SDK enables deeper integration** when JSON mode isn't enough. Future GitClaw features can embed pi sessions programmatically, spawn sub-agents, or build custom tool orchestration.\n5. **The community compounds.** Every pi extension, skill, prompt template, and theme is potentially useful to GitClaw â€” and vice versa. The ecosystem grows in both directions.\n\n---\n\n## The Philosophy Match\n\nPi's philosophy is: *adapt the agent to your workflow, not the other way around.*\n\nGitClaw's philosophy is: *the repository is the platform, and the agent lives inside it.*\n\nThese two ideas are deeply complementary. Pi provides the engine â€” minimal, extensible, provider-agnostic. GitClaw provides the chassis â€” git-native state, issue-driven conversation, zero-infrastructure deployment. Together, they prove that a powerful AI coding agent doesn't need a server farm, a subscription dashboard, or a venture-backed startup behind it.\n\nIt just needs a folder, a conversation, and a good foundation to build on.\n\nPi is that foundation.\n\n---\n\n## Links\n\n- **Pi repository:** [github.com/badlogic/pi-mono](https://github.com/badlogic/pi-mono)\n- **Pi on npm:** [@mariozechner/pi-coding-agent](https://www.npmjs.com/package/@mariozechner/pi-coding-agent)\n- **Agent Skills standard:** [agentskills.io](https://agentskills.io)\n- **Pi blog post:** [mariozechner.at/posts/2025-11-30-pi-coding-agent](https://mariozechner.at/posts/2025-11-30-pi-coding-agent/)\n- **GitClaw README:** [README.md](../README.md)\n- **GitClaw Possibilities:** [GITCLAW-Possibilities.md](GITCLAW-Possibilities.md)\n\n---\n\n*GitClaw is the claw. Pi is the muscle behind it.* ðŸ¦žðŸ¥§\n"}}],"api":"anthropic-messages","provider":"anthropic","model":"claude-opus-4-6","usage":{"input":1,"output":3590,"cacheRead":29564,"cacheWrite":2295,"totalTokens":35450,"cost":{"input":0.000005,"output":0.08975000000000001,"cacheRead":0.014782,"cacheWrite":0.01434375,"total":0.11888075000000002}},"stopReason":"toolUse","timestamp":1771589592398}}
{"type":"message","id":"1e040e1e","parentId":"f6070a22","timestamp":"2026-02-20T12:14:35.399Z","message":{"role":"toolResult","toolCallId":"toolu_01Tmqx2yrUekd2AjBsf7jBet","toolName":"write","content":[{"type":"text","text":"Successfully wrote 13454 bytes to .GITCLAW/docs/GITCLAW-Loves-Pi.md"}],"isError":false,"timestamp":1771589675398}}
{"type":"message","id":"bd0bda6f","parentId":"1e040e1e","timestamp":"2026-02-20T12:14:40.829Z","message":{"role":"assistant","content":[{"type":"text","text":"Created `.GITCLAW/docs/GITCLAW-Loves-Pi.md` â€” a deep-dive love letter to pi covering:\n\n- **What pi is** â€” the minimal terminal coding harness philosophy\n- **The architecture of restraint** â€” four tools, four extension points, deliberate omissions as design decisions\n- **The four modes** â€” interactive, print/JSON, RPC, SDK â€” and how GitClaw uses JSON mode\n- **Why pi is perfect for GitClaw** â€” session persistence, headless execution, provider agnosticism, the skill system, and extensibility without forking\n- **The extension system** â€” tools, event interception, TUI components, state management (including the Doom mention, because it deserves it)\n- **Session trees and compaction** â€” branching without branches, infinite conversations\n- **The philosophy match** â€” how pi's \"adapt to your workflow\" meets GitClaw's \"the repo is the platform\""}],"api":"anthropic-messages","provider":"anthropic","model":"claude-opus-4-6","usage":{"input":1,"output":215,"cacheRead":31859,"cacheWrite":3629,"totalTokens":35704,"cost":{"input":0.000005,"output":0.0053750000000000004,"cacheRead":0.0159295,"cacheWrite":0.02268125,"total":0.043990749999999995}},"stopReason":"stop","timestamp":1771589675399}}
{"type":"message","id":"184640e4","parentId":"bd0bda6f","timestamp":"2026-02-20T12:20:46.402Z","message":{"role":"user","content":[{"type":"text","text":"Tell me abou the last 10 commits to this repo, dot points with less than 20 word descriptions"}],"timestamp":1771590046377}}
{"type":"message","id":"f960c8f7","parentId":"184640e4","timestamp":"2026-02-20T12:20:49.056Z","message":{"role":"assistant","content":[{"type":"toolCall","id":"toolu_01TgFN7zwp5QdYPyuKWbDXPn","name":"bash","arguments":{"command":"git log --oneline -10"}}],"api":"anthropic-messages","provider":"anthropic","model":"claude-opus-4-6","usage":{"input":3,"output":58,"cacheRead":0,"cacheWrite":35728,"totalTokens":35789,"cost":{"input":0.000015000000000000002,"output":0.0014500000000000001,"cacheRead":0,"cacheWrite":0.2233,"total":0.224765}},"stopReason":"toolUse","timestamp":1771590046379}}
{"type":"message","id":"448fd50c","parentId":"f960c8f7","timestamp":"2026-02-20T12:20:49.061Z","message":{"role":"toolResult","toolCallId":"toolu_01TgFN7zwp5QdYPyuKWbDXPn","toolName":"bash","content":[{"type":"text","text":"3804bc4 gitclaw: work on issue #63\n431be7e Update GITCLAW-The-Idea.md\nf6ec768 Rename docs/GITCLAW-The-Idea.md to .GITCLAW/docs/GITCLAW-The-Idea.md\n77c131f Merge pull request #67 from japer-technology/copilot/fix-file-creation-error\n8c98441 fix: extract text from most recent non-empty assistant message_end event\n0298f63 Initial plan\na480fa7 Update and rename THE-IDEA.md to docs/GITCLAW-The-Idea.md\n61749e9 gitclaw: work on issue #63\n759f36b gitclaw: work on issue #63\ne7e8551 gitclaw: work on issue #63\n"}],"isError":false,"timestamp":1771590049061}}
{"type":"message","id":"93dc6317","parentId":"448fd50c","timestamp":"2026-02-20T12:21:15.269Z","message":{"role":"assistant","content":[{"type":"text","text":"Here are the last 10 commits:\n\n- **3804bc4** â€” Agent work on issue #63 (latest session update)\n- **431be7e** â€” Updated the GITCLAW-The-Idea.md document\n- **f6ec768** â€” Moved GITCLAW-The-Idea.md into the `.GITCLAW/docs/` directory\n- **77c131f** â€” Merged PR #67 fixing a file creation error from Copilot\n- **8c98441** â€” Fixed text extraction to use most recent non-empty assistant message\n- **a480fa7** â€” Initial plan for a fix (related to PR #67)\n- **61749e9** â€” Renamed and moved THE-IDEA.md to `docs/GITCLAW-The-Idea.md`\n- **759f36b** â€” Agent work on issue #63 (session state commit)\n- **e7e8551** â€” Agent work on issue #63 (session state commit)\n- **61749e9** â€” Agent work on issue #63 (earlier session state commit)\n\nMost activity is the agent working on issue #63, plus a bugfix PR for assistant message extraction and some doc reorganization."}],"api":"anthropic-messages","provider":"anthropic","model":"claude-opus-4-6","usage":{"input":1,"output":284,"cacheRead":35728,"cacheWrite":277,"totalTokens":36290,"cost":{"input":0.000005,"output":0.0071,"cacheRead":0.017863999999999998,"cacheWrite":0.0017312500000000001,"total":0.02670025}},"stopReason":"stop","timestamp":1771590049062}}
{"type":"message","id":"90507294","parentId":"93dc6317","timestamp":"2026-02-20T12:23:20.909Z","message":{"role":"user","content":[{"type":"text","text":"Does pi have mechanisms to stop run away processing and costs?"}],"timestamp":1771590200855}}
{"type":"message","id":"e0c69489","parentId":"90507294","timestamp":"2026-02-20T12:23:25.352Z","message":{"role":"assistant","content":[{"type":"text","text":"\n\n"},{"type":"thinking","thinking":"Let me check pi's documentation for cost controls, limits, and mechanisms to prevent runaway processing.","thinkingSignature":"EpACCkYICxgCKkDs9WEIH5KmmGbIvsArIf87d/QLk1UOT0JGylHKgj528v9VkPgnElD9ffyAnnIxOwoE6/96iav3W30gCJT3ujCUEgxgUzQO6v0icx/ktqkaDJusWCVv+zH0dzrQLyIwvbc9hkFvQQ5KTREMjE6y7PusOkeAW7eEOUJ1LBzz3hZ0IUTOBmTcXgLBB8V5bdRSKnhGFodh95n1ikk5x/rDdoAe4p6NcmMqbCuQdMslgANptjIMMqFFCnGBlTW8Cq7uOS7oVj5LCI/Ei1T/DXgM3iV7LCRCwwFLKTCUf0z+muO6O8SOfAnP8xtAOMACN6fdkfortxt3+gV4qIZVCyx+Gwg0OxL4iebvS4sYAQ=="},{"type":"toolCall","id":"toolu_01NhdRw89bnx7uxPtrhqP8bw","name":"bash","arguments":{"command":"rg -il \"cost\\|budget\\|limit\\|timeout\\|max.*token\\|abort\\|cancel\\|runaway\\|spending\\|cap\" /home/runner/work/gitclaw/gitclaw/.GITCLAW/node_modules/@mariozechner/pi-coding-agent/docs/ --type md"}}],"api":"anthropic-messages","provider":"anthropic","model":"claude-opus-4-6","usage":{"input":3,"output":163,"cacheRead":0,"cacheWrite":36302,"totalTokens":36468,"cost":{"input":0.000015000000000000002,"output":0.0040750000000000005,"cacheRead":0,"cacheWrite":0.22688750000000002,"total":0.23097750000000003}},"stopReason":"toolUse","timestamp":1771590200857}}
{"type":"message","id":"5ccf9cfa","parentId":"e0c69489","timestamp":"2026-02-20T12:23:25.355Z","message":{"role":"toolResult","toolCallId":"toolu_01NhdRw89bnx7uxPtrhqP8bw","toolName":"bash","content":[{"type":"text","text":"/bin/bash: line 1: rg: command not found\n\n\nCommand exited with code 127"}],"details":{},"isError":true,"timestamp":1771590205355}}
{"type":"message","id":"15a39ed3","parentId":"5ccf9cfa","timestamp":"2026-02-20T12:23:47.417Z","message":{"role":"assistant","content":[{"type":"toolCall","id":"toolu_01JFWeUs1X2W44Ssp1BV54zr","name":"bash","arguments":{"command":"grep -ril \"cost\\|budget\\|limit\\|timeout\\|max.*token\\|abort\\|cancel\\|runaway\\|spending\" /home/runner/work/gitclaw/gitclaw/.GITCLAW/node_modules/@mariozechner/pi-coding-agent/docs/ 2>/dev/null"}}],"api":"anthropic-messages","provider":"anthropic","model":"claude-opus-4-6","usage":{"input":1,"output":127,"cacheRead":36302,"cacheWrite":206,"totalTokens":36636,"cost":{"input":0.000005,"output":0.0031750000000000003,"cacheRead":0.018151,"cacheWrite":0.0012875,"total":0.0226185}},"stopReason":"toolUse","timestamp":1771590205356}}
{"type":"message","id":"2f116638","parentId":"15a39ed3","timestamp":"2026-02-20T12:23:47.425Z","message":{"role":"toolResult","toolCallId":"toolu_01JFWeUs1X2W44Ssp1BV54zr","toolName":"bash","content":[{"type":"text","text":"/home/runner/work/gitclaw/gitclaw/.GITCLAW/node_modules/@mariozechner/pi-coding-agent/docs/terminal-setup.md\n/home/runner/work/gitclaw/gitclaw/.GITCLAW/node_modules/@mariozechner/pi-coding-agent/docs/models.md\n/home/runner/work/gitclaw/gitclaw/.GITCLAW/node_modules/@mariozechner/pi-coding-agent/docs/session.md\n/home/runner/work/gitclaw/gitclaw/.GITCLAW/node_modules/@mariozechner/pi-coding-agent/docs/keybindings.md\n/home/runner/work/gitclaw/gitclaw/.GITCLAW/node_modules/@mariozechner/pi-coding-agent/docs/skills.md\n/home/runner/work/gitclaw/gitclaw/.GITCLAW/node_modules/@mariozechner/pi-coding-agent/docs/compaction.md\n/home/runner/work/gitclaw/gitclaw/.GITCLAW/node_modules/@mariozechner/pi-coding-agent/docs/termux.md\n/home/runner/work/gitclaw/gitclaw/.GITCLAW/node_modules/@mariozechner/pi-coding-agent/docs/providers.md\n/home/runner/work/gitclaw/gitclaw/.GITCLAW/node_modules/@mariozechner/pi-coding-agent/docs/sdk.md\n/home/runner/work/gitclaw/gitclaw/.GITCLAW/node_modules/@mariozechner/pi-coding-agent/docs/rpc.md\n/home/runner/work/gitclaw/gitclaw/.GITCLAW/node_modules/@mariozechner/pi-coding-agent/docs/packages.md\n/home/runner/work/gitclaw/gitclaw/.GITCLAW/node_modules/@mariozechner/pi-coding-agent/docs/tree.md\n/home/runner/work/gitclaw/gitclaw/.GITCLAW/node_modules/@mariozechner/pi-coding-agent/docs/extensions.md\n/home/runner/work/gitclaw/gitclaw/.GITCLAW/node_modules/@mariozechner/pi-coding-agent/docs/json.md\n/home/runner/work/gitclaw/gitclaw/.GITCLAW/node_modules/@mariozechner/pi-coding-agent/docs/settings.md\n/home/runner/work/gitclaw/gitclaw/.GITCLAW/node_modules/@mariozechner/pi-coding-agent/docs/custom-provider.md\n/home/runner/work/gitclaw/gitclaw/.GITCLAW/node_modules/@mariozechner/pi-coding-agent/docs/tui.md\n"}],"isError":false,"timestamp":1771590227425}}
{"type":"message","id":"d46b897f","parentId":"2f116638","timestamp":"2026-02-20T12:23:49.845Z","message":{"role":"assistant","content":[{"type":"toolCall","id":"toolu_01Y2hi8FrUKaqmLiqhQMBHSk","name":"read","arguments":{"path":"/home/runner/work/gitclaw/gitclaw/.GITCLAW/node_modules/@mariozechner/pi-coding-agent/docs/settings.md"}}],"api":"anthropic-messages","provider":"anthropic","model":"claude-opus-4-6","usage":{"input":1,"output":90,"cacheRead":36508,"cacheWrite":846,"totalTokens":37445,"cost":{"input":0.000005,"output":0.0022500000000000003,"cacheRead":0.018254,"cacheWrite":0.0052875000000000005,"total":0.0257965}},"stopReason":"toolUse","timestamp":1771590227426}}
{"type":"message","id":"38afb067","parentId":"d46b897f","timestamp":"2026-02-20T12:23:49.849Z","message":{"role":"toolResult","toolCallId":"toolu_01Y2hi8FrUKaqmLiqhQMBHSk","toolName":"read","content":[{"type":"text","text":"# Settings\n\nPi uses JSON settings files with project settings overriding global settings.\n\n| Location | Scope |\n|----------|-------|\n| `~/.pi/agent/settings.json` | Global (all projects) |\n| `.pi/settings.json` | Project (current directory) |\n\nEdit directly or use `/settings` for common options.\n\n## All Settings\n\n### Model & Thinking\n\n| Setting | Type | Default | Description |\n|---------|------|---------|-------------|\n| `defaultProvider` | string | - | Default provider (e.g., `\"anthropic\"`, `\"openai\"`) |\n| `defaultModel` | string | - | Default model ID |\n| `defaultThinkingLevel` | string | - | `\"off\"`, `\"minimal\"`, `\"low\"`, `\"medium\"`, `\"high\"`, `\"xhigh\"` |\n| `hideThinkingBlock` | boolean | `false` | Hide thinking blocks in output |\n| `thinkingBudgets` | object | - | Custom token budgets per thinking level |\n\n#### thinkingBudgets\n\n```json\n{\n  \"thinkingBudgets\": {\n    \"minimal\": 1024,\n    \"low\": 4096,\n    \"medium\": 10240,\n    \"high\": 32768\n  }\n}\n```\n\n### UI & Display\n\n| Setting | Type | Default | Description |\n|---------|------|---------|-------------|\n| `theme` | string | `\"dark\"` | Theme name (`\"dark\"`, `\"light\"`, or custom) |\n| `quietStartup` | boolean | `false` | Hide startup header |\n| `collapseChangelog` | boolean | `false` | Show condensed changelog after updates |\n| `doubleEscapeAction` | string | `\"tree\"` | Action for double-escape: `\"tree\"` or `\"fork\"` |\n| `editorPaddingX` | number | `0` | Horizontal padding for input editor (0-3) |\n| `autocompleteMaxVisible` | number | `5` | Max visible items in autocomplete dropdown (3-20) |\n| `showHardwareCursor` | boolean | `false` | Show terminal cursor |\n\n### Compaction\n\n| Setting | Type | Default | Description |\n|---------|------|---------|-------------|\n| `compaction.enabled` | boolean | `true` | Enable auto-compaction |\n| `compaction.reserveTokens` | number | `16384` | Tokens reserved for LLM response |\n| `compaction.keepRecentTokens` | number | `20000` | Recent tokens to keep (not summarized) |\n\n```json\n{\n  \"compaction\": {\n    \"enabled\": true,\n    \"reserveTokens\": 16384,\n    \"keepRecentTokens\": 20000\n  }\n}\n```\n\n### Branch Summary\n\n| Setting | Type | Default | Description |\n|---------|------|---------|-------------|\n| `branchSummary.reserveTokens` | number | `16384` | Tokens reserved for branch summarization |\n\n### Retry\n\n| Setting | Type | Default | Description |\n|---------|------|---------|-------------|\n| `retry.enabled` | boolean | `true` | Enable automatic retry on transient errors |\n| `retry.maxRetries` | number | `3` | Maximum retry attempts |\n| `retry.baseDelayMs` | number | `2000` | Base delay for exponential backoff (2s, 4s, 8s) |\n| `retry.maxDelayMs` | number | `60000` | Max server-requested delay before failing (60s) |\n\nWhen a provider requests a retry delay longer than `maxDelayMs` (e.g., Google's \"quota will reset after 5h\"), the request fails immediately with an informative error instead of waiting silently. Set to `0` to disable the cap.\n\n```json\n{\n  \"retry\": {\n    \"enabled\": true,\n    \"maxRetries\": 3,\n    \"baseDelayMs\": 2000,\n    \"maxDelayMs\": 60000\n  }\n}\n```\n\n### Message Delivery\n\n| Setting | Type | Default | Description |\n|---------|------|---------|-------------|\n| `steeringMode` | string | `\"one-at-a-time\"` | How steering messages are sent: `\"all\"` or `\"one-at-a-time\"` |\n| `followUpMode` | string | `\"one-at-a-time\"` | How follow-up messages are sent: `\"all\"` or `\"one-at-a-time\"` |\n\n### Terminal & Images\n\n| Setting | Type | Default | Description |\n|---------|------|---------|-------------|\n| `terminal.showImages` | boolean | `true` | Show images in terminal (if supported) |\n| `images.autoResize` | boolean | `true` | Resize images to 2000x2000 max |\n| `images.blockImages` | boolean | `false` | Block all images from being sent to LLM |\n\n### Shell\n\n| Setting | Type | Default | Description |\n|---------|------|---------|-------------|\n| `shellPath` | string | - | Custom shell path (e.g., for Cygwin on Windows) |\n| `shellCommandPrefix` | string | - | Prefix for every bash command (e.g., `\"shopt -s expand_aliases\"`) |\n\n### Model Cycling\n\n| Setting | Type | Default | Description |\n|---------|------|---------|-------------|\n| `enabledModels` | string[] | - | Model patterns for Ctrl+P cycling (same format as `--models` CLI flag) |\n\n```json\n{\n  \"enabledModels\": [\"claude-*\", \"gpt-4o\", \"gemini-2*\"]\n}\n```\n\n### Markdown\n\n| Setting | Type | Default | Description |\n|---------|------|---------|-------------|\n| `markdown.codeBlockIndent` | string | `\"  \"` | Indentation for code blocks |\n\n### Resources\n\nThese settings define where to load extensions, skills, prompts, and themes from.\n\nPaths in `~/.pi/agent/settings.json` resolve relative to `~/.pi/agent`. Paths in `.pi/settings.json` resolve relative to `.pi`. Absolute paths and `~` are supported.\n\n| Setting | Type | Default | Description |\n|---------|------|---------|-------------|\n| `packages` | array | `[]` | npm/git packages to load resources from |\n| `extensions` | string[] | `[]` | Local extension file paths or directories |\n| `skills` | string[] | `[]` | Local skill file paths or directories |\n| `prompts` | string[] | `[]` | Local prompt template paths or directories |\n| `themes` | string[] | `[]` | Local theme file paths or directories |\n| `enableSkillCommands` | boolean | `true` | Register skills as `/skill:name` commands |\n\nArrays support glob patterns and exclusions. Use `!pattern` to exclude. Use `+path` to force-include an exact path and `-path` to force-exclude an exact path.\n\n#### packages\n\nString form loads all resources from a package:\n\n```json\n{\n  \"packages\": [\"pi-skills\", \"@org/my-extension\"]\n}\n```\n\nObject form filters which resources to load:\n\n```json\n{\n  \"packages\": [\n    {\n      \"source\": \"pi-skills\",\n      \"skills\": [\"brave-search\", \"transcribe\"],\n      \"extensions\": []\n    }\n  ]\n}\n```\n\nSee [packages.md](packages.md) for package management details.\n\n## Example\n\n```json\n{\n  \"defaultProvider\": \"anthropic\",\n  \"defaultModel\": \"claude-sonnet-4-20250514\",\n  \"defaultThinkingLevel\": \"medium\",\n  \"theme\": \"dark\",\n  \"compaction\": {\n    \"enabled\": true,\n    \"reserveTokens\": 16384,\n    \"keepRecentTokens\": 20000\n  },\n  \"retry\": {\n    \"enabled\": true,\n    \"maxRetries\": 3\n  },\n  \"enabledModels\": [\"claude-*\", \"gpt-4o\"],\n  \"packages\": [\"pi-skills\"]\n}\n```\n\n## Project Overrides\n\nProject settings (`.pi/settings.json`) override global settings. Nested objects are merged:\n\n```json\n// ~/.pi/agent/settings.json (global)\n{\n  \"theme\": \"dark\",\n  \"compaction\": { \"enabled\": true, \"reserveTokens\": 16384 }\n}\n\n// .pi/settings.json (project)\n{\n  \"compaction\": { \"reserveTokens\": 8192 }\n}\n\n// Result\n{\n  \"theme\": \"dark\",\n  \"compaction\": { \"enabled\": true, \"reserveTokens\": 8192 }\n}\n```\n"}],"isError":false,"timestamp":1771590229849}}
{"type":"message","id":"7af4d1d8","parentId":"38afb067","timestamp":"2026-02-20T12:23:53.400Z","message":{"role":"assistant","content":[{"type":"toolCall","id":"toolu_01PzFZyAZZZvQbZQFT4ojj7y","name":"bash","arguments":{"command":"grep -n \"cost\\|budget\\|limit\\|timeout\\|max.*turn\\|maxTurn\\|abort\\|cancel\\|spending\\|cap\\|guard\\|protect\\|restrict\\|safeguard\" /home/runner/work/gitclaw/gitclaw/.GITCLAW/node_modules/@mariozechner/pi-coding-agent/docs/sdk.md"}}],"api":"anthropic-messages","provider":"anthropic","model":"claude-opus-4-6","usage":{"input":1,"output":141,"cacheRead":37354,"cacheWrite":2225,"totalTokens":39721,"cost":{"input":0.000005,"output":0.0035250000000000004,"cacheRead":0.018677,"cacheWrite":0.01390625,"total":0.03611325}},"stopReason":"toolUse","timestamp":1771590229849}}
{"type":"message","id":"0053c0bb","parentId":"7af4d1d8","timestamp":"2026-02-20T12:23:53.403Z","message":{"role":"toolResult","toolCallId":"toolu_01PzFZyAZZZvQbZQFT4ojj7y","toolName":"bash","content":[{"type":"text","text":"5:The SDK provides programmatic access to pi's agent capabilities. Use it to embed pi in other applications, build custom interfaces, or integrate with automated workflows.\n9:- Integrate agent capabilities into existing applications\n105:  newSession(options?: { parentSession?: string }): Promise<boolean>;  // Returns false if cancelled by hook\n109:  fork(entryId: string): Promise<{ selectedText: string; cancelled: boolean }>;  // Creates new session file\n110:  navigateTree(targetId: string, options?: { summarize?: boolean; customInstructions?: string; replaceInstructions?: boolean; label?: string }): Promise<{ editorText?: string; cancelled: boolean }>;  // In-place navigation\n117:  abortCompaction(): void;\n120:  abort(): Promise<void>;\n"}],"isError":false,"timestamp":1771590233403}}
{"type":"message","id":"56a26731","parentId":"0053c0bb","timestamp":"2026-02-20T12:23:56.045Z","message":{"role":"assistant","content":[{"type":"toolCall","id":"toolu_01TqSv7UsS4Xieedj1zjVhpm","name":"read","arguments":{"path":"/home/runner/work/gitclaw/gitclaw/.GITCLAW/node_modules/@mariozechner/pi-coding-agent/docs/sdk.md","offset":80,"limit":120}}],"api":"anthropic-messages","provider":"anthropic","model":"claude-opus-4-6","usage":{"input":1,"output":124,"cacheRead":39579,"cacheWrite":339,"totalTokens":40043,"cost":{"input":0.000005,"output":0.0031000000000000003,"cacheRead":0.019789499999999998,"cacheWrite":0.00211875,"total":0.025013249999999997}},"stopReason":"toolUse","timestamp":1771590233404}}
{"type":"message","id":"67adbb7f","parentId":"56a26731","timestamp":"2026-02-20T12:23:56.047Z","message":{"role":"toolResult","toolCallId":"toolu_01TqSv7UsS4Xieedj1zjVhpm","toolName":"read","content":[{"type":"text","text":"  // Queue messages during streaming\n  steer(text: string): Promise<void>;    // Interrupt: delivered after current tool, skips remaining\n  followUp(text: string): Promise<void>; // Wait: delivered only when agent finishes\n  \n  // Subscribe to events (returns unsubscribe function)\n  subscribe(listener: (event: AgentSessionEvent) => void): () => void;\n  \n  // Session info\n  sessionFile: string | undefined;  // undefined for in-memory\n  sessionId: string;\n  \n  // Model control\n  setModel(model: Model): Promise<void>;\n  setThinkingLevel(level: ThinkingLevel): void;\n  cycleModel(): Promise<ModelCycleResult | undefined>;\n  cycleThinkingLevel(): ThinkingLevel | undefined;\n  \n  // State access\n  agent: Agent;\n  model: Model | undefined;\n  thinkingLevel: ThinkingLevel;\n  messages: AgentMessage[];\n  isStreaming: boolean;\n  \n  // Session management\n  newSession(options?: { parentSession?: string }): Promise<boolean>;  // Returns false if cancelled by hook\n  switchSession(sessionPath: string): Promise<boolean>;\n  \n  // Forking\n  fork(entryId: string): Promise<{ selectedText: string; cancelled: boolean }>;  // Creates new session file\n  navigateTree(targetId: string, options?: { summarize?: boolean; customInstructions?: string; replaceInstructions?: boolean; label?: string }): Promise<{ editorText?: string; cancelled: boolean }>;  // In-place navigation\n  \n  // Hook message injection\n  sendHookMessage(message: HookMessage, triggerTurn?: boolean): Promise<void>;\n  \n  // Compaction\n  compact(customInstructions?: string): Promise<CompactionResult>;\n  abortCompaction(): void;\n  \n  // Abort current operation\n  abort(): Promise<void>;\n  \n  // Cleanup\n  dispose(): void;\n}\n```\n\n### Prompting and Message Queueing\n\nThe `prompt()` method handles prompt templates, extension commands, and message sending:\n\n```typescript\n// Basic prompt (when not streaming)\nawait session.prompt(\"What files are here?\");\n\n// With images\nawait session.prompt(\"What's in this image?\", {\n  images: [{ type: \"image\", source: { type: \"base64\", mediaType: \"image/png\", data: \"...\" } }]\n});\n\n// During streaming: must specify how to queue the message\nawait session.prompt(\"Stop and do this instead\", { streamingBehavior: \"steer\" });\nawait session.prompt(\"After you're done, also check X\", { streamingBehavior: \"followUp\" });\n```\n\n**Behavior:**\n- **Extension commands** (e.g., `/mycommand`): Execute immediately, even during streaming. They manage their own LLM interaction via `pi.sendMessage()`.\n- **File-based prompt templates** (from `.md` files): Expanded to their content before sending/queueing.\n- **During streaming without `streamingBehavior`**: Throws an error. Use `steer()` or `followUp()` directly, or specify the option.\n\nFor explicit queueing during streaming:\n\n```typescript\n// Interrupt the agent (delivered after current tool, skips remaining tools)\nawait session.steer(\"New instruction\");\n\n// Wait for agent to finish (delivered only when agent stops)\nawait session.followUp(\"After you're done, also do this\");\n```\n\nBoth `steer()` and `followUp()` expand file-based prompt templates but error on extension commands (extension commands cannot be queued).\n\n### Agent and AgentState\n\nThe `Agent` class (from `@mariozechner/pi-agent-core`) handles the core LLM interaction. Access it via `session.agent`.\n\n```typescript\n// Access current state\nconst state = session.agent.state;\n\n// state.messages: AgentMessage[] - conversation history\n// state.model: Model - current model\n// state.thinkingLevel: ThinkingLevel - current thinking level\n// state.systemPrompt: string - system prompt\n// state.tools: Tool[] - available tools\n\n// Replace messages (useful for branching, restoration)\nsession.agent.replaceMessages(messages);\n\n// Wait for agent to finish processing\nawait session.agent.waitForIdle();\n```\n\n### Events\n\nSubscribe to events to receive streaming output and lifecycle notifications.\n\n```typescript\nsession.subscribe((event) => {\n  switch (event.type) {\n    // Streaming text from assistant\n    case \"message_update\":\n      if (event.assistantMessageEvent.type === \"text_delta\") {\n        process.stdout.write(event.assistantMessageEvent.delta);\n      }\n      if (event.assistantMessageEvent.type === \"thinking_delta\") {\n        // Thinking output (if thinking enabled)\n      }\n      break;\n    \n\n[759 more lines in file. Use offset=200 to continue.]"}],"isError":false,"timestamp":1771590236047}}
{"type":"message","id":"ade5b3ce","parentId":"67adbb7f","timestamp":"2026-02-20T12:23:59.255Z","message":{"role":"assistant","content":[{"type":"toolCall","id":"toolu_015heteaFzF4PvyFtzhK8AMu","name":"read","arguments":{"path":"/home/runner/work/gitclaw/gitclaw/.GITCLAW/node_modules/@mariozechner/pi-coding-agent/docs/sdk.md","offset":200,"limit":150}}],"api":"anthropic-messages","provider":"anthropic","model":"claude-opus-4-6","usage":{"input":1,"output":124,"cacheRead":39918,"cacheWrite":1322,"totalTokens":41365,"cost":{"input":0.000005,"output":0.0031000000000000003,"cacheRead":0.019958999999999998,"cacheWrite":0.0082625,"total":0.0313265}},"stopReason":"toolUse","timestamp":1771590236047}}
{"type":"message","id":"8fe3381e","parentId":"ade5b3ce","timestamp":"2026-02-20T12:23:59.256Z","message":{"role":"toolResult","toolCallId":"toolu_015heteaFzF4PvyFtzhK8AMu","toolName":"read","content":[{"type":"text","text":"    // Tool execution\n    case \"tool_execution_start\":\n      console.log(`Tool: ${event.toolName}`);\n      break;\n    case \"tool_execution_update\":\n      // Streaming tool output\n      break;\n    case \"tool_execution_end\":\n      console.log(`Result: ${event.isError ? \"error\" : \"success\"}`);\n      break;\n    \n    // Message lifecycle\n    case \"message_start\":\n      // New message starting\n      break;\n    case \"message_end\":\n      // Message complete\n      break;\n    \n    // Agent lifecycle\n    case \"agent_start\":\n      // Agent started processing prompt\n      break;\n    case \"agent_end\":\n      // Agent finished (event.messages contains new messages)\n      break;\n    \n    // Turn lifecycle (one LLM response + tool calls)\n    case \"turn_start\":\n      break;\n    case \"turn_end\":\n      // event.message: assistant response\n      // event.toolResults: tool results from this turn\n      break;\n    \n    // Session events (auto-compaction, retry)\n    case \"auto_compaction_start\":\n    case \"auto_compaction_end\":\n    case \"auto_retry_start\":\n    case \"auto_retry_end\":\n      break;\n  }\n});\n```\n\n## Options Reference\n\n### Directories\n\n```typescript\nconst { session } = await createAgentSession({\n  // Working directory for DefaultResourceLoader discovery\n  cwd: process.cwd(), // default\n  \n  // Global config directory\n  agentDir: \"~/.pi/agent\", // default (expands ~)\n});\n```\n\n`cwd` is used by `DefaultResourceLoader` for:\n- Project extensions (`.pi/extensions/`)\n- Project skills (`.pi/skills/`)\n- Project prompts (`.pi/prompts/`)\n- Context files (`AGENTS.md` walking up from cwd)\n- Session directory naming\n\n`agentDir` is used by `DefaultResourceLoader` for:\n- Global extensions (`extensions/`)\n- Global skills (`skills/`)\n- Global prompts (`prompts/`)\n- Global context file (`AGENTS.md`)\n- Settings (`settings.json`)\n- Custom models (`models.json`)\n- Credentials (`auth.json`)\n- Sessions (`sessions/`)\n\nWhen you pass a custom `ResourceLoader`, `cwd` and `agentDir` no longer control resource discovery. They still influence session naming and tool path resolution.\n\n### Model\n\n```typescript\nimport { getModel } from \"@mariozechner/pi-ai\";\nimport { AuthStorage, ModelRegistry } from \"@mariozechner/pi-coding-agent\";\n\nconst authStorage = new AuthStorage();\nconst modelRegistry = new ModelRegistry(authStorage);\n\n// Find specific built-in model (doesn't check if API key exists)\nconst opus = getModel(\"anthropic\", \"claude-opus-4-5\");\nif (!opus) throw new Error(\"Model not found\");\n\n// Find any model by provider/id, including custom models from models.json\n// (doesn't check if API key exists)\nconst customModel = modelRegistry.find(\"my-provider\", \"my-model\");\n\n// Get only models that have valid API keys configured\nconst available = await modelRegistry.getAvailable();\n\nconst { session } = await createAgentSession({\n  model: opus,\n  thinkingLevel: \"medium\", // off, minimal, low, medium, high, xhigh\n  \n  // Models for cycling (Ctrl+P in interactive mode)\n  scopedModels: [\n    { model: opus, thinkingLevel: \"high\" },\n    { model: haiku, thinkingLevel: \"off\" },\n  ],\n  \n  authStorage,\n  modelRegistry,\n});\n```\n\nIf no model is provided:\n1. Tries to restore from session (if continuing)\n2. Uses default from settings\n3. Falls back to first available model\n\n> See [examples/sdk/02-custom-model.ts](../examples/sdk/02-custom-model.ts)\n\n### API Keys and OAuth\n\nAPI key resolution priority (handled by AuthStorage):\n1. Runtime overrides (via `setRuntimeApiKey`, not persisted)\n2. Stored credentials in `auth.json` (API keys or OAuth tokens)\n3. Environment variables (`ANTHROPIC_API_KEY`, `OPENAI_API_KEY`, etc.)\n4. Fallback resolver (for custom provider keys from `models.json`)\n\n```typescript\nimport { AuthStorage, ModelRegistry } from \"@mariozechner/pi-coding-agent\";\n\n// Default: uses ~/.pi/agent/auth.json and ~/.pi/agent/models.json\nconst authStorage = new AuthStorage();\nconst modelRegistry = new ModelRegistry(authStorage);\n\nconst { session } = await createAgentSession({\n  sessionManager: SessionManager.inMemory(),\n  authStorage,\n  modelRegistry,\n});\n\n// Runtime API key override (not persisted to disk)\nauthStorage.setRuntimeApiKey(\"anthropic\", \"sk-my-temp-key\");\n\n// Custom auth storage location\nconst customAuth = new AuthStorage(\"/my/app/auth.json\");\nconst customRegistry = new ModelRegistry(customAuth, \"/my/app/models.json\");\n\nconst { session } = await createAgentSession({\n  sessionManager: SessionManager.inMemory(),\n\n[609 more lines in file. Use offset=350 to continue.]"}],"isError":false,"timestamp":1771590239256}}
{"type":"message","id":"6ab6ef4b","parentId":"8fe3381e","timestamp":"2026-02-20T12:24:01.780Z","message":{"role":"assistant","content":[{"type":"toolCall","id":"toolu_01MdqUhzfiHReZoKYiNzAN1a","name":"read","arguments":{"path":"/home/runner/work/gitclaw/gitclaw/.GITCLAW/node_modules/@mariozechner/pi-coding-agent/docs/sdk.md","offset":350,"limit":200}}],"api":"anthropic-messages","provider":"anthropic","model":"claude-opus-4-6","usage":{"input":1,"output":124,"cacheRead":41240,"cacheWrite":1412,"totalTokens":42777,"cost":{"input":0.000005,"output":0.0031000000000000003,"cacheRead":0.02062,"cacheWrite":0.008825000000000001,"total":0.03255}},"stopReason":"toolUse","timestamp":1771590239256}}
{"type":"message","id":"93544ac7","parentId":"6ab6ef4b","timestamp":"2026-02-20T12:24:01.781Z","message":{"role":"toolResult","toolCallId":"toolu_01MdqUhzfiHReZoKYiNzAN1a","toolName":"read","content":[{"type":"text","text":"  authStorage: customAuth,\n  modelRegistry: customRegistry,\n});\n\n// No custom models.json (built-in models only)\nconst simpleRegistry = new ModelRegistry(authStorage);\n```\n\n> See [examples/sdk/09-api-keys-and-oauth.ts](../examples/sdk/09-api-keys-and-oauth.ts)\n\n### System Prompt\n\nUse a `ResourceLoader` to override the system prompt:\n\n```typescript\nimport { createAgentSession, DefaultResourceLoader } from \"@mariozechner/pi-coding-agent\";\n\nconst loader = new DefaultResourceLoader({\n  systemPromptOverride: () => \"You are a helpful assistant.\",\n});\nawait loader.reload();\n\nconst { session } = await createAgentSession({ resourceLoader: loader });\n```\n\n> See [examples/sdk/03-custom-prompt.ts](../examples/sdk/03-custom-prompt.ts)\n\n### Tools\n\n```typescript\nimport {\n  codingTools,   // read, bash, edit, write (default)\n  readOnlyTools, // read, grep, find, ls\n  readTool, bashTool, editTool, writeTool,\n  grepTool, findTool, lsTool,\n} from \"@mariozechner/pi-coding-agent\";\n\n// Use built-in tool set\nconst { session } = await createAgentSession({\n  tools: readOnlyTools,\n});\n\n// Pick specific tools\nconst { session } = await createAgentSession({\n  tools: [readTool, bashTool, grepTool],\n});\n```\n\n#### Tools with Custom cwd\n\n**Important:** The pre-built tool instances (`readTool`, `bashTool`, etc.) use `process.cwd()` for path resolution. When you specify a custom `cwd` AND provide explicit `tools`, you must use the tool factory functions to ensure paths resolve correctly:\n\n```typescript\nimport {\n  createCodingTools,    // Creates [read, bash, edit, write] for specific cwd\n  createReadOnlyTools,  // Creates [read, grep, find, ls] for specific cwd\n  createReadTool,\n  createBashTool,\n  createEditTool,\n  createWriteTool,\n  createGrepTool,\n  createFindTool,\n  createLsTool,\n} from \"@mariozechner/pi-coding-agent\";\n\nconst cwd = \"/path/to/project\";\n\n// Use factory for tool sets\nconst { session } = await createAgentSession({\n  cwd,\n  tools: createCodingTools(cwd),  // Tools resolve paths relative to cwd\n});\n\n// Or pick specific tools\nconst { session } = await createAgentSession({\n  cwd,\n  tools: [createReadTool(cwd), createBashTool(cwd), createGrepTool(cwd)],\n});\n```\n\n**When you don't need factories:**\n- If you omit `tools`, pi automatically creates them with the correct `cwd`\n- If you use `process.cwd()` as your `cwd`, the pre-built instances work fine\n\n**When you must use factories:**\n- When you specify both `cwd` (different from `process.cwd()`) AND `tools`\n\n> See [examples/sdk/05-tools.ts](../examples/sdk/05-tools.ts)\n\n### Custom Tools\n\n```typescript\nimport { Type } from \"@sinclair/typebox\";\nimport { createAgentSession, type ToolDefinition } from \"@mariozechner/pi-coding-agent\";\n\n// Inline custom tool\nconst myTool: ToolDefinition = {\n  name: \"my_tool\",\n  label: \"My Tool\",\n  description: \"Does something useful\",\n  parameters: Type.Object({\n    input: Type.String({ description: \"Input value\" }),\n  }),\n  execute: async (toolCallId, params, onUpdate, ctx, signal) => ({\n    content: [{ type: \"text\", text: `Result: ${params.input}` }],\n    details: {},\n  }),\n};\n\n// Pass custom tools directly\nconst { session } = await createAgentSession({\n  customTools: [myTool],\n});\n```\n\nCustom tools passed via `customTools` are combined with extension-registered tools. Extensions loaded by the ResourceLoader can also register tools via `pi.registerTool()`.\n\n> See [examples/sdk/05-tools.ts](../examples/sdk/05-tools.ts)\n\n### Extensions\n\nExtensions are loaded by the `ResourceLoader`. `DefaultResourceLoader` discovers extensions from `~/.pi/agent/extensions/`, `.pi/extensions/`, and settings.json extension sources.\n\n```typescript\nimport { createAgentSession, DefaultResourceLoader } from \"@mariozechner/pi-coding-agent\";\n\nconst loader = new DefaultResourceLoader({\n  additionalExtensionPaths: [\"/path/to/my-extension.ts\"],\n  extensionFactories: [\n    (pi) => {\n      pi.on(\"agent_start\", () => {\n        console.log(\"[Inline Extension] Agent starting\");\n      });\n    },\n  ],\n});\nawait loader.reload();\n\nconst { session } = await createAgentSession({ resourceLoader: loader });\n```\n\nExtensions can register tools, subscribe to events, add commands, and more. See [extensions.md](extensions.md) for the full API.\n\n**Event Bus:** Extensions can communicate via `pi.events`. Pass a shared `eventBus` to `DefaultResourceLoader` if you need to emit or listen from outside:\n\n```typescript\nimport { createEventBus, DefaultResourceLoader } from \"@mariozechner/pi-coding-agent\";\n\nconst eventBus = createEventBus();\nconst loader = new DefaultResourceLoader({\n  eventBus,\n});\nawait loader.reload();\n\neventBus.on(\"my-extension:status\", (data) => console.log(data));\n```\n\n> See [examples/sdk/06-extensions.ts](../examples/sdk/06-extensions.ts) and [docs/extensions.md](extensions.md)\n\n### Skills\n\n```typescript\nimport {\n  createAgentSession,\n  DefaultResourceLoader,\n  type Skill,\n} from \"@mariozechner/pi-coding-agent\";\n\nconst customSkill: Skill = {\n  name: \"my-skill\",\n  description: \"Custom instructions\",\n  filePath: \"/path/to/SKILL.md\",\n  baseDir: \"/path/to\",\n  source: \"custom\",\n};\n\nconst loader = new DefaultResourceLoader({\n  skillsOverride: (current) => ({\n    skills: [...current.skills, customSkill],\n    diagnostics: current.diagnostics,\n  }),\n});\nawait loader.reload();\n\nconst { session } = await createAgentSession({ resourceLoader: loader });\n```\n\n> See [examples/sdk/04-skills.ts](../examples/sdk/04-skills.ts)\n\n### Context Files\n\n```typescript\nimport { createAgentSession, DefaultResourceLoader } from \"@mariozechner/pi-coding-agent\";\n\nconst loader = new DefaultResourceLoader({\n  agentsFilesOverride: (current) => ({\n    agentsFiles: [\n      ...current.agentsFiles,\n      { path: \"/virtual/AGENTS.md\", content: \"# Guidelines\\n\\n- Be concise\" },\n    ],\n\n[409 more lines in file. Use offset=550 to continue.]"}],"isError":false,"timestamp":1771590241781}}
{"type":"message","id":"ddb4c6fd","parentId":"93544ac7","timestamp":"2026-02-20T12:24:04.199Z","message":{"role":"assistant","content":[{"type":"toolCall","id":"toolu_01EuefwqmyWJimi1J52NrM8h","name":"read","arguments":{"path":"/home/runner/work/gitclaw/gitclaw/.GITCLAW/node_modules/@mariozechner/pi-coding-agent/docs/sdk.md","offset":550,"limit":200}}],"api":"anthropic-messages","provider":"anthropic","model":"claude-opus-4-6","usage":{"input":1,"output":124,"cacheRead":42652,"cacheWrite":1887,"totalTokens":44664,"cost":{"input":0.000005,"output":0.0031000000000000003,"cacheRead":0.021325999999999998,"cacheWrite":0.01179375,"total":0.03622475}},"stopReason":"toolUse","timestamp":1771590241781}}
{"type":"message","id":"90cec6a7","parentId":"ddb4c6fd","timestamp":"2026-02-20T12:24:04.201Z","message":{"role":"toolResult","toolCallId":"toolu_01EuefwqmyWJimi1J52NrM8h","toolName":"read","content":[{"type":"text","text":"  }),\n});\nawait loader.reload();\n\nconst { session } = await createAgentSession({ resourceLoader: loader });\n```\n\n> See [examples/sdk/07-context-files.ts](../examples/sdk/07-context-files.ts)\n\n### Slash Commands\n\n```typescript\nimport {\n  createAgentSession,\n  DefaultResourceLoader,\n  type PromptTemplate,\n} from \"@mariozechner/pi-coding-agent\";\n\nconst customCommand: PromptTemplate = {\n  name: \"deploy\",\n  description: \"Deploy the application\",\n  source: \"(custom)\",\n  content: \"# Deploy\\n\\n1. Build\\n2. Test\\n3. Deploy\",\n};\n\nconst loader = new DefaultResourceLoader({\n  promptsOverride: (current) => ({\n    prompts: [...current.prompts, customCommand],\n    diagnostics: current.diagnostics,\n  }),\n});\nawait loader.reload();\n\nconst { session } = await createAgentSession({ resourceLoader: loader });\n```\n\n> See [examples/sdk/08-prompt-templates.ts](../examples/sdk/08-prompt-templates.ts)\n\n### Session Management\n\nSessions use a tree structure with `id`/`parentId` linking, enabling in-place branching.\n\n```typescript\nimport { createAgentSession, SessionManager } from \"@mariozechner/pi-coding-agent\";\n\n// In-memory (no persistence)\nconst { session } = await createAgentSession({\n  sessionManager: SessionManager.inMemory(),\n});\n\n// New persistent session\nconst { session } = await createAgentSession({\n  sessionManager: SessionManager.create(process.cwd()),\n});\n\n// Continue most recent\nconst { session, modelFallbackMessage } = await createAgentSession({\n  sessionManager: SessionManager.continueRecent(process.cwd()),\n});\nif (modelFallbackMessage) {\n  console.log(\"Note:\", modelFallbackMessage);\n}\n\n// Open specific file\nconst { session } = await createAgentSession({\n  sessionManager: SessionManager.open(\"/path/to/session.jsonl\"),\n});\n\n// List available sessions (async with optional progress callback)\nconst sessions = await SessionManager.list(process.cwd());\nfor (const info of sessions) {\n  console.log(`${info.id}: ${info.firstMessage} (${info.messageCount} messages, cwd: ${info.cwd})`);\n}\n\n// List all sessions across all projects\nconst allSessions = await SessionManager.listAll((loaded, total) => {\n  console.log(`Loading ${loaded}/${total}...`);\n});\n\n// Custom session directory (no cwd encoding)\nconst customDir = \"/path/to/my-sessions\";\nconst { session } = await createAgentSession({\n  sessionManager: SessionManager.create(process.cwd(), customDir),\n});\n```\n\n**SessionManager tree API:**\n\n```typescript\nconst sm = SessionManager.open(\"/path/to/session.jsonl\");\n\n// Tree traversal\nconst entries = sm.getEntries();        // All entries (excludes header)\nconst tree = sm.getTree();              // Full tree structure\nconst path = sm.getPath();              // Path from root to current leaf\nconst leaf = sm.getLeafEntry();         // Current leaf entry\nconst entry = sm.getEntry(id);          // Get entry by ID\nconst children = sm.getChildren(id);    // Direct children of entry\n\n// Labels\nconst label = sm.getLabel(id);          // Get label for entry\nsm.appendLabelChange(id, \"checkpoint\"); // Set label\n\n// Branching\nsm.branch(entryId);                     // Move leaf to earlier entry\nsm.branchWithSummary(id, \"Summary...\");  // Branch with context summary\nsm.createBranchedSession(leafId);       // Extract path to new file\n```\n\n> See [examples/sdk/11-sessions.ts](../examples/sdk/11-sessions.ts) and [docs/session.md](session.md)\n\n### Settings Management\n\n```typescript\nimport { createAgentSession, SettingsManager, SessionManager } from \"@mariozechner/pi-coding-agent\";\n\n// Default: loads from files (global + project merged)\nconst { session } = await createAgentSession({\n  settingsManager: SettingsManager.create(),\n});\n\n// With overrides\nconst settingsManager = SettingsManager.create();\nsettingsManager.applyOverrides({\n  compaction: { enabled: false },\n  retry: { enabled: true, maxRetries: 5 },\n});\nconst { session } = await createAgentSession({ settingsManager });\n\n// In-memory (no file I/O, for testing)\nconst { session } = await createAgentSession({\n  settingsManager: SettingsManager.inMemory({ compaction: { enabled: false } }),\n  sessionManager: SessionManager.inMemory(),\n});\n\n// Custom directories\nconst { session } = await createAgentSession({\n  settingsManager: SettingsManager.create(\"/custom/cwd\", \"/custom/agent\"),\n});\n```\n\n**Static factories:**\n- `SettingsManager.create(cwd?, agentDir?)` - Load from files\n- `SettingsManager.inMemory(settings?)` - No file I/O\n\n**Project-specific settings:**\n\nSettings load from two locations and merge:\n1. Global: `~/.pi/agent/settings.json`\n2. Project: `<cwd>/.pi/settings.json`\n\nProject overrides global. Nested objects merge keys. Setters modify global settings by default.\n\n> See [examples/sdk/10-settings.ts](../examples/sdk/10-settings.ts)\n\n## ResourceLoader\n\nUse `DefaultResourceLoader` to discover extensions, skills, prompts, themes, and context files.\n\n```typescript\nimport {\n  DefaultResourceLoader,\n  getAgentDir,\n} from \"@mariozechner/pi-coding-agent\";\n\nconst loader = new DefaultResourceLoader({\n  cwd,\n  agentDir: getAgentDir(),\n});\nawait loader.reload();\n\nconst extensions = loader.getExtensions();\nconst skills = loader.getSkills();\nconst prompts = loader.getPrompts();\nconst themes = loader.getThemes();\nconst contextFiles = loader.getAgentsFiles().agentsFiles;\n```\n\n## Return Value\n\n`createAgentSession()` returns:\n\n```typescript\ninterface CreateAgentSessionResult {\n  // The session\n  session: AgentSession;\n  \n  // Extensions result (for runner setup)\n  extensionsResult: LoadExtensionsResult;\n  \n  // Warning if session model couldn't be restored\n  modelFallbackMessage?: string;\n}\n\ninterface LoadExtensionsResult {\n  extensions: Extension[];\n  errors: Array<{ path: string; error: string }>;\n  runtime: ExtensionRuntime;\n}\n```\n\n[209 more lines in file. Use offset=750 to continue.]"}],"isError":false,"timestamp":1771590244200}}
{"type":"message","id":"717cd61a","parentId":"90cec6a7","timestamp":"2026-02-20T12:24:06.798Z","message":{"role":"assistant","content":[{"type":"toolCall","id":"toolu_01DLPCVKcmSzd4y1ripXi3xD","name":"read","arguments":{"path":"/home/runner/work/gitclaw/gitclaw/.GITCLAW/node_modules/@mariozechner/pi-coding-agent/docs/sdk.md","offset":750}}],"api":"anthropic-messages","provider":"anthropic","model":"claude-opus-4-6","usage":{"input":1,"output":107,"cacheRead":44539,"cacheWrite":1788,"totalTokens":46435,"cost":{"input":0.000005,"output":0.0026750000000000003,"cacheRead":0.022269499999999998,"cacheWrite":0.011175000000000001,"total":0.036124500000000004}},"stopReason":"toolUse","timestamp":1771590244201}}
{"type":"message","id":"61cd8ef2","parentId":"717cd61a","timestamp":"2026-02-20T12:24:06.799Z","message":{"role":"toolResult","toolCallId":"toolu_01DLPCVKcmSzd4y1ripXi3xD","toolName":"read","content":[{"type":"text","text":"\n## Complete Example\n\n```typescript\nimport { getModel } from \"@mariozechner/pi-ai\";\nimport { Type } from \"@sinclair/typebox\";\nimport {\n  AuthStorage,\n  createAgentSession,\n  DefaultResourceLoader,\n  ModelRegistry,\n  SessionManager,\n  SettingsManager,\n  readTool,\n  bashTool,\n  type ToolDefinition,\n} from \"@mariozechner/pi-coding-agent\";\n\n// Set up auth storage (custom location)\nconst authStorage = new AuthStorage(\"/custom/agent/auth.json\");\n\n// Runtime API key override (not persisted)\nif (process.env.MY_KEY) {\n  authStorage.setRuntimeApiKey(\"anthropic\", process.env.MY_KEY);\n}\n\n// Model registry (no custom models.json)\nconst modelRegistry = new ModelRegistry(authStorage);\n\n// Inline tool\nconst statusTool: ToolDefinition = {\n  name: \"status\",\n  label: \"Status\",\n  description: \"Get system status\",\n  parameters: Type.Object({}),\n  execute: async () => ({\n    content: [{ type: \"text\", text: `Uptime: ${process.uptime()}s` }],\n    details: {},\n  }),\n};\n\nconst model = getModel(\"anthropic\", \"claude-opus-4-5\");\nif (!model) throw new Error(\"Model not found\");\n\n// In-memory settings with overrides\nconst settingsManager = SettingsManager.inMemory({\n  compaction: { enabled: false },\n  retry: { enabled: true, maxRetries: 2 },\n});\n\nconst loader = new DefaultResourceLoader({\n  cwd: process.cwd(),\n  agentDir: \"/custom/agent\",\n  settingsManager,\n  systemPromptOverride: () => \"You are a minimal assistant. Be concise.\",\n});\nawait loader.reload();\n\nconst { session } = await createAgentSession({\n  cwd: process.cwd(),\n  agentDir: \"/custom/agent\",\n\n  model,\n  thinkingLevel: \"off\",\n  authStorage,\n  modelRegistry,\n\n  tools: [readTool, bashTool],\n  customTools: [statusTool],\n  resourceLoader: loader,\n\n  sessionManager: SessionManager.inMemory(),\n  settingsManager,\n});\n\nsession.subscribe((event) => {\n  if (event.type === \"message_update\" && event.assistantMessageEvent.type === \"text_delta\") {\n    process.stdout.write(event.assistantMessageEvent.delta);\n  }\n});\n\nawait session.prompt(\"Get status and list files.\");\n```\n\n## Run Modes\n\nThe SDK exports run mode utilities for building custom interfaces on top of `createAgentSession()`:\n\n### InteractiveMode\n\nFull TUI interactive mode with editor, chat history, and all built-in commands:\n\n```typescript\nimport { createAgentSession, InteractiveMode } from \"@mariozechner/pi-coding-agent\";\n\nconst { session } = await createAgentSession({ /* ... */ });\n\nconst mode = new InteractiveMode(session, {\n  // All optional\n  migratedProviders: [],           // Show migration warnings\n  modelFallbackMessage: undefined, // Show model restore warning\n  initialMessage: \"Hello\",         // Send on startup\n  initialImages: [],               // Images with initial message\n  initialMessages: [],             // Additional startup prompts\n});\n\nawait mode.run();  // Blocks until exit\n```\n\n### runPrintMode\n\nSingle-shot mode: send prompts, output result, exit:\n\n```typescript\nimport { createAgentSession, runPrintMode } from \"@mariozechner/pi-coding-agent\";\n\nconst { session } = await createAgentSession({ /* ... */ });\n\nawait runPrintMode(session, {\n  mode: \"text\",              // \"text\" for final response, \"json\" for all events\n  initialMessage: \"Hello\",   // First message (can include @file content)\n  initialImages: [],         // Images with initial message\n  messages: [\"Follow up\"],   // Additional prompts\n});\n```\n\n### runRpcMode\n\nJSON-RPC mode for subprocess integration:\n\n```typescript\nimport { createAgentSession, runRpcMode } from \"@mariozechner/pi-coding-agent\";\n\nconst { session } = await createAgentSession({ /* ... */ });\n\nawait runRpcMode(session);  // Reads JSON commands from stdin, writes to stdout\n```\n\nSee [RPC documentation](rpc.md) for the JSON protocol.\n\n## RPC Mode Alternative\n\nFor subprocess-based integration without building with the SDK, use the CLI directly:\n\n```bash\npi --mode rpc --no-session\n```\n\nSee [RPC documentation](rpc.md) for the JSON protocol.\n\nThe SDK is preferred when:\n- You want type safety\n- You're in the same Node.js process\n- You need direct access to agent state\n- You want to customize tools/extensions programmatically\n\nRPC mode is preferred when:\n- You're integrating from another language\n- You want process isolation\n- You're building a language-agnostic client\n\n## Exports\n\nThe main entry point exports:\n\n```typescript\n// Factory\ncreateAgentSession\n\n// Auth and Models\nAuthStorage\nModelRegistry\n\n// Resource loading\nDefaultResourceLoader\ntype ResourceLoader\ncreateEventBus\n\n// Helpers\n\n// Session management\nSessionManager\nSettingsManager\n\n// Built-in tools (use process.cwd())\ncodingTools\nreadOnlyTools\nreadTool, bashTool, editTool, writeTool\ngrepTool, findTool, lsTool\n\n// Tool factories (for custom cwd)\ncreateCodingTools\ncreateReadOnlyTools\ncreateReadTool, createBashTool, createEditTool, createWriteTool\ncreateGrepTool, createFindTool, createLsTool\n\n// Types\ntype CreateAgentSessionOptions\ntype CreateAgentSessionResult\ntype ExtensionFactory\ntype ExtensionAPI\ntype ToolDefinition\ntype Skill\ntype PromptTemplate\ntype Tool\n```\n\nFor extension types, see [extensions.md](extensions.md) for the full API.\n"}],"isError":false,"timestamp":1771590246799}}
{"type":"message","id":"9d299201","parentId":"61cd8ef2","timestamp":"2026-02-20T12:24:09.282Z","message":{"role":"assistant","content":[{"type":"toolCall","id":"toolu_01KqtEvdDE4iVWv247hs8Rkt","name":"read","arguments":{"path":"/home/runner/work/gitclaw/gitclaw/.GITCLAW/node_modules/@mariozechner/pi-coding-agent/docs/extensions.md","offset":81,"limit":200}}],"api":"anthropic-messages","provider":"anthropic","model":"claude-opus-4-6","usage":{"input":1,"output":124,"cacheRead":46327,"cacheWrite":1579,"totalTokens":48031,"cost":{"input":0.000005,"output":0.0031000000000000003,"cacheRead":0.0231635,"cacheWrite":0.00986875,"total":0.03613725}},"stopReason":"toolUse","timestamp":1771590246799}}
{"type":"message","id":"0047b2a0","parentId":"9d299201","timestamp":"2026-02-20T12:24:09.285Z","message":{"role":"toolResult","toolCallId":"toolu_01KqtEvdDE4iVWv247hs8Rkt","toolName":"read","content":[{"type":"text","text":"    }),\n    async execute(toolCallId, params, signal, onUpdate, ctx) {\n      return {\n        content: [{ type: \"text\", text: `Hello, ${params.name}!` }],\n        details: {},\n      };\n    },\n  });\n\n  // Register a command\n  pi.registerCommand(\"hello\", {\n    description: \"Say hello\",\n    handler: async (args, ctx) => {\n      ctx.ui.notify(`Hello ${args || \"world\"}!`, \"info\");\n    },\n  });\n}\n```\n\nTest with `--extension` (or `-e`) flag:\n\n```bash\npi -e ./my-extension.ts\n```\n\n## Extension Locations\n\n> **Security:** Extensions run with your full system permissions and can execute arbitrary code. Only install from sources you trust.\n\nExtensions are auto-discovered from:\n\n| Location | Scope |\n|----------|-------|\n| `~/.pi/agent/extensions/*.ts` | Global (all projects) |\n| `~/.pi/agent/extensions/*/index.ts` | Global (subdirectory) |\n| `.pi/extensions/*.ts` | Project-local |\n| `.pi/extensions/*/index.ts` | Project-local (subdirectory) |\n\nAdditional paths via `settings.json`:\n\n```json\n{\n  \"packages\": [\n    \"npm:@foo/bar@1.0.0\",\n    \"git:github.com/user/repo@v1\"\n  ],\n  \"extensions\": [\n    \"/path/to/local/extension.ts\",\n    \"/path/to/local/extension/dir\"\n  ]\n}\n```\n\nTo share extensions via npm or git as pi packages, see [packages.md](packages.md).\n\n## Available Imports\n\n| Package | Purpose |\n|---------|---------|\n| `@mariozechner/pi-coding-agent` | Extension types (`ExtensionAPI`, `ExtensionContext`, events) |\n| `@sinclair/typebox` | Schema definitions for tool parameters |\n| `@mariozechner/pi-ai` | AI utilities (`StringEnum` for Google-compatible enums) |\n| `@mariozechner/pi-tui` | TUI components for custom rendering |\n\nnpm dependencies work too. Add a `package.json` next to your extension (or in a parent directory), run `npm install`, and imports from `node_modules/` are resolved automatically.\n\nNode.js built-ins (`node:fs`, `node:path`, etc.) are also available.\n\n## Writing an Extension\n\nAn extension exports a default function that receives `ExtensionAPI`:\n\n```typescript\nimport type { ExtensionAPI } from \"@mariozechner/pi-coding-agent\";\n\nexport default function (pi: ExtensionAPI) {\n  // Subscribe to events\n  pi.on(\"event_name\", async (event, ctx) => {\n    // ctx.ui for user interaction\n    const ok = await ctx.ui.confirm(\"Title\", \"Are you sure?\");\n    ctx.ui.notify(\"Done!\", \"success\");\n    ctx.ui.setStatus(\"my-ext\", \"Processing...\");  // Footer status\n    ctx.ui.setWidget(\"my-ext\", [\"Line 1\", \"Line 2\"]);  // Widget above editor (default)\n  });\n\n  // Register tools, commands, shortcuts, flags\n  pi.registerTool({ ... });\n  pi.registerCommand(\"name\", { ... });\n  pi.registerShortcut(\"ctrl+x\", { ... });\n  pi.registerFlag(\"my-flag\", { ... });\n}\n```\n\nExtensions are loaded via [jiti](https://github.com/unjs/jiti), so TypeScript works without compilation.\n\n### Extension Styles\n\n**Single file** - simplest, for small extensions:\n\n```\n~/.pi/agent/extensions/\nâ””â”€â”€ my-extension.ts\n```\n\n**Directory with index.ts** - for multi-file extensions:\n\n```\n~/.pi/agent/extensions/\nâ””â”€â”€ my-extension/\n    â”œâ”€â”€ index.ts        # Entry point (exports default function)\n    â”œâ”€â”€ tools.ts        # Helper module\n    â””â”€â”€ utils.ts        # Helper module\n```\n\n**Package with dependencies** - for extensions that need npm packages:\n\n```\n~/.pi/agent/extensions/\nâ””â”€â”€ my-extension/\n    â”œâ”€â”€ package.json    # Declares dependencies and entry points\n    â”œâ”€â”€ package-lock.json\n    â”œâ”€â”€ node_modules/   # After npm install\n    â””â”€â”€ src/\n        â””â”€â”€ index.ts\n```\n\n```json\n// package.json\n{\n  \"name\": \"my-extension\",\n  \"dependencies\": {\n    \"zod\": \"^3.0.0\",\n    \"chalk\": \"^5.0.0\"\n  },\n  \"pi\": {\n    \"extensions\": [\"./src/index.ts\"]\n  }\n}\n```\n\nRun `npm install` in the extension directory, then imports from `node_modules/` work automatically.\n\n## Events\n\n### Lifecycle Overview\n\n```\npi starts\n  â”‚\n  â””â”€â–º session_start\n      â”‚\n      â–¼\nuser sends prompt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n  â”‚                                                        â”‚\n  â”œâ”€â–º (extension commands checked first, bypass if found)  â”‚\n  â”œâ”€â–º input (can intercept, transform, or handle)          â”‚\n  â”œâ”€â–º (skill/template expansion if not handled)            â”‚\n  â”œâ”€â–º before_agent_start (can inject message, modify system prompt)\n  â”œâ”€â–º agent_start                                          â”‚\n  â”‚                                                        â”‚\n  â”‚   â”Œâ”€â”€â”€ turn (repeats while LLM calls tools) â”€â”€â”€â”       â”‚\n  â”‚   â”‚                                            â”‚       â”‚\n  â”‚   â”œâ”€â–º turn_start                               â”‚       â”‚\n  â”‚   â”œâ”€â–º context (can modify messages)            â”‚       â”‚\n  â”‚   â”‚                                            â”‚       â”‚\n  â”‚   â”‚   LLM responds, may call tools:            â”‚       â”‚\n  â”‚   â”‚     â”œâ”€â–º tool_call (can block)              â”‚       â”‚\n  â”‚   â”‚     â”‚   tool executes                      â”‚       â”‚\n  â”‚   â”‚     â””â”€â–º tool_result (can modify)           â”‚       â”‚\n  â”‚   â”‚                                            â”‚       â”‚\n  â”‚   â””â”€â–º turn_end                                 â”‚       â”‚\n  â”‚                                                        â”‚\n  â””â”€â–º agent_end                                            â”‚\n                                                           â”‚\nuser sends another prompt â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n\n/new (new session) or /resume (switch session)\n  â”œâ”€â–º session_before_switch (can cancel)\n  â””â”€â–º session_switch\n\n/fork\n  â”œâ”€â–º session_before_fork (can cancel)\n  â””â”€â–º session_fork\n\n/compact or auto-compaction\n  â”œâ”€â–º session_before_compact (can cancel or customize)\n  â””â”€â–º session_compact\n\n/tree navigation\n  â”œâ”€â–º session_before_tree (can cancel or customize)\n  â””â”€â–º session_tree\n\n/model or Ctrl+P (model selection/cycling)\n  â””â”€â–º model_select\n\nexit (Ctrl+C, Ctrl+D)\n  â””â”€â–º session_shutdown\n```\n\n### Session Events\n\n[1548 more lines in file. Use offset=281 to continue.]"}],"isError":false,"timestamp":1771590249284}}
{"type":"message","id":"0c02103e","parentId":"0047b2a0","timestamp":"2026-02-20T12:24:11.753Z","message":{"role":"assistant","content":[{"type":"toolCall","id":"toolu_01ByPpqwzdf4w4TZFrHdrUAq","name":"read","arguments":{"path":"/home/runner/work/gitclaw/gitclaw/.GITCLAW/node_modules/@mariozechner/pi-coding-agent/docs/compaction.md"}}],"api":"anthropic-messages","provider":"anthropic","model":"claude-opus-4-6","usage":{"input":1,"output":91,"cacheRead":47906,"cacheWrite":1879,"totalTokens":49877,"cost":{"input":0.000005,"output":0.002275,"cacheRead":0.023953,"cacheWrite":0.01174375,"total":0.037976750000000004}},"stopReason":"toolUse","timestamp":1771590249285}}
{"type":"message","id":"c3fbf18b","parentId":"0c02103e","timestamp":"2026-02-20T12:24:11.756Z","message":{"role":"toolResult","toolCallId":"toolu_01ByPpqwzdf4w4TZFrHdrUAq","toolName":"read","content":[{"type":"text","text":"# Compaction & Branch Summarization\n\nLLMs have limited context windows. When conversations grow too long, pi uses compaction to summarize older content while preserving recent work. This page covers both auto-compaction and branch summarization.\n\n**Source files** ([pi-mono](https://github.com/badlogic/pi-mono)):\n- [`packages/coding-agent/src/core/compaction/compaction.ts`](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/src/core/compaction/compaction.ts) - Auto-compaction logic\n- [`packages/coding-agent/src/core/compaction/branch-summarization.ts`](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/src/core/compaction/branch-summarization.ts) - Branch summarization\n- [`packages/coding-agent/src/core/compaction/utils.ts`](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/src/core/compaction/utils.ts) - Shared utilities (file tracking, serialization)\n- [`packages/coding-agent/src/core/session-manager.ts`](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/src/core/session-manager.ts) - Entry types (`CompactionEntry`, `BranchSummaryEntry`)\n- [`packages/coding-agent/src/core/extensions/types.ts`](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/src/core/extensions/types.ts) - Extension event types\n\nFor TypeScript definitions in your project, inspect `node_modules/@mariozechner/pi-coding-agent/dist/`.\n\n## Overview\n\nPi has two summarization mechanisms:\n\n| Mechanism | Trigger | Purpose |\n|-----------|---------|---------|\n| Compaction | Context exceeds threshold, or `/compact` | Summarize old messages to free up context |\n| Branch summarization | `/tree` navigation | Preserve context when switching branches |\n\nBoth use the same structured summary format and track file operations cumulatively.\n\n## Compaction\n\n### When It Triggers\n\nAuto-compaction triggers when:\n\n```\ncontextTokens > contextWindow - reserveTokens\n```\n\nBy default, `reserveTokens` is 16384 tokens (configurable in `~/.pi/agent/settings.json` or `<project-dir>/.pi/settings.json`). This leaves room for the LLM's response.\n\nYou can also trigger manually with `/compact [instructions]`, where optional instructions focus the summary.\n\n### How It Works\n\n1. **Find cut point**: Walk backwards from newest message, accumulating token estimates until `keepRecentTokens` (default 20k, configurable in `~/.pi/agent/settings.json` or `<project-dir>/.pi/settings.json`) is reached\n2. **Extract messages**: Collect messages from previous compaction (or start) up to cut point\n3. **Generate summary**: Call LLM to summarize with structured format\n4. **Append entry**: Save `CompactionEntry` with summary and `firstKeptEntryId`\n5. **Reload**: Session reloads, using summary + messages from `firstKeptEntryId` onwards\n\n```\nBefore compaction:\n\n  entry:  0     1     2     3      4     5     6      7      8     9\n        â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”\n        â”‚ hdr â”‚ usr â”‚ ass â”‚ tool â”‚ usr â”‚ ass â”‚ tool â”‚ tool â”‚ ass â”‚ toolâ”‚\n        â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜\n                â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n               messagesToSummarize            kept messages\n                                   â†‘\n                          firstKeptEntryId (entry 4)\n\nAfter compaction (new entry appended):\n\n  entry:  0     1     2     3      4     5     6      7      8     9     10\n        â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”\n        â”‚ hdr â”‚ usr â”‚ ass â”‚ tool â”‚ usr â”‚ ass â”‚ tool â”‚ tool â”‚ ass â”‚ toolâ”‚ cmp â”‚\n        â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜\n               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n                 not sent to LLM                    sent to LLM\n                                                         â†‘\n                                              starts from firstKeptEntryId\n\nWhat the LLM sees:\n\n  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”\n  â”‚ system â”‚ summary â”‚ usr â”‚ ass â”‚ tool â”‚ tool â”‚ ass â”‚ tool â”‚\n  â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜\n       â†‘         â†‘      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n    prompt   from cmp          messages from firstKeptEntryId\n```\n\n### Split Turns\n\nA \"turn\" starts with a user message and includes all assistant responses and tool calls until the next user message. Normally, compaction cuts at turn boundaries.\n\nWhen a single turn exceeds `keepRecentTokens`, the cut point lands mid-turn at an assistant message. This is a \"split turn\":\n\n```\nSplit turn (one huge turn exceeds budget):\n\n  entry:  0     1     2      3     4      5      6     7      8\n        â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”\n        â”‚ hdr â”‚ usr â”‚ ass â”‚ tool â”‚ ass â”‚ tool â”‚ tool â”‚ ass â”‚ tool â”‚\n        â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜\n                â†‘                                     â†‘\n         turnStartIndex = 1                  firstKeptEntryId = 7\n                â”‚                                     â”‚\n                â””â”€â”€â”€â”€ turnPrefixMessages (1-6) â”€â”€â”€â”€â”€â”€â”€â”˜\n                                                      â””â”€â”€ kept (7-8)\n\n  isSplitTurn = true\n  messagesToSummarize = []  (no complete turns before)\n  turnPrefixMessages = [usr, ass, tool, ass, tool, tool]\n```\n\nFor split turns, pi generates two summaries and merges them:\n1. **History summary**: Previous context (if any)\n2. **Turn prefix summary**: The early part of the split turn\n\n### Cut Point Rules\n\nValid cut points are:\n- User messages\n- Assistant messages\n- BashExecution messages\n- Custom messages (custom_message, branch_summary)\n\nNever cut at tool results (they must stay with their tool call).\n\n### CompactionEntry Structure\n\nDefined in [`session-manager.ts`](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/src/core/session-manager.ts):\n\n```typescript\ninterface CompactionEntry<T = unknown> {\n  type: \"compaction\";\n  id: string;\n  parentId: string;\n  timestamp: number;\n  summary: string;\n  firstKeptEntryId: string;\n  tokensBefore: number;\n  fromHook?: boolean;  // true if provided by extension (legacy field name)\n  details?: T;         // implementation-specific data\n}\n\n// Default compaction uses this for details (from compaction.ts):\ninterface CompactionDetails {\n  readFiles: string[];\n  modifiedFiles: string[];\n}\n```\n\nExtensions can store any JSON-serializable data in `details`. The default compaction tracks file operations, but custom extension implementations can use their own structure.\n\nSee [`prepareCompaction()`](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/src/core/compaction/compaction.ts) and [`compact()`](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/src/core/compaction/compaction.ts) for the implementation.\n\n## Branch Summarization\n\n### When It Triggers\n\nWhen you use `/tree` to navigate to a different branch, pi offers to summarize the work you're leaving. This injects context from the left branch into the new branch.\n\n### How It Works\n\n1. **Find common ancestor**: Deepest node shared by old and new positions\n2. **Collect entries**: Walk from old leaf back to common ancestor\n3. **Prepare with budget**: Include messages up to token budget (newest first)\n4. **Generate summary**: Call LLM with structured format\n5. **Append entry**: Save `BranchSummaryEntry` at navigation point\n\n```\nTree before navigation:\n\n         â”Œâ”€ B â”€ C â”€ D (old leaf, being abandoned)\n    A â”€â”€â”€â”¤\n         â””â”€ E â”€ F (target)\n\nCommon ancestor: A\nEntries to summarize: B, C, D\n\nAfter navigation with summary:\n\n         â”Œâ”€ B â”€ C â”€ D â”€ [summary of B,C,D]\n    A â”€â”€â”€â”¤\n         â””â”€ E â”€ F (new leaf)\n```\n\n### Cumulative File Tracking\n\nBoth compaction and branch summarization track files cumulatively. When generating a summary, pi extracts file operations from:\n- Tool calls in the messages being summarized\n- Previous compaction or branch summary `details` (if any)\n\nThis means file tracking accumulates across multiple compactions or nested branch summaries, preserving the full history of read and modified files.\n\n### BranchSummaryEntry Structure\n\nDefined in [`session-manager.ts`](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/src/core/session-manager.ts):\n\n```typescript\ninterface BranchSummaryEntry<T = unknown> {\n  type: \"branch_summary\";\n  id: string;\n  parentId: string;\n  timestamp: number;\n  summary: string;\n  fromId: string;      // Entry we navigated from\n  fromHook?: boolean;  // true if provided by extension (legacy field name)\n  details?: T;         // implementation-specific data\n}\n\n// Default branch summarization uses this for details (from branch-summarization.ts):\ninterface BranchSummaryDetails {\n  readFiles: string[];\n  modifiedFiles: string[];\n}\n```\n\nSame as compaction, extensions can store custom data in `details`.\n\nSee [`collectEntriesForBranchSummary()`](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/src/core/compaction/branch-summarization.ts), [`prepareBranchEntries()`](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/src/core/compaction/branch-summarization.ts), and [`generateBranchSummary()`](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/src/core/compaction/branch-summarization.ts) for the implementation.\n\n## Summary Format\n\nBoth compaction and branch summarization use the same structured format:\n\n```markdown\n## Goal\n[What the user is trying to accomplish]\n\n## Constraints & Preferences\n- [Requirements mentioned by user]\n\n## Progress\n### Done\n- [x] [Completed tasks]\n\n### In Progress\n- [ ] [Current work]\n\n### Blocked\n- [Issues, if any]\n\n## Key Decisions\n- **[Decision]**: [Rationale]\n\n## Next Steps\n1. [What should happen next]\n\n## Critical Context\n- [Data needed to continue]\n\n<read-files>\npath/to/file1.ts\npath/to/file2.ts\n</read-files>\n\n<modified-files>\npath/to/changed.ts\n</modified-files>\n```\n\n### Message Serialization\n\nBefore summarization, messages are serialized to text via [`serializeConversation()`](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/src/core/compaction/utils.ts):\n\n```\n[User]: What they said\n[Assistant thinking]: Internal reasoning\n[Assistant]: Response text\n[Assistant tool calls]: read(path=\"foo.ts\"); edit(path=\"bar.ts\", ...)\n[Tool result]: Output from tool\n```\n\nThis prevents the model from treating it as a conversation to continue.\n\n## Custom Summarization via Extensions\n\nExtensions can intercept and customize both compaction and branch summarization. See [`extensions/types.ts`](https://github.com/badlogic/pi-mono/blob/main/packages/coding-agent/src/core/extensions/types.ts) for event type definitions.\n\n### session_before_compact\n\nFired before auto-compaction or `/compact`. Can cancel or provide custom summary. See `SessionBeforeCompactEvent` and `CompactionPreparation` in the types file.\n\n```typescript\npi.on(\"session_before_compact\", async (event, ctx) => {\n  const { preparation, branchEntries, customInstructions, signal } = event;\n\n  // preparation.messagesToSummarize - messages to summarize\n  // preparation.turnPrefixMessages - split turn prefix (if isSplitTurn)\n  // preparation.previousSummary - previous compaction summary\n  // preparation.fileOps - extracted file operations\n  // preparation.tokensBefore - context tokens before compaction\n  // preparation.firstKeptEntryId - where kept messages start\n  // preparation.settings - compaction settings\n\n  // branchEntries - all entries on current branch (for custom state)\n  // signal - AbortSignal (pass to LLM calls)\n\n  // Cancel:\n  return { cancel: true };\n\n  // Custom summary:\n  return {\n    compaction: {\n      summary: \"Your summary...\",\n      firstKeptEntryId: preparation.firstKeptEntryId,\n      tokensBefore: preparation.tokensBefore,\n      details: { /* custom data */ },\n    }\n  };\n});\n```\n\n#### Converting Messages to Text\n\nTo generate a summary with your own model, convert messages to text using `serializeConversation`:\n\n```typescript\nimport { convertToLlm, serializeConversation } from \"@mariozechner/pi-coding-agent\";\n\npi.on(\"session_before_compact\", async (event, ctx) => {\n  const { preparation } = event;\n  \n  // Convert AgentMessage[] to Message[], then serialize to text\n  const conversationText = serializeConversation(\n    convertToLlm(preparation.messagesToSummarize)\n  );\n  // Returns:\n  // [User]: message text\n  // [Assistant thinking]: thinking content\n  // [Assistant]: response text\n  // [Assistant tool calls]: read(path=\"...\"); bash(command=\"...\")\n  // [Tool result]: output text\n\n  // Now send to your model for summarization\n  const summary = await myModel.summarize(conversationText);\n  \n  return {\n    compaction: {\n      summary,\n      firstKeptEntryId: preparation.firstKeptEntryId,\n      tokensBefore: preparation.tokensBefore,\n    }\n  };\n});\n```\n\nSee [custom-compaction.ts](../examples/extensions/custom-compaction.ts) for a complete example using a different model.\n\n### session_before_tree\n\nFired before `/tree` navigation. Always fires regardless of whether user chose to summarize. Can cancel navigation or provide custom summary.\n\n```typescript\npi.on(\"session_before_tree\", async (event, ctx) => {\n  const { preparation, signal } = event;\n\n  // preparation.targetId - where we're navigating to\n  // preparation.oldLeafId - current position (being abandoned)\n  // preparation.commonAncestorId - shared ancestor\n  // preparation.entriesToSummarize - entries that would be summarized\n  // preparation.userWantsSummary - whether user chose to summarize\n\n  // Cancel navigation entirely:\n  return { cancel: true };\n\n  // Provide custom summary (only used if userWantsSummary is true):\n  if (preparation.userWantsSummary) {\n    return {\n      summary: {\n        summary: \"Your summary...\",\n        details: { /* custom data */ },\n      }\n    };\n  }\n});\n```\n\nSee `SessionBeforeTreeEvent` and `TreePreparation` in the types file.\n\n## Settings\n\nConfigure compaction in `~/.pi/agent/settings.json` or `<project-dir>/.pi/settings.json`:\n\n```json\n{\n  \"compaction\": {\n    \"enabled\": true,\n    \"reserveTokens\": 16384,\n    \"keepRecentTokens\": 20000\n  }\n}\n```\n\n| Setting | Default | Description |\n|---------|---------|-------------|\n| `enabled` | `true` | Enable auto-compaction |\n| `reserveTokens` | `16384` | Tokens to reserve for LLM response |\n| `keepRecentTokens` | `20000` | Recent tokens to keep (not summarized) |\n\nDisable auto-compaction with `\"enabled\": false`. You can still compact manually with `/compact`.\n"}],"isError":false,"timestamp":1771590251755}}
{"type":"message","id":"ed0ec5db","parentId":"c3fbf18b","timestamp":"2026-02-20T12:24:39.967Z","message":{"role":"assistant","content":[{"type":"text","text":"Now I have a comprehensive picture. Here's the answer:\n\n## Pi's Mechanisms for Controlling Runaway Processing and Costs\n\nPi has **several built-in safeguards**, but it's worth noting it takes a **philosophy of restraint over restriction** â€” it gives you the building blocks rather than opinionated hard limits. Here's what exists:\n\n### Built-In Mechanisms\n\n1. **Abort / Cancel (Escape key)** â€” In interactive mode, pressing Escape immediately aborts the current operation. The SDK exposes `session.abort()` for programmatic cancellation.\n\n2. **Auto-Compaction** â€” Prevents context window exhaustion (and the ballooning token costs that come with it). When context approaches the limit, pi automatically summarizes older messages while keeping recent ones. Configurable via:\n   - `compaction.enabled` (default: `true`)\n   - `compaction.reserveTokens` (default: 16,384 tokens)\n   - `compaction.keepRecentTokens` (default: 20,000 tokens)\n\n3. **Thinking Budget Controls** â€” `thinkingBudgets` in settings lets you cap token budgets per thinking level (e.g., `minimal: 1024`, `low: 4096`, `medium: 10240`, `high: 32768`). This directly limits how much the model \"thinks\" per turn.\n\n4. **Retry Limits** â€” Prevents infinite retry loops on API errors:\n   - `retry.maxRetries` (default: 3)\n   - `retry.maxDelayMs` (default: 60,000ms) â€” if a provider says \"retry after 5 hours,\" pi **fails immediately** instead of waiting silently\n\n5. **Steering Messages** â€” You can interrupt the agent mid-execution by sending a steering message (Enter while it's working). This delivers after the current tool call and **skips remaining queued tools**, letting you redirect without waiting.\n\n6. **Tool Restriction** â€” `--tools read,grep,find,ls` makes the agent read-only. No writes, no bash. This is a hard capability limit, not just a suggestion.\n\n7. **Real-Time Cost Display** â€” The footer shows total token usage, cache usage, and cost in real-time. You can see exactly how much a session is costing.\n\n### What Pi Does NOT Have Built-In\n\nPi **deliberately omits** these, expecting you to build them via extensions if needed:\n\n- âŒ **No hard cost/budget cap** â€” There's no `maxCostPerSession: $5.00` setting\n- âŒ **No max turns/iterations limit** â€” No built-in \"stop after N tool calls\"\n- âŒ **No permission popups** â€” No \"allow this bash command?\" gates by default\n- âŒ **No time-based timeout** â€” No \"kill after 10 minutes\"\n\n### What You Can Build with Extensions\n\nPi's extension system makes all of the above trivially implementable:\n\n```typescript\n// Example: Block dangerous commands\npi.on(\"tool_call\", async (event, ctx) => {\n  if (event.toolName === \"bash\" && event.input.command?.includes(\"rm -rf\")) {\n    const ok = await ctx.ui.confirm(\"Dangerous!\", \"Allow rm -rf?\");\n    if (!ok) return { block: true, reason: \"Blocked by user\" };\n  }\n});\n```\n\nYou could similarly track cumulative cost across `turn_end` events and abort when a threshold is hit, or count tool calls and stop after N iterations.\n\n### For GitClaw Specifically\n\nIn the GitClaw context (headless in GitHub Actions), the main cost controls are:\n- **GitHub Actions timeout** â€” workflows have a default 6-hour timeout, configurable per job\n- **Tool restriction** via `--tools` flag in the workflow\n- **Thinking level** set in `.pi/settings.json` (lower = cheaper)\n- **Model choice** â€” switching from Claude Opus to Sonnet or Flash drastically changes cost\n- **Compaction** â€” keeps long-running issue conversations from blowing up context\n\n**Bottom line:** Pi gives you visibility (real-time cost display), automatic context management (compaction), retry sanity (fail-fast on absurd delays), and the ability to interrupt or restrict â€” but trusts you to set your own hard limits, either via extensions or external controls like Actions timeouts and API provider spending caps."}],"api":"anthropic-messages","provider":"anthropic","model":"claude-opus-4-6","usage":{"input":1,"output":1021,"cacheRead":49785,"cacheWrite":4431,"totalTokens":55238,"cost":{"input":0.000005,"output":0.025525000000000003,"cacheRead":0.024892499999999998,"cacheWrite":0.02769375,"total":0.07811625}},"stopReason":"stop","timestamp":1771590251756}}
